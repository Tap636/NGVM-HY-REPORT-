<script>
/* =================== GOOGLE SHEETS API URL (CRITICAL) ===================
   After you deploy Apps Script as Web App, paste the Web App URL below.
   ================================================================*/
const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycby_e3RSLl4gzumcLerbD3ICwKoeZsQEXeaaZGtLajj_57KCHRSlD1fdIBH1eYoU6wABfQ/exec'; // ⭐ PASTE YOUR LINK HERE!
/* -----------------------------------------------------------------------*/

/* ---------------- CONFIG & SUBJECTS (UNCHANGED) ---------------- */
const SUBJECTS_NUR_TO_UKG = [
{ name: "English", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
{ name: "Hindi", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
{ name: "Maths", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
// Drawing: special maxima
{ name: "Drawing", utMax: 20, utOralMax: 0, hyMax: 80, hyOralMax: 0 }
];
const SUBJECTS_1_TO_5 = ["Hindi", "English", "Mathematics", "Computer", "E.V.S.", "Drawing", "G.K."];
const SUBJECTS_6_TO_8 = ["Hindi", "English", "Mathematics", "Computer", "Drawing", "G.K.", "Science", "S.S.T."];
const SUBJECTS_9 = ["Hindi", "English", "Mathematics", "Science", "S.S.T.", "Drawing"];
const DEFAULT_ATT_TOTAL = 130;
/* ---------------- STATE (UNCHANGED) ---------------- */
let state = {
selectedClass: '',
selectedStudentKey: '',
studentsByClass: {},
chart: null
};
/* ---------------- UTIL (UNCHANGED) ---------------- */
const qs = id => document.getElementById(id);
/* ---------------- INIT (UNCHANGED) ---------------- */
function init() {
const stored = localStorage.getItem('ng_students');
state.studentsByClass = stored ? JSON.parse(stored) : {};
attachEventListeners();
initChart();
updatePrintDate();
renderMarksTableForClass(''); // initial empty
}
init();
/* ---------------- MAP & HELPERS (UNCHANGED) ---------------- */
function interpretClassValue(val) {
if (!val) return '';
const romanMap = { "I":"1","II":"2","III":"3","IV":"4","V":"5","VI":"6","VII":"7","VIII":"8","IX":"9" };
if (romanMap[val]) return romanMap[val];
return val;
}
function displayClassLabel(cls) {
if (!cls) return '—';
if (cls === 'Nursery' || cls === 'LKG' || cls === 'UKG') return cls;
const map = {1:'I',2:'II',3:'III',4:'IV',5:'V',6:'VI',7:'VII',8:'VIII',9:'IX'};
return map[Number(cls)] || cls;
}
/* ---------------- EVENT LISTENERS (ADDED SHEET BUTTONS) ---------------- */
function attachEventListeners() {
qs('classSelect').addEventListener('change', e => {
const val = interpretClassValue(e.target.value);
state.selectedClass = val;
qs('classSection').textContent = displayClassLabel(val);
clearStudentView();
renderMarksTableForClass(val);
});
qs('addStudentBtn').addEventListener('click', () => {
if (!state.selectedClass) return alert('Select Class first.');
const admission = qs('admissionInput').value.trim();
if (!admission) return alert('Enter Admission Number.');
const name = qs('studentNameInput').value.trim();
if (!name) return alert('Enter Student Name.');
const fatherName = qs('fatherNameInput').value.trim();
const key = `${state.selectedClass}|${admission}`;
state.studentsByClass[state.selectedClass] = state.studentsByClass[state.selectedClass] || {};
const student = makeEmptyStudent(name, admission, state.selectedClass, fatherName);
if (state.studentsByClass[state.selectedClass][key]) {
const ex = state.studentsByClass[state.selectedClass][key];
student.marks = ex.marks || student.marks;
student.attendance = ex.attendance || ex.attendance;
student.coscholastic = ex.coscholastic || student.coscholastic;
student.teachersRemark = ex.teachersRemark || student.teachersRemark;
student.fatherName = fatherName || ex.fatherName || student.fatherName;
}
state.studentsByClass[state.selectedClass][key] = student;
persistStudents();
state.selectedStudentKey = key;
loadStudent(key);
alert('Student added/updated locally. Remember to click "Save to Sheet" to update Google Sheets.');
});
// Event listener for Load from Sheet
qs('loadSheetBtn').addEventListener('click', () => {
if (!state.selectedClass) return alert('Select Class first.');
const admission = qs('admissionInput').value.trim();
if (!admission) return alert('Enter Admission Number.');
loadFromSheet(admission, state.selectedClass);
});
// Event listener for Save to Sheet (updated to saveToSheet)
qs('saveBtn').addEventListener('click', () => {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
saveCurrentStudent(); // First save to local state and calculate totals
saveToSheet(); // Then send to Google Sheets
});
qs('printBtn').addEventListener('click', () => {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
calculateTotalsAndUpdate();
window.print();
});
qs('dashboardClassSelect').addEventListener('change', showDashboardTopper);
qs('bulkDownloadBtn').addEventListener('click', bulkDownloadReports);
qs('clearDataBtn').addEventListener('click', clearAllData);
}
/* ---------------- SHEET FUNCTIONS (RE-ADDED) ---------------- */
async function saveToSheet() {
  if (SHEET_API_URL === 'PASTE_YOUR_APPSCRIPT_URL_HERE') {
    return alert('CRITICAL ERROR: Please paste your Apps Script Web App URL into the SHEET_API_URL constant.');
  }

  const student = getCurrentStudent();
  if (!student) return alert('No student loaded to save.');

  // The student object already contains all the latest, calculated data (after saveCurrentStudent runs)
  
  try {
    const url = new URL(SHEET_API_URL);
    url.searchParams.append('action', 'save');
    url.searchParams.append('data', JSON.stringify(student));
    
    // Use POST method for saving
    const res = await fetch(url, { method: 'POST' });
    const data = await res.json();
    
    if (data.status === 'ok') {
      alert(`Successfully saved ${student.name} to Google Sheets!`);
    } else {
      alert(`Error saving to Google Sheets: ${data.message || 'Unknown error.'}`);
    }
  } catch (err) {
    console.error('saveToSheet error', err);
    alert('Error connecting to Google Sheets. Check the console and your Apps Script logs.');
  }
}

async function loadFromSheet(admissionNo, cls) {
  if (SHEET_API_URL === 'PASTE_YOUR_APPSCRIPT_URL_HERE') {
    return alert('CRITICAL ERROR: Please paste your Apps Script Web App URL into the SHEET_API_URL constant.');
  }

  try {
    const url = new URL(SHEET_API_URL);
    url.searchParams.append('action', 'load');
    url.searchParams.append('admission', admissionNo);
    url.searchParams.append('cls', cls);

    const res = await fetch(url.toString(), { method: 'GET' });
    const data = await res.json();
    
    if (data.status === 'ok' && data.student) {
      const s = data.student;
      // Save into local state and localStorage (backup)
      const key = `${s.cls}|${s.admission}`;
      state.studentsByClass[s.cls] = state.studentsByClass[s.cls] || {};
      state.studentsByClass[s.cls][key] = s;
      persistStudents();
      state.selectedStudentKey = key;
      loadStudent(key);
      alert('Loaded student from Google Sheets and saved a local backup.');
    } else {
      alert('Student not found in Google Sheets. You may add locally and then Save to push to cloud.');
    }
  } catch (err) {
    console.error('loadFromSheet error', err);
    alert('Error loading from Google Sheets. Check console and network. You can still use localStorage.');
  }
}

/* ---------------- PERSISTENCE (UNCHANGED) ---------------- */
function persistStudents() {
localStorage.setItem('ng_students', JSON.stringify(state.studentsByClass));
}
/* ---------------- STUDENT FACTORY (UNCHANGED) ---------------- */
// Added fatherName as an argument
function makeEmptyStudent(name, admission, cls, fatherName='') {
const marks = [];
if (isNurToUkg(cls)) {
SUBJECTS_NUR_TO_UKG.forEach(s => {
marks.push({
name: s.name,
ut: 0,
utOral: s.utOralMax || 0,
hy: 0,
hyOral: s.hyOralMax || 0,
total: 0,
max: { ut: s.utMax, utOral: s.utOralMax, hy: s.hyMax, hyOral: s.hyOralMax }
});
});
} else {
const subs = subjectsForClass(cls);
subs.forEach(s => {
if (s === 'G.K.') {
marks.push({ name: s, grade: 'A', isGrade: true });
} else {
marks.push({ name: s, ut: 0, hy: 0, total: 0, isGrade: false, max: { ut: 20, hy: 80 } });
}
});
}
return {
name, admission, cls, fatherName, marks, // Added fatherName
coscholastic: {},
attendance: { present: 0, total: DEFAULT_ATT_TOTAL },
teachersRemark: 'Good effort. Keep improving.',
remark: ''
};
}
function isNurToUkg(cls) {
return cls === 'Nursery' || cls === 'LKG' || cls === 'UKG';
}
function subjectsForClass(cls) {
const n = Number(cls);
if (n >=1 && n <=5) return SUBJECTS_1_TO_5.slice();
if (n >=6 && n <=8) return SUBJECTS_6_TO_8.slice();
if (n === 9) return SUBJECTS_9.slice();
return [];
}
/* ---------------- RENDER MARKS TABLE PER CLASS (UNCHANGED) ---------------- */
function renderMarksTableForClass(cls) {
const thead = qs('marksTableHead');
const tbody = qs('marksTableBody');
const tfoot = qs('marksTableFoot');
tbody.innerHTML = '';
tfoot.innerHTML = '';
if (!cls) {
thead.innerHTML = `<tr class="bg-green-100"><th class="border px-3 py-2 text-left">Subject</th><th class="border px-3 py-2 text-center">Unit Test</th><th class="border px-3 py-2 text-center">Half Yearly</th><th class="border px-3 py-2 text-center">Overall Performance</th></tr>`;
return;
}
if (isNurToUkg(cls)) {
thead.innerHTML = `
<tr class="bg-green-100">
<th class="border px-3 py-2 text-left">Subject</th>
<th class="border px-3 py-2 text-center">Unit Test Written</th>
<th class="border px-3 py-2 text-center">Unit Test Oral</th>
<th class="border px-3 py-2 text-center">Half Yearly Written</th>
<th class="border px-3 py-2 text-center">Half Yearly Oral</th>
<th class="border px-3 py-2 text-center font-semibold">Overall Performance</th>
</tr>
`;
const student = getCurrentStudent();
const rows = student ? student.marks : SUBJECTS_NUR_TO_UKG.map(s => ({ name: s.name }));
rows.forEach((m, idx) => {
const max = (m.max || SUBJECTS_NUR_TO_UKG[idx]); // For drawing: utOral/hyOral disabled
const utMax = max.ut;
const utOralMax = max.utOral;
const hyMax = max.hy;
const hyOralMax = max.hyOral;
const utVal = (student && student.marks[idx]) ? (student.marks[idx].ut || 0) : 0;
const utOralVal = (student && student.marks[idx]) ? (student.marks[idx].utOral || 0) : 0;
const hyVal = (student && student.marks[idx]) ? (student.marks[idx].hy || 0) : 0;
const hyOralVal = (student && student.marks[idx]) ? (student.marks[idx].hyOral || 0) : 0;
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${m.name}</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="ut" type="number" min="0" max="${utMax}" value="${utVal}" class="w-16 p-1 border rounded" />
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="utOral" type="number" min="0" max="${utOralMax}" value="${utOralVal}" class="w-16 p-1 border rounded" ${utOralMax===0?'disabled':''} />
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="hy" type="number" min="0" max="${hyMax}" value="${hyVal}" class="w-16 p-1 border rounded" />
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="hyOral" type="number" min="0" max="${hyOralMax}" value="${hyOralVal}" class="w-16 p-1 border rounded" ${hyOralMax===0?'disabled':''} />
</td>
<td class="border px-3 py-2 font-semibold text-center">${student ? (student.marks[idx].total || 0) : 0}</td>
</tr>
`);
});
tfoot.innerHTML = `
<tr class="bg-gray-50">
<td class="border px-3 py-2 font-semibold text-right">Total</td>
<td id="totalUT" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalUTOral" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalHY" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalHYOral" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalOverall" class="border px-3 py-2 font-semibold text-center">0</td>
</tr>
`;
} else {
// Class 1-9 structure
thead.innerHTML = `
<tr class="bg-green-100">
<th class="border px-3 py-2 text-left">Subject</th>
<th class="border px-3 py-2 text-center">Unit Test (Max: 20)</th>
<th class="border px-3 py-2 text-center">Half Yearly (Max: 80)</th>
<th class="border px-3 py-2 text-center font-semibold">Overall Performance (Max: 100)</th>
</tr>
`;
const student = getCurrentStudent();
const subs = subjectsForClass(cls);
subs.forEach((sName, idx) => {
const m = (student && student.marks[idx]) || {};
const utVal = m.ut || 0;
const hyVal = m.hy || 0;
const totalVal = m.total || 0;
if (sName === 'G.K.' || sName === 'Drawing' && Number(cls) >= 6 && Number(cls) <= 8) {
// Grade-based subjects (G.K. for all, Drawing for 6-8)
const gradeVal = m.grade || 'A';
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${sName}</td>
<td colspan="2" class="border px-3 py-2 text-center">
<select data-idx="${idx}" data-field="grade" class="grade-select border p-1 rounded">
<option value="A" ${gradeVal==='A'?'selected':''}>A</option>
<option value="B" ${gradeVal==='B'?'selected':''}>B</option>
<option value="C" ${gradeVal==='C'?'selected':''}>C</option>
</select>
</td>
<td class="border px-3 py-2 font-semibold text-center">${gradeVal} (Grade)</td>
</tr>
`);
} else {
// Mark-based subjects
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${sName}</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="ut" type="number" min="0" max="20" value="${utVal}" class="w-16 p-1 border rounded" />
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="hy" type="number" min="0" max="80" value="${hyVal}" class="w-16 p-1 border rounded" />
</td>
<td class="border px-3 py-2 font-semibold text-center">${totalVal}</td>
</tr>
`);
}
});
tfoot.innerHTML = `
<tr class="bg-gray-50">
<td class="border px-3 py-2 font-semibold text-right">Total Marks:</td>
<td colspan="2" id="totalCombined" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalOverall" class="border px-3 py-2 font-semibold text-center">0</td>
</tr>
`;
}
attachMarksInputsListeners();
calculateTotalsAndUpdate();
}

function attachMarksInputsListeners() {
const tbody = qs('marksTableBody');
tbody.querySelectorAll('input[type="number"], select.grade-select').forEach(input => {
if (input.type === 'number') {
input.addEventListener('input', autoClampInput);
}
input.addEventListener('change', calculateTotalsAndUpdate);
});
}
function autoClampInput(e) {
const input = e.target;
let value = parseInt(input.value);
const min = parseInt(input.min);
const max = parseInt(input.max);
if (isNaN(value)) {
value = min;
}
if (value < min) value = min;
if (value > max) value = max;
input.value = value;
}

/* ---------------- LOAD/SAVE TO LOCAL (UNCHANGED) ---------------- */
function loadStudent(key) {
const parts = key.split('|');
const cls = parts[0];
const admission = parts[1];
const student = state.studentsByClass[cls][key];
if (!student) return clearStudentView();

qs('admissionNo').textContent = student.admission;
qs('studentName').textContent = student.name;
qs('fatherName').textContent = student.fatherName || '—'; 
qs('classSection').textContent = displayClassLabel(student.cls);

// Set inputs (used for loading and saving the current student)
qs('admissionInput').value = student.admission;
qs('studentNameInput').value = student.name;
qs('fatherNameInput').value = student.fatherName || ''; 
qs('classSelect').value = displayClassLabel(student.cls); 
state.selectedClass = student.cls; 

// Render marks table first
renderMarksTableForClass(student.cls);

// Load marks into the rendered table (re-fetching elements)
const marksTableBody = qs('marksTableBody');
student.marks.forEach((m, idx) => {
if (m.isGrade) {
const gradeSelect = marksTableBody.querySelector(`select[data-idx="${idx}"][data-field="grade"]`);
if (gradeSelect) gradeSelect.value = m.grade || 'A';
} else {
const utInput = marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="ut"]`);
const hyInput = marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="hy"]`);
if (utInput) utInput.value = m.ut || 0;
if (hyInput) hyInput.value = m.hy || 0;
if (isNurToUkg(student.cls)) {
const utOralInput = marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="utOral"]`);
const hyOralInput = marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="hyOral"]`);
if (utOralInput) utOralInput.value = m.utOral || 0;
if (hyOralInput) hyOralInput.value = m.hyOral || 0;
}
}
});

// Load coscholastic
if (student.coscholastic) {
qs('workHabitsInput').value = student.coscholastic.workHabits || '';
qs('behaviorInput').value = student.coscholastic.behavior || '';
}

// Load attendance (for both screen and print elements)
document.querySelectorAll('#attendancePresent').forEach(el => el.value = student.attendance.present || 0);
document.querySelectorAll('#attendanceTotal').forEach(el => el.value = student.attendance.total || DEFAULT_ATT_TOTAL);

// Load teacher's remark
qs('teachersRemark').textContent = student.teachersRemark || 'Good effort. Keep improving.';

calculateTotalsAndUpdate();
}

function saveCurrentStudent() {
const key = state.selectedStudentKey;
if (!key || !state.studentsByClass[state.selectedClass][key]) return;

const student = state.studentsByClass[state.selectedClass][key];
const marksTableBody = qs('marksTableBody');

// Update marks from inputs
student.marks.forEach((m, idx) => {
if (m.isGrade) {
const gradeSelect = marksTableBody.querySelector(`select[data-idx="${idx}"][data-field="grade"]`);
if (gradeSelect) m.grade = gradeSelect.value;
} else {
const utInput = marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="ut"]`);
const hyInput = marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="hy"]`);
if (utInput) m.ut = Number(utInput.value);
if (hyInput) m.hy = Number(hyInput.value);
if (isNurToUkg(student.cls)) {
const utOralInput = marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="utOral"]`);
const hyOralInput = marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="hyOral"]`);
if (utOralInput) m.utOral = Number(utOralInput.value);
if (hyOralInput) m.hyOral = Number(hyOralInput.value);
}
}
});

// Update totals and store in student object
calculateTotalsAndUpdate(); 
student.marks.forEach((m, idx) => {
const totalCell = marksTableBody.parentElement.querySelector(`tbody tr:nth-child(${idx + 1}) td:last-child`);
if (totalCell && !m.isGrade) {
m.total = Number(totalCell.textContent);
}
});
// Re-calculate the grand total for the whole card
const totalOverallEl = qs('totalOverall');
if (totalOverallEl) student.overallTotal = Number(totalOverallEl.textContent) || 0;
if (!isNurToUkg(student.cls)) {
const totalCombinedEl = qs('totalCombined');
if (totalCombinedEl) student.overallCombined = Number(totalCombinedEl.textContent) || 0;
}


// Update coscholastic
student.coscholastic = {
workHabits: qs('workHabitsInput').value.trim().toUpperCase() || '',
behavior: qs('behaviorInput').value.trim().toUpperCase() || ''
};

// Update attendance (read from the screen-only input, which is where the user edits)
const attendancePresentScreen = document.querySelector('.screen-only #attendancePresent');
const attendanceTotalScreen = document.querySelector('.screen-only #attendanceTotal');
student.attendance = {
present: Number(attendancePresentScreen.value),
total: Number(attendanceTotalScreen.value)
};
// Update print-only attendance to reflect saved value
document.querySelectorAll('.print-only #attendancePresent').forEach(el => el.value = student.attendance.present);
document.querySelectorAll('.print-only #attendanceTotal').forEach(el => el.value = student.attendance.total);


// Update teacher's remark
student.teachersRemark = qs('teachersRemark').textContent.trim() || 'Good effort. Keep improving.';

persistStudents();
}

function getCurrentStudent() {
if (!state.selectedStudentKey) return null;
const cls = state.selectedStudentKey.split('|')[0];
return state.studentsByClass[cls] ? state.studentsByClass[cls][state.selectedStudentKey] : null;
}

/* ---------------- TOTALS & CALCULATIONS (UNCHANGED) ---------------- */
function calculateTotalsAndUpdate() {
const student = getCurrentStudent();
if (!student) return;

const marksTableBody = qs('marksTableBody');
let grandOverallTotal = 0;
let grandCombinedTotal = 0;

if (isNurToUkg(student.cls)) {
let totalUT = 0;
let totalUTOral = 0;
let totalHY = 0;
let totalHYOral = 0;
let totalMax = 0;

student.marks.forEach((m, idx) => {
const ut = Number(marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="ut"]`).value) || 0;
const utOral = Number(marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="utOral"]`).value) || 0;
const hy = Number(marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="hy"]`).value) || 0;
const hyOral = Number(marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="hyOral"]`).value) || 0;

const subjectTotal = ut + utOral + hy + hyOral;
const totalCell = marksTableBody.querySelector(`tr:nth-child(${idx + 1}) td:last-child`);
if (totalCell) totalCell.textContent = subjectTotal;

// Update student object directly
m.ut = ut;
m.utOral = utOral;
m.hy = hy;
m.hyOral = hyOral;
m.total = subjectTotal;

totalUT += ut;
totalUTOral += utOral;
totalHY += hy;
totalHYOral += hyOral;
grandOverallTotal += subjectTotal;
});

qs('totalUT').textContent = totalUT;
qs('totalUTOral').textContent = totalUTOral;
qs('totalHY').textContent = totalHY;
qs('totalHYOral').textContent = totalHYOral;
} else {
// Class 1-9
student.marks.forEach((m, idx) => {
if (!m.isGrade) {
const ut = Number(marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="ut"]`).value) || 0;
const hy = Number(marksTableBody.querySelector(`input[data-idx="${idx}"][data-field="hy"]`).value) || 0;
const subjectTotal = ut + hy;
const totalCell = marksTableBody.querySelector(`tr:nth-child(${idx + 1}) td:last-child`);
if (totalCell) totalCell.textContent = subjectTotal;

// Update student object directly
m.ut = ut;
m.hy = hy;
m.total = subjectTotal;

grandCombinedTotal += (ut + hy);
grandOverallTotal += subjectTotal;
}
});
qs('totalCombined').textContent = grandCombinedTotal;
}

qs('totalOverall').textContent = grandOverallTotal;

// Update Chart
updateChart(student);
}

/* ---------------- CHART (UNCHANGED) ---------------- */
function initChart() {
const ctx = qs('marksChart').getContext('2d');
state.chart = new Chart(ctx, {
type: 'bar',
data: {
labels: [],
datasets: [{
label: 'Marks Scored',
data: [],
backgroundColor: 'rgba(75, 192, 192, 0.6)',
borderColor: 'rgba(75, 192, 192, 1)',
borderWidth: 1
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
max: 100,
title: {
display: true,
text: 'Total Marks (Max 100)'
}
}
},
plugins: {
legend: {
display: false
}
}
}
});
}
function updateChart(student) {
if (!state.chart || !student) return;

const labels = [];
const data = [];

// Filter out grade-based subjects and only include mark-based ones
const markBasedMarks = student.marks.filter(m => !m.isGrade);
markBasedMarks.forEach(m => {
labels.push(m.name);
data.push(m.total);
});

state.chart.data.labels = labels;
state.chart.data.datasets[0].data = data;
state.chart.update();
}

/* ---------------- DASHBOARD (UNCHANGED) ---------------- */
function getClassAverage(cls) {
const students = state.studentsByClass[cls] || {};
const markBasedStudents = Object.values(students).filter(s => s.overallTotal !== undefined && s.overallTotal !== null);
if (markBasedStudents.length === 0) return { avg: 0, count: 0 };
const total = markBasedStudents.reduce((sum, s) => sum + s.overallTotal, 0);
return { avg: total / markBasedStudents.length, count: markBasedStudents.length };
}
function getClassHighest(cls) {
const students = state.studentsByClass[cls] || {};
const markBasedStudents = Object.values(students).filter(s => s.overallTotal !== undefined && s.overallTotal !== null);
if (markBasedStudents.length === 0) return { name: '—', score: 0 };
let topper = null;
let maxScore = -1;
markBasedStudents.forEach(s => {
if (s.overallTotal > maxScore) {
maxScore = s.overallTotal;
topper = s;
}
});
return topper ? { name: topper.name, score: maxScore } : { name: '—', score: 0 };
}
function getSchoolTopper() {
let schoolTopper = { name: '—', score: -1, cls: '—' };
for (const cls in state.studentsByClass) {
const students = state.studentsByClass[cls];
for (const key in students) {
const s = students[key];
if (s.overallTotal > schoolTopper.score) {
schoolTopper.score = s.overallTotal;
schoolTopper.name = s.name;
schoolTopper.cls = displayClassLabel(s.cls);
}
}
}
return schoolTopper;
}
function showDashboardTopper() {
const cls = interpretClassValue(qs('dashboardClassSelect').value);
const classTopper = getClassHighest(cls);
const schoolTopper = getSchoolTopper();

qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} (${classTopper.score} marks)`;
qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} (${schoolTopper.score} marks, Class ${schoolTopper.cls})`;
}
function bulkDownloadReports() {
if (!window.confirm("Are you sure you want to trigger bulk print? This will open a print dialog for every student in the selected class(es).")) {
return;
}
const classesToDownload = Array.from(qs('dashboardClassSelect').options).map(o => o.value).filter(v => v);
if (classesToDownload.length === 0) {
alert("No classes to download. Please ensure classes are defined.");
return;
}
let studentKeysToPrint = [];
classesToDownload.forEach(cls => {
const students = state.studentsByClass[cls] || {};
Object.keys(students).forEach(key => studentKeysToPrint.push(key));
});
if (studentKeysToPrint.length === 0) {
alert("No students found in the local database to print.");
return;
}
studentKeysToPrint.forEach(key => {
state.selectedStudentKey = key;
loadStudent(key);
calculateTotalsAndUpdate();
window.print();
});
}
function clearAllData() {
const password = prompt("Enter password to clear all local data:");
if (password === "CLEAR123") { // Simple password check
localStorage.removeItem('ng_students');
state.studentsByClass = {};
state.selectedClass = '';
state.selectedStudentKey = '';
alert("All local report card data has been cleared.");
window.location.reload();
} else {
alert("Incorrect password. Data not cleared.");
}
}

/* ----------------- CLEAN UP (UNCHANGED) ----------------- */
function clearStudentView() {
state.selectedStudentKey = '';
qs('admissionNo').textContent = '—';
qs('studentName').textContent = '—';
qs('fatherName').textContent = '—';
qs('studentNameInput').value = '';
qs('admissionInput').value = '';
// Clear father name input
if (qs('fatherNameInput')) qs('fatherNameInput').value = '';
qs('classSection').textContent = state.selectedClass ? displayClassLabel(state.selectedClass) : '—';
// Clear *both* sets of attendance inputs
document.querySelectorAll('#attendancePresent').forEach(el => el.value = '');
document.querySelectorAll('#attendanceTotal').forEach(el => el.value = DEFAULT_ATT_TOTAL);

qs('coscholasticBody').innerHTML = `
<tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
<tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
`;
if (qs('teachersRemark')) qs('teachersRemark').textContent = 'Good effort. Keep improving.';
renderMarksTableForClass(state.selectedClass);
}
/* ----------------- UPDATE PRINT DATE (UNCHANGED) ----------------- */
function updatePrintDate() {
const printDate = new Date().toLocaleDateString();
qs('printDate').textContent = 'Date: ' + printDate;
}
/* ----------------- END OF SCRIPT ---------------- */
</script>
