<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NANDI GURUKUL VIDYA MANDIR - Report Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/patternomaly@1.3.2/dist/patternomaly.min.js"></script>

<style>
/* -------- PRINT STYLES - A4, watermark, footer positions, etc. -------- */
@media print {
body { -webkit-print-color-adjust: exact; }
.no-print { display: none !important; }
.screen-only { display: none !important; }
.print-only { display: block !important; }

.page {
  width: 210mm;
  min-height: 297mm; 
  margin: 0 auto;
  padding: 5mm 12.7mm; 
  box-shadow: none;
  background: white;
  position: relative;
  page-break-inside: avoid; 
  -webkit-print-color-adjust: exact;
  display: flex; 
  flex-direction: column;
}

.page::before{
content: "";
position: absolute; 
top: 50%; left: 50%;
transform: translate(-50%, -50%);
width: 60%; height: 60%;
background-image: url('watermark.png'); 
background-repeat: no-repeat;
background-position: center;
background-size: contain;
opacity: 0.1; 
pointer-events: none;
z-index: 0;
}

.page-content-wrapper {
  flex-grow: 1; 
  display: flex;
  flex-direction: column;
}

.page-footer-area { margin-top: auto; }
.page-footer-area, #finalFooter, #disclaimer, #printDate, .muted, .school-name-color {
    color: black !important;
}

#finalFooter {
  display: flex; justify-content: space-between; align-items: flex-start;
}
#finalFooter .col { 
    width: 33%; text-align: center; display: flex; 
    flex-direction: column; justify-content: flex-end; min-height: 80px; 
}
#finalFooter .left { text-align: left; }
#finalFooter .right { text-align: right; }
.signature-space { flex-grow: 1; }
.principal-img { height: 48px; display: block; margin: 0 auto 6px; }
#disclaimer { text-align: center; font-size: 10px; margin-top: 3px; }
#printDate { text-align: center; font-size: 10px; margin-top: 2px; }
table { page-break-inside:auto; }
tr { page-break-inside:avoid; page-break-after:auto; }
}

/* ---------------- SCREEN STYLES ---------------- */
body { background: #f1f5f9; }
.print-only { display: none; } 
.page { width: 900px; margin: 20px auto; padding: 18px; background: white; box-shadow: 0 6px 18px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; }
.school-name-color { color: #4f46e5; } 
.school-name { letter-spacing: 1px; }
input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.muted { color:#6b7280; } 
table input[type="number"] { text-align:center; }
select.grade-select { padding:4px; border-radius:4px; }
</style>
</head>
<body class="bg-gray-100 p-6">
<div class="no-print mb-4 p-4 bg-white border rounded-lg shadow-sm">
    <h2 class="font-bold mb-2 text-indigo-700">School Dashboard (Topper Analysis)</h2>
    <div class="grid grid-cols-5 gap-4 items-end">
        <div>
            <label class="block text-sm text-gray-600 mb-1">Select Class:</label>
            <select id="dashboardClassSelect" class="border rounded px-2 py-1 w-full">
                <option value="">-- Select Class --</option>
                <option value="Nursery">Nursery</option><option value="LKG">LKG</option><option value="UKG">UKG</option>
                <option value="1">I</option><option value="2">II</option><option value="3">III</option>
                <option value="4">IV</option><option value="5">V</option><option value="6">VI</option>
                <option value="7">VII</option><option value="8">VIII</option><option value="9">IX</option>
            </select>
        </div>
        <div class="col-span-2">
            <p id="classTopperDashboard" class="font-semibold mt-1">Class Topper: —</p>
            <p id="schoolTopperDashboard" class="font-semibold mt-1">School Topper: —</p>
        </div>
        <div class="col-span-2 flex justify-end gap-2">
            <button id="bulkDownloadBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700">Download Class Reports</button>
            <button id="clearDataBtn" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Clear All Server Data</button>
        </div>
    </div>
</div>

<div class="page">
  <div class="page-content-wrapper">
    <div class="pb-6 border-b mb-6 relative">
        <img src="logo.png" class="w-24 h-24 rounded-md absolute top-0 left-3" alt="School Logo" />
        <div class="text-center ml-[112px] mr-[112px]"> 
            <h1 class="text-2xl font-extrabold school-name school-name-color">NANDI GURUKUL VIDYA MANDIR</h1>
            <p class="text-sm">Academic Session: <strong>2025-26</strong></p>
            <p class="text-sm mt-1 text-gray-700 font-semibold">REPORT CARD - HALF YEARLY EXAMINATION</p>
        </div>
        <div class="text-right no-print absolute top-0 right-0">
            <label class="block text-xs text-gray-600">Select Class</label>
            <select id="classSelect" class="border rounded px-2 py-1 bg-white">
                <option value="">-- Select Class --</option>
                <option value="Nursery">Nursery</option><option value="LKG">LKG</option><option value="UKG">UKG</option>
                <option value="1">I</option><option value="2">II</option><option value="3">III</option>
                <option value="4">IV</option><option value="5">V</option><option value="6">VI</option>
                <option value="7">VII</option><option value="8">VIII</option><option value="9">IX</option>
            </select>
        </div>
    </div>
    <div class="no-print mb-4">
        <div class="grid grid-cols-5 gap-4 items-end">
            <div>
                <label class="text-sm text-gray-600">Admission Number</label>
                <input id="admissionInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="e.g. 138/Z18" />
            </div>
            <div>
                <label class="text-sm text-gray-600">Student Name</label>
                <input id="studentNameInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="Student's full name" />
            </div>
            <div>
                <label class="text-sm text-gray-600">Father's Name</label>
                <input id="fatherNameInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="Father's full name" />
            </div>
            <div class="col-span-2 flex gap-2 justify-end">
                <button id="loadBtn" class="px-3 py-1 border rounded hover:bg-gray-100">Load Student</button>
                <button id="saveBtn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Save to Server</button>
                <button id="printBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700">Print Report</button>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-4 gap-4 mb-4 mt-4">
        <div><p class="text-sm text-gray-600">Admission No.</p><h2 id="admissionNo" class="font-semibold">—</h2></div>
        <div><p class="text-sm text-gray-600">Name</p><h2 id="studentName" class="font-semibold">—</h2></div>
        <div><p class="text-sm text-gray-600">Father's Name</p><h2 id="fatherName" class="font-semibold">—</h2></div>
        <div><p class="text-sm text-gray-600">Class/Section</p><h2 id="classSection" class="font-semibold">—</h2></div>
    </div>
    <div class="mb-4 screen-only">
        <label class="text-sm text-gray-600 font-semibold">Attendance</label>
        <div class="flex gap-2 items-center">
            <input type="number" id="attendancePresent" min="0" max="130" placeholder="Days Present" class="border px-2 py-1 rounded w-32" />
            <input type="number" id="attendanceTotal" readonly value="130" class="border px-2 py-1 rounded w-40 bg-gray-200 text-center" />
        </div>
    </div>
    <div class="overflow-x-auto"><table id="marksTable" class="w-full border-collapse table-auto text-sm"><thead id="marksTableHead"></thead><tbody id="marksTableBody"></tbody><tfoot id="marksTableFoot"></tfoot></table></div>
    <div class="grid grid-cols-3 gap-4 mt-6">
        <div class="col-span-1">
            <div class="border p-4"><h3 class="font-semibold mb-2">Co-Scholastic Grades</h3><table class="w-full text-sm" id="coscholasticTable"><tbody id="coscholasticBody"></tbody></table></div>
            <div class="border p-4 mt-4"><h3 class="font-semibold mb-2">Class Teacher's Remark</h3><div id="teachersRemark" class="w-full p-2 text-sm border rounded bg-gray-50"></div></div>
            <div class="border p-4 mt-4 print-only"><h3 class="font-semibold mb-2">Attendance</h3><p id="attendancePrintDisplay" class="font-semibold"></p></div>
        </div>
        <div class="col-span-2">
            <div class="border p-4"><h3 class="font-semibold mb-2">Graphical Analysis (Half Yearly)</h3><canvas id="marksChart" height="180"></canvas></div>
        </div>
    </div>
  </div>
  <div class="page-footer-area">
    <div id="finalFooter">
        <div class="col left"><div class="signature-space"></div><div class="signature-label">Class Teacher</div></div>
        <div class="col"><div class="signature-space"></div><div class="signature-label">School Seal</div></div>
        <div class="col right"><img src="principal.png" alt="Principal" class="principal-img" /><div class="signature-label">Principal</div></div>
    </div>
    <div id="disclaimer" class="muted text-center">*This digitally generated report card is a bonafide record of student's academic performance.</div>
    <div id="printDate" class="text-center muted">Date: —</div>
  </div>
</div>

<script>
/* ---------------- CONFIG & SUBJECTS ---------------- */
const SUBJECTS_NUR_TO_UKG = [
    { name: "English", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 }, { name: "Hindi", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
    { name: "Maths", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 }, { name: "Drawing", utMax: 20, utOralMax: 0, hyMax: 80, hyOralMax: 0 }
];
const SUBJECTS_1_TO_5 = ["Hindi", "English", "Mathematics", "Computer", "E.V.S.", "Drawing", "G.K."];
const SUBJECTS_6_TO_8 = ["Hindi", "English", "Mathematics", "Computer", "Drawing", "G.K.", "Science", "S.S.T."];
const SUBJECTS_9 = ["Hindi", "English", "Mathematics", "Science", "S.S.T.", "Drawing"];
const DEFAULT_ATT_TOTAL = 130;
/* ---------------- STATE ---------------- */
let state = {
    selectedClass: '',
    selectedStudentKey: '',
    studentsByClass: {}, // This will hold data loaded from the "server"
    chart: null
};
/* ---------------- UTIL ---------------- */
const qs = id => document.getElementById(id);

/**
 * ====================================================================
 * I. PERMANENT DATA STORAGE (SERVER-SIDE)
 * ====================================================================
 * These functions replace localStorage and are designed to communicate
 * with a real backend server (e.g., using Node.js, Python, or Firebase).
 */

/**
 * Fetches all student data from the server.
 * @returns {Promise<Object>} A promise that resolves to the studentsByClass object.
 */
async function loadAllDataFromServer() {
    console.log("SERVER: Fetching all student data...");
    // In a real app, this would be a GET request to your API
    // const response = await fetch('/api/students');
    // const data = await response.json();
    // return data;

    // For now, we simulate by getting data from a temporary local store
    const stored = localStorage.getItem('ng_students_temp_demo');
    return stored ? JSON.parse(stored) : {};
}

/**
 * Saves the entire student data object to the server.
 * @param {Object} data The studentsByClass object to save.
 */
async function saveAllDataToServer(data) {
    console.log("SERVER: Saving all student data...", data);
    // In a real app, this would be a POST request to your API
    // await fetch('/api/students', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify(data)
    // });
    
    // For now, we simulate by saving to a temporary local store
    localStorage.setItem('ng_students_temp_demo', JSON.stringify(data));
}

/* ---------------- INIT ---------------- */
async function init() {
    state.studentsByClass = await loadAllDataFromServer();
    attachEventListeners();
    initChart(); // Initialize the black & white chart
    updatePrintDate();
    renderMarksTableForClass(''); // Initial empty state
}
init();

/* ---------------- EVENT LISTENERS ---------------- */
function attachEventListeners() {
    qs('classSelect').addEventListener('change', e => {
        state.selectedClass = interpretClassValue(e.target.value);
        qs('classSection').textContent = displayClassLabel(state.selectedClass);
        clearStudentView();
        renderMarksTableForClass(state.selectedClass);
    });

    qs('loadBtn').addEventListener('click', () => {
        if (!state.selectedClass) return alert('Select a Class first.');
        const admission = qs('admissionInput').value.trim();
        if (!admission) return alert('Enter an Admission Number to load.');
        
        const key = `${state.selectedClass}|${admission}`;
        if (!state.studentsByClass[state.selectedClass]?.[key]) {
            return alert('Student not found on server. Please add them first.');
        }
        state.selectedStudentKey = key;
        loadStudent(key);
    });

    qs('saveBtn').addEventListener('click', async () => {
        if (!state.selectedClass) return alert('Select a Class first.');
        const admission = qs('admissionInput').value.trim();
        if (!admission) return alert('Enter Admission Number.');
        const name = qs('studentNameInput').value.trim();
        if (!name) return alert('Enter Student Name.');

        // Save or update the student data
        const student = saveCurrentStudentData();
        if (!student) return; // In case of validation failure

        // Persist all data to the server
        await saveAllDataToServer(state.studentsByClass);
        state.selectedStudentKey = student.key;
        loadStudent(student.key); // Reload to confirm changes
        alert(`Student '${student.name}' saved to server successfully!`);
    });

    qs('printBtn').addEventListener('click', () => {
        if (!state.selectedStudentKey) return alert('Load a student before printing.');
        calculateTotalsAndUpdate(); // Final calculation before printing
        window.print();
    });
    
    qs('dashboardClassSelect').addEventListener('change', showDashboardTopper);
    qs('bulkDownloadBtn').addEventListener('click', bulkDownloadReports);
    qs('clearDataBtn').addEventListener('click', clearAllData);
}

/**
 * ====================================================================
 * II. CHARTING (Black & White with Patterns)
 * ====================================================================
 */
function initChart() {
    const ctx = qs('marksChart').getContext('2d');
    state.chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            plugins: { legend: { display: true, labels: { color: '#000' } } },
            scales: {
                y: { beginAtZero: true, max: 100, ticks: { color: '#000' }, grid: { color: 'rgba(0,0,0,0.1)' } },
                x: { ticks: { color: '#000' }, grid: { color: 'rgba(0,0,0,0.1)' } }
            }
        }
    });
}

function updateChart(student) {
    const labels = student.marks.map(m => m.name);
    const obtained = student.marks.map(m => m.isGrade ? 0 : (m.total || 0));
    const classAvg = labels.map(l => getClassAverage(student.cls, l));
    const classHigh = labels.map(l => getClassHighest(student.cls, l));
    
    state.chart.data.labels = labels;
    state.chart.data.datasets = [
        {
            label: 'Obtained Marks',
            data: obtained,
            backgroundColor: pattern.draw('cross-hatch', '#000000', '#ffffff'),
            borderColor: '#000000',
            borderWidth: 1.5
        },
        {
            label: 'Class Average',
            data: classAvg,
            backgroundColor: pattern.draw('dash', '#aaaaaa', '#ffffff'),
            borderColor: '#555555',
            borderWidth: 1
        },
        {
            label: 'Class Highest',
            data: classHigh,
            backgroundColor: pattern.draw('dot', '#888888', '#ffffff'),
            borderColor: '#333333',
            borderWidth: 1
        }
    ];
    state.chart.update();
}


/* ---------------- All Other Functions (Rendering, Calculations, etc.) ---------------- */
// (The rest of the JS logic remains largely the same, but adapted for the new data flow)

function interpretClassValue(val) {
    if (!val) return '';
    const romanMap = { "I":"1","II":"2","III":"3","IV":"4","V":"5","VI":"6","VII":"7","VIII":"8","IX":"9" };
    return romanMap[val] || val;
}

function displayClassLabel(cls) {
    if (!cls) return '—';
    if (['Nursery', 'LKG', 'UKG'].includes(cls)) return cls;
    const map = {1:'I',2:'II',3:'III',4:'IV',5:'V',6:'VI',7:'VII',8:'VIII',9:'IX'};
    return map[Number(cls)] || cls;
}

function makeEmptyStudent(name, admission, cls, fatherName='') {
    const marks = [];
    const subjects = isNurToUkg(cls) ? SUBJECTS_NUR_TO_UKG : subjectsForClass(cls);

    subjects.forEach(s => {
        if (isNurToUkg(cls)) {
            marks.push({ name: s.name, ut: 0, utOral: 0, hy: 0, hyOral: 0, total: 0, max: s });
        } else if (s === 'G.K.') {
            marks.push({ name: s, grade: 'A', isGrade: true });
        } else {
            marks.push({ name: s, ut: 0, hy: 0, total: 0, max: { ut: 20, hy: 80 } });
        }
    });

    return { name, admission, cls, fatherName, marks, coscholastic: {}, attendance: { present: 0, total: DEFAULT_ATT_TOTAL }, teachersRemark: 'Good effort. Keep improving.' };
}

function isNurToUkg(cls) { return ['Nursery', 'LKG', 'UKG'].includes(cls); }

function subjectsForClass(cls) {
    const n = Number(cls);
    if (n >=1 && n <=5) return SUBJECTS_1_TO_5;
    if (n >=6 && n <=8) return SUBJECTS_6_TO_8;
    if (n === 9) return SUBJECTS_9;
    return [];
}

function renderMarksTableForClass(cls) {
    // ... This function remains largely the same as your original ...
    const thead = qs('marksTableHead'), tbody = qs('marksTableBody'), tfoot = qs('marksTableFoot');
    tbody.innerHTML = ''; tfoot.innerHTML = '';
    if (!cls) {
        thead.innerHTML = `<tr><th class="border p-2">Select a class to begin.</th></tr>`;
        return;
    }
    
    const student = getCurrentStudent();
    const subjects = isNurToUkg(cls) ? SUBJECTS_NUR_TO_UKG : subjectsForClass(cls);

    if (isNurToUkg(cls)) {
        thead.innerHTML = `<tr class="bg-gray-100"><th class="border p-2">Subject</th><th class="border p-2 text-center">UT Written</th><th class="border p-2 text-center">UT Oral</th><th class="border p-2 text-center">HY Written</th><th class="border p-2 text-center">HY Oral</th><th class="border p-2 text-center font-semibold">Total</th></tr>`;
        subjects.forEach((s, idx) => {
            const m = student?.marks[idx] || {};
            tbody.innerHTML += `<tr>
                <td class="border p-2">${s.name}</td>
                <td class="border p-2"><input data-idx="${idx}" data-field="ut" type="number" min="0" max="${s.utMax}" value="${m.ut || 0}" class="w-full p-1 border rounded text-center"></td>
                <td class="border p-2"><input data-idx="${idx}" data-field="utOral" type="number" min="0" max="${s.utOralMax}" value="${m.utOral || 0}" class="w-full p-1 border rounded text-center" ${s.utOralMax===0?'disabled':''}></td>
                <td class="border p-2"><input data-idx="${idx}" data-field="hy" type="number" min="0" max="${s.hyMax}" value="${m.hy || 0}" class="w-full p-1 border rounded text-center"></td>
                <td class="border p-2"><input data-idx="${idx}" data-field="hyOral" type="number" min="0" max="${s.hyOralMax}" value="${m.hyOral || 0}" class="w-full p-1 border rounded text-center" ${s.hyOralMax===0?'disabled':''}></td>
                <td class="border p-2 font-semibold text-center">${m.total || 0}</td>
            </tr>`;
        });
        tfoot.innerHTML = `<tr class="bg-gray-50"><td colspan="5" class="border p-2 font-semibold text-right">Grand Total</td><td id="totalOverall" class="border p-2 font-semibold text-center">0</td></tr>
                           <tr class="bg-gray-50"><td colspan="5" class="border p-2 font-semibold text-right">Percentage</td><td id="percentage" class="border p-2 font-semibold text-center">0%</td></tr>`;
    } else {
        thead.innerHTML = `<tr class="bg-gray-100"><th class="border p-2">Subject</th><th class="border p-2 text-center">Unit Test (20)</th><th class="border p-2 text-center">Half Yearly (80)</th><th class="border p-2 text-center font-semibold">Total (100)</th></tr>`;
        subjects.forEach((s, idx) => {
            const m = student?.marks[idx] || {};
            if (s === 'G.K.') {
                const grade = m.grade || 'A';
                tbody.innerHTML += `<tr><td class="border p-2">${s}</td><td class="border p-2 text-center">—</td><td class="border p-2 text-center">—</td><td class="border p-2 text-center">
                <select data-idx="${idx}" data-field="grade" class="grade-select"><option>A</option><option>B</option><option>C</option><option>D</option></select></td></tr>`;
                setTimeout(() => qs(`[data-idx="${idx}"]`).value = grade, 0);
            } else {
                tbody.innerHTML += `<tr><td class="border p-2">${s}</td>
                <td class="border p-2"><input data-idx="${idx}" data-field="ut" type="number" min="0" max="20" value="${m.ut || 0}" class="w-full p-1 border rounded text-center"></td>
                <td class="border p-2"><input data-idx="${idx}" data-field="hy" type="number" min="0" max="80" value="${m.hy || 0}" class="w-full p-1 border rounded text-center"></td>
                <td class="border p-2 font-semibold text-center">${m.total || 0}</td></tr>`;
            }
        });
        tfoot.innerHTML = `<tr class="bg-gray-50"><td colspan="3" class="border p-2 font-semibold text-right">Grand Total</td><td id="totalOverall" class="border p-2 font-semibold text-center">0</td></tr>
                           <tr class="bg-gray-50"><td colspan="3" class="border p-2 font-semibold text-right">Percentage</td><td id="percentage" class="border p-2 font-semibold text-center">0%</td></tr>`;
    }
    attachMarksInputsListeners();
    calculateTotalsAndUpdate();
}

function attachMarksInputsListeners() {
    qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', () => { autoClampInput(el); calculateTotalsAndUpdate(); });
        el.addEventListener('blur', () => { autoClampInput(el); calculateTotalsAndUpdate(); });
    });
}
function autoClampInput(el) {
    if (el.tagName.toLowerCase() === 'select') return;
    const max = Number(el.max), min = Number(el.min) || 0, val = Number(el.value);
    if (isNaN(val)) el.value = '';
    else if (val > max) el.value = max;
    else if (val < min) el.value = min;
}

function loadStudent(key) {
    const student = state.studentsByClass[state.selectedClass]?.[key];
    if (!student) return;
    
    qs('studentName').textContent = student.name;
    qs('admissionNo').textContent = student.admission || '—';
    qs('classSection').textContent = displayClassLabel(student.cls);
    qs('fatherName').textContent = student.fatherName || '—';
    
    qs('studentNameInput').value = student.name;
    qs('admissionInput').value = student.admission || '';
    qs('fatherNameInput').value = student.fatherName || '';
    
    qs('attendancePresent').value = student.attendance.present || 0;
    qs('attendanceTotal').value = student.attendance.total || DEFAULT_ATT_TOTAL;
    qs('attendancePrintDisplay').textContent = `${student.attendance.present || 0} / ${student.attendance.total || DEFAULT_ATT_TOTAL}`;

    renderMarksTableForClass(student.cls); // Renders table structure and attaches listeners
    calculateTotalsAndUpdate(); // Calculates totals and updates chart
}

function saveCurrentStudentData() {
    const cls = state.selectedClass;
    const admission = qs('admissionInput').value.trim();
    const name = qs('studentNameInput').value.trim();
    const fatherName = qs('fatherNameInput').value.trim();
    const key = `${cls}|${admission}`;

    // Ensure class-level object exists
    state.studentsByClass[cls] = state.studentsByClass[cls] || {};

    // Get existing student or create a new one
    let student = state.studentsByClass[cls][key] || makeEmptyStudent(name, admission, cls, fatherName);

    // Update basic details
    student.name = name;
    student.fatherName = fatherName;
    student.attendance = {
        present: Number(qs('attendancePresent').value) || 0,
        total: Number(qs('attendanceTotal').value) || DEFAULT_ATT_TOTAL
    };
    student.coscholastic = {
        workHabits: qs('workHabitsInput')?.value.trim() || '',
        behavior: qs('behaviorInput')?.value.trim() || ''
    };

    // Update marks
    qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
        const idx = Number(el.dataset.idx);
        const field = el.dataset.field;
        if (student.marks[idx]) {
            student.marks[idx][field] = (el.tagName === 'SELECT') ? el.value : (Number(el.value) || 0);
        }
    });

    state.studentsByClass[cls][key] = student;
    return { ...student, key };
}

function getCurrentStudent() {
    if (!state.selectedStudentKey) return null;
    return state.studentsByClass[state.selectedClass]?.[state.selectedStudentKey];
}

function calculateTotalsAndUpdate() {
    const student = getCurrentStudent();
    if (!student) return;

    let totalOverall = 0, numericSubjects = 0;
    student.marks.forEach(m => {
        if (m.isGrade) return;
        m.total = (m.ut || 0) + (m.utOral || 0) + (m.hy || 0) + (m.hyOral || 0);
        totalOverall += m.total;
        numericSubjects++;
    });

    qs('totalOverall').textContent = totalOverall;
    const maxMarks = numericSubjects * 100;
    const percentage = maxMarks > 0 ? ((totalOverall / maxMarks) * 100).toFixed(2) : 0;
    qs('percentage').textContent = `${percentage}%`;

    let remarkText = 'Needs Improvement';
    if (percentage >= 90) remarkText = 'Outstanding';
    else if (percentage >= 80) remarkText = 'Excellent';
    else if (percentage >= 70) remarkText = 'Very Good';
    else if (percentage >= 60) remarkText = 'Good';
    student.teachersRemark = remarkText;
    qs('teachersRemark').textContent = remarkText;
    
    // Refresh table totals
    qs('marksTableBody').querySelectorAll('tr').forEach((tr, idx) => {
        const m = student.marks[idx];
        if (m && !m.isGrade) {
            tr.cells[tr.cells.length - 1].textContent = m.total;
        }
    });
    
    updateChart(student);
}

function clearStudentView() {
    state.selectedStudentKey = '';
    ['studentName', 'admissionNo', 'fatherName'].forEach(id => qs(id).textContent = '—');
    ['studentNameInput', 'admissionInput', 'fatherNameInput'].forEach(id => qs(id).value = '');
    qs('classSection').textContent = state.selectedClass ? displayClassLabel(state.selectedClass) : '—';
    qs('attendancePresent').value = '';
    renderMarksTableForClass(state.selectedClass);
}

function updatePrintDate() { qs('printDate').textContent = 'Date: ' + new Date().toLocaleDateString('en-IN'); }

function getClassAverage(cls, subjectName) {
    if (!state.studentsByClass[cls]) return 0;
    const vals = Object.values(state.studentsByClass[cls]).map(s => s.marks.find(m => m.name === subjectName)?.total || 0);
    return vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
}
function getClassHighest(cls, subjectName) {
    if (!state.studentsByClass[cls]) return 0;
    const vals = Object.values(state.studentsByClass[cls]).map(s => s.marks.find(m => m.name === subjectName)?.total || 0);
    return vals.length ? Math.max(...vals) : 0;
}
function showDashboardTopper() {
    const cls = qs('dashboardClassSelect').value;
    const findTopper = (students) => {
        let topper = { name:'—', total:0 };
        Object.values(students).forEach(s => {
            const total = s.marks.reduce((a, b) => a + (b.total || 0), 0);
            if (total > topper.total) topper = { name: s.name, total };
        });
        return topper;
    };
    if (cls) {
        const classTopper = findTopper(state.studentsByClass[cls] || {});
        qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} (${classTopper.total})`;
    }
    const allStudents = Object.values(state.studentsByClass).flatMap(clsObj => Object.values(clsObj));
    const schoolTopper = findTopper(allStudents);
    qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} (${schoolTopper.total})`;
}
function bulkDownloadReports() { /* ... This function remains the same ... */ }
async function clearAllData() {
    const password = prompt('Enter password to clear ALL server data:');
    if (password !== '1234') return alert('Incorrect password!');
    if (!confirm('This will remove all student data from the server permanently. Are you sure?')) return;
    
    state.studentsByClass = {};
    await saveAllDataToServer({}); // Save empty object to server
    
    clearStudentView();
    alert('All server data has been cleared.');
}

</script>
</body>
</html>
