<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NANDI GURUKUL VIDYA MANDIR - Report Card System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* -------- PRINT STYLES - A4, watermark, footer positions, etc. -------- */
        @media print {
            body { -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .screen-only { display: none !important; }
            .print-only { display: block !important; }

            /* AGGRESSIVE PADDING REDUCTION (Fixes 2-page issue) */
            .page {
                width: 210mm;
                min-height: 297mm; 
                margin: 0 auto;
                padding: 5mm 12.7mm; 
                box-shadow: none; /* Remove shadow on print */
                page-break-inside: avoid; 
                -webkit-print-color-adjust: exact;
                display: flex; 
                flex-direction: column;
            }

            /* Watermark centered: Opacity reduced for typical watermark effect */
            .page::before{
                content: "NANDI GURUKUL";
                position: absolute; 
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg); 
                font-size: 80px;
                color: rgba(0, 0, 0, 0.08); /* Light gray for watermark */
                pointer-events: none;
                z-index: 10;
            }
        }
        
        .page {
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            padding: 15mm;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div id="controlPanel" class="no-print bg-white p-6 shadow-xl rounded-lg mb-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Report Card Management</h1>
        
        <div id="dashboard" class="mb-4 p-4 border rounded-lg bg-indigo-50">
            <h2 class="text-lg font-semibold text-indigo-800 mb-2">Analysis Dashboard</h2>
            <div class="flex space-x-4">
                <select id="dashboardClassSelect" class="border p-2 rounded text-sm bg-white">
                    <option value="I">Class I</option>
                    <option value="II">Class II</option>
                    <option value="III">Class III</option>
                    <option value="IV">Class IV</option>
                    <option value="V">Class V</option>
                    <option value="VI">Class VI</option>
                    <option value="VII">Class VII</option>
                    <option value="VIII">Class VIII</option>
                    <option value="IX">Class IX</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                </select>
                <div id="classTopperDashboard" class="text-sm font-medium text-green-700">Class Topper: —</div>
                <div id="schoolTopperDashboard" class="text-sm font-medium text-blue-700">School Topper: —</div>
            </div>
        </div>

        <div class="flex space-x-4 mb-4 items-end">
            <div>
                <label for="classSelect" class="block text-sm font-medium text-gray-700">Class</label>
                <select id="classSelect" class="border p-2 rounded w-32">
                    <option value="I">I</option>
                    <option value="II">II</option>
                    <option value="III">III</option>
                    <option value="IV">IV</option>
                    <option value="V">V</option>
                    <option value="VI">VI</option>
                    <option value="VII">VII</option>
                    <option value="VIII">VIII</option>
                    <option value="IX">IX</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                </select>
            </div>
            <div>
                <label for="admissionInput" class="block text-sm font-medium text-gray-700">Admission No.</label>
                <input type="text" id="admissionInput" placeholder="Enter Admission No" class="border p-2 rounded w-40" />
            </div>
            <div>
                <label for="studentNameInput" class="block text-sm font-medium text-gray-700">Student Name (Fix)</label>
                <input type="text" id="studentNameInput" placeholder="Student Name" class="border p-2 rounded w-48" />
            </div>
            <div>
                <label for="fatherNameInput" class="block text-sm font-medium text-gray-700">Father's Name (Fix)</label>
                <input type="text" id="fatherNameInput" placeholder="Father's Name" class="border p-2 rounded w-48" />
            </div>
        </div>
        
        <div class="flex space-x-4">
            <button id="loadStudentButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">
                Load from Cloud
            </button>
            <button id="saveStudentButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm">
                Save to Cloud
            </button>
            <button id="prevStudentButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded text-sm">
                &lt; Previous Student (Cycle)
            </button>
            <button id="nextStudentButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded text-sm">
                Next Student (Cycle) &gt;
            </button>
            <button id="bulkPrintButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded text-sm">
                Bulk Print Class
            </button>
            <button id="clearStudentButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded text-sm">
                Clear View
            </button>
        </div>
    </div>
    
    <div class="page bg-white p-6 relative z-20">
        
        <header class="text-center mb-6">
            <h1 class="text-2xl font-extrabold text-blue-900">NANDI GURUKUL VIDYA MANDIR</h1>
            <p class="text-sm">ANNUAL PROGRESS REPORT - ACADEMIC SESSION 2024-25</p>
        </header>

        <div class="border p-4 mb-4 text-sm font-medium">
            <div class="grid grid-cols-2 gap-2">
                <div><span class="font-bold">Name of Student:</span> <span id="studentName" class="text-blue-700">—</span></div>
                <div><span class="font-bold">Admission No:</span> <span id="admissionNo" class="text-blue-700">—</span></div>
                <div><span class="font-bold">Father's Name:</span> <span id="fatherName" class="text-blue-700">—</span></div>
                <div><span class="font-bold">Class & Section:</span> <span id="classSection" class="text-blue-700">—</span></div>
            </div>
        </div>

        <h2 class="text-md font-bold bg-gray-200 p-1 text-center mb-2">SCHOLASTIC AREAS (Marks out of 100 per Term)</h2>
        <div class="overflow-x-auto mb-4">
            <table class="min-w-full border border-gray-300 text-sm">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border px-2 py-1 text-left w-1/4">Subjects</th>
                        <th class="border px-2 py-1 w-1/6">Term I</th>
                        <th class="border px-2 py-1 w-1/6">Term II</th>
                        <th class="border px-2 py-1 w-1/6">Term III</th>
                        <th class="border px-2 py-1 w-1/6">Total (Out of 300)</th>
                    </tr>
                </thead>
                <tbody id="marksTableBody">
                    </tbody>
                <tfoot>
                    <tr class="font-bold bg-yellow-100">
                        <td colspan="4" class="border px-2 py-1 text-right">GRAND TOTAL</td>
                        <td id="grandTotal" class="border px-2 py-1 text-center">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="grid grid-cols-2 gap-6 mb-4">
            
            <div class="p-3 border-2 border-indigo-300 rounded-lg bg-indigo-50">
                <h3 class="text-md font-bold text-indigo-700 mb-2">FINAL RESULT</h3>
                <div class="flex justify-between mt-2">
                    <span class="font-bold text-gray-700">Grand Total:</span>
                    <span id="gradeTotal" class="font-bold text-lg text-blue-700">0</span>
                </div>
                <div class="flex justify-between mt-2 border-t pt-2">
                    <span class="font-bold text-gray-700">Overall Percentage:</span>
                    <span id="overallPercentage" class="font-bold text-xl text-blue-700">0%</span>
                </div>

                <div class="flex justify-between mt-2">
                    <span class="font-bold text-gray-700">Final Grade/Division:</span>
                    <span id="finalGrade" class="font-bold text-xl text-indigo-700">—</span>
                </div>
            </div>

            <div class="p-3 border-2 border-green-300 rounded-lg bg-green-50">
                <h3 class="text-md font-bold text-green-700 mb-2">ATTENDANCE & BEHAVIOR</h3>
                
                <div class="flex justify-between mt-2">
                    <label class="font-bold text-gray-700">Days Present:</label>
                    <input type="number" id="attendancePresent" value="0" class="w-20 text-center border p-1 rounded">
                </div>
                <div class="flex justify-between mt-2">
                    <label class="font-bold text-gray-700">Total Working Days:</label>
                    <input type="number" id="attendanceTotal" value="200" class="w-20 text-center border p-1 rounded">
                </div>
                
                <div class="flex justify-between mt-3 border-t pt-3">
                    <span class="font-bold text-gray-700">Attendance Status (75% Req.):</span>
                    <span id="attendanceStatus" class="font-bold text-xl text-red-600">PASS</span>
                </div>
            </div>

        </div>

        <div class="grid grid-cols-2 gap-6 mb-4">
            <div>
                <h2 class="text-md font-bold bg-gray-200 p-1 text-center mb-2">CO-SCHOLASTIC & BEHAVIOR</h2>
                <table class="min-w-full border border-gray-300 text-sm">
                    <tbody id="coscholasticBody">
                        <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
                        <tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
                    </tbody>
                </table>
            </div>
            <div>
                <h2 class="text-md font-bold bg-gray-200 p-1 text-center mb-2">TEACHER'S REMARK</h2>
                <textarea id="teachersRemark" rows="3" class="w-full border p-2 text-sm" placeholder="Write remarks here..."></textarea>
            </div>
        </div>
        
        <h2 class="text-md font-bold bg-gray-200 p-1 text-center mb-2">PERFORMANCE CHART</h2>
        <div class="w-full h-64 mb-6">
            <canvas id="marksChart"></canvas>
        </div>

        <div class="mt-auto text-sm">
            <div class="flex justify-between border-t pt-2">
                <div id="printDate" class="text-gray-600">Date: —</div>
                <div class="font-bold text-gray-800">Principal Signature: ...................................</div>
            </div>
        </div>

    </div>
    <script>
    /* ----------------- CONFIG & GLOBALS ----------------- */

    // ⭐⭐ CRITICAL: PASTE YOUR DEPLOYED GOOGLE APPS SCRIPT URL HERE
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycby-y3VxM0BxpBHrVx53TOE0hKTyzXwGHPdaFWLCk60em19j2tjm6PZz2S4NRPWZmC6zOA/exec"; 

    const qs = id => document.getElementById(id);
    const DEFAULT_ATT_TOTAL = 200;
    const MIN_ATTENDANCE_PERCENT = 75; 
    const MAX_TOTAL_MARKS_PER_SUBJECT = 300; 

    const state = {
    studentsByClass: JSON.parse(localStorage.getItem('ng_students') || '{}'),
    selectedStudentKey: null,
    selectedClass: qs('classSelect') ? qs('classSelect').value : 'I',
    chart: null,
    allStudentsData: [],
    classCycleList: [],
    cycleIndex: -1, 
    };

    // Define all subjects by class (critical for marks table)
    const SUBJECTS = {
    'Nursery': ['English', 'Maths', 'Hindi', 'EVS', 'GK', 'Drawing'],
    'LKG': ['English', 'Maths', 'Hindi', 'EVS', 'GK', 'Drawing'],
    'UKG': ['English', 'Maths', 'Hindi', 'EVS', 'GK', 'Drawing'],
    'I': ['English', 'Hindi', 'Maths', 'EVS', 'Computer', 'GK'],
    'II': ['English', 'Hindi', 'Maths', 'EVS', 'Computer', 'GK'],
    'III': ['English', 'Hindi', 'Maths', 'Science', 'S.Studies', 'Computer', 'GK'],
    'IV': ['English', 'Hindi', 'Maths', 'Science', 'S.Studies', 'Computer', 'GK'],
    'V': ['English', 'Hindi', 'Maths', 'Science', 'S.Studies', 'Computer', 'GK'],
    'VI': ['English', 'Hindi', 'Maths', 'Science', 'S.Studies', 'Sanskrit', 'Computer', 'GK'],
    'VII': ['English', 'Hindi', 'Maths', 'Science', 'S.Studies', 'Sanskrit', 'Computer', 'GK'],
    'VIII': ['English', 'Hindi', 'Maths', 'Science', 'S.Studies', 'Sanskrit', 'Computer', 'GK'],
    'IX': ['English', 'Hindi', 'Maths', 'Science', 'S.Studies', 'Sanskrit', 'Computer', 'GK'],
    };
    const TERMS = ['T1', 'T2', 'T3'];


    /* ----------------- DATA HELPERS ----------------- */

    function subjectsForClass(cls) {
    return SUBJECTS[cls] || [];
    }

    function persistStudents() {
    localStorage.setItem('ng_students', JSON.stringify(state.studentsByClass));
    }

    function getCurrentStudent() {
    if (!state.selectedStudentKey) return null;
    const [cls, ] = state.selectedStudentKey.split('|');
    if (!state.studentsByClass[cls]) return null;
    return state.studentsByClass[cls][state.selectedStudentKey];
    }

    function updateClassCycleList() {
        const cls = state.selectedClass;
        state.classCycleList = state.allStudentsData
            .filter(s => s.cls === cls)
            .sort((a, b) => {
                const aNum = parseInt(a.admission);
                const bNum = parseInt(b.admission);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                }
                return String(a.admission).localeCompare(String(b.admission));
            });

        state.cycleIndex = -1;
    }

    function updateCycleIndex(key) {
        const student = state.classCycleList.find(s => `${s.cls}|${s.admission}` === key);
        if (student) {
            state.cycleIndex = state.classCycleList.indexOf(student);
        } else {
            state.cycleIndex = -1;
        }
    }


    /* ----------------- UI RENDERING ----------------- */

    function displayClassLabel(cls) {
    return cls; 
    }

    function clearStudentView(cls) {
    // Clear input fields
    if (qs('admissionInput')) qs('admissionInput').value = '';
    if (qs('studentNameInput')) qs('studentNameInput').value = '';
    if (qs('fatherNameInput')) qs('fatherNameInput').value = '';
    if (qs('teachersRemark')) qs('teachersRemark').value = 'Good effort. Keep improving.';

    // Clear display areas
    if (qs('admissionNo')) qs('admissionNo').textContent = '—';
    if (qs('studentName')) qs('studentName').textContent = '—';
    if (qs('fatherName')) qs('fatherName').textContent = '—';
    if (qs('classSection')) qs('classSection').textContent = displayClassLabel(cls);
    
    // Clear calculated display areas
    if (qs('overallPercentage')) qs('overallPercentage').textContent = '0%';
    if (qs('finalGrade')) qs('finalGrade').textContent = '—';
    if (qs('attendanceStatus')) {
        qs('attendanceStatus').textContent = '—';
        qs('attendanceStatus').classList.remove('text-green-600', 'text-red-600');
    }

    // Clear inputs/tables
    document.querySelectorAll('#attendancePresent').forEach(el => el.value = 0);
    document.querySelectorAll('#attendanceTotal').forEach(el => el.value = DEFAULT_ATT_TOTAL);
    
    // Re-render empty coscholastic inputs
    if (qs('coscholasticBody')) qs('coscholasticBody').innerHTML = `
        <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
        <tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
    `;
    renderMarksTableForClass(cls);
    calculateTotalsAndUpdate();
    }

    function renderMarksTableForClass(cls) {
    const subjects = subjectsForClass(cls);
    let html = subjects.map(subject => {
        let termInputs = TERMS.map(term => 
        `<td class="border px-2 py-1"><input type="number" id="${subject}-${term}" value="" class="marks-input w-full text-center border-none p-0 focus:ring-0" min="0" max="100"/></td>`
        ).join('');
        return `
        <tr>
            <td class="border px-2 py-1 text-left font-medium">${subject}</td>
            ${termInputs}
            <td class="border px-2 py-1 text-center font-bold" id="${subject}-Total">0</td>
        </tr>`;
    }).join('');
    if (qs('marksTableBody')) qs('marksTableBody').innerHTML = html;
    attachMarksInputsListeners();
    }

    function updatePrintDate() {
    const printDate = new Date().toLocaleDateString('en-IN');
    if(qs('printDate')) qs('printDate').textContent = 'Date: ' + printDate;
    }


    /* ----------------- CALCULATIONS ----------------- */

    function computeTotalsFromInputs() {
    const marks = {};
    const subjects = subjectsForClass(state.selectedClass);
    let totalPossibleMarks = subjects.length * MAX_TOTAL_MARKS_PER_SUBJECT; 
    
    subjects.forEach(subject => {
        marks[subject] = {};
        let subjectTotal = 0;
        
        TERMS.forEach(term => {
        const input = qs(`${subject}-${term}`);
        const value = Number(input.value) || 0;
        marks[subject][term] = value;
        subjectTotal += value;
        });

        marks[subject].Total = subjectTotal;
    });
    
    let grandTotal = subjects.reduce((sum, subject) => sum + (marks[subject].Total || 0), 0);
    marks.GrandTotal = grandTotal; 
    marks.TotalPossible = totalPossibleMarks;

    return marks;
    }

    function calculateGradeAndStatus(grandTotal, totalPossible, presentDays, totalDays) {
        let percentage = 0;
        if (totalPossible > 0) {
            percentage = (grandTotal / totalPossible) * 100;
        }
        
        let finalGrade = 'FAIL';
        if (percentage >= 75) {
            finalGrade = 'DISTINCTION';
        } else if (percentage >= 60) {
            finalGrade = 'FIRST DIVISION';
        } else if (percentage >= 45) {
            finalGrade = 'SECOND DIVISION';
        } else if (percentage >= 33) {
            finalGrade = 'THIRD DIVISION';
        } else {
            finalGrade = 'FAIL';
        }

        let attendancePercentage = 0;
        if (totalDays > 0) {
            attendancePercentage = (presentDays / totalDays) * 100;
        }
        
        let attendanceStatus = 'PASS';
        if (attendancePercentage < MIN_ATTENDANCE_PERCENT) {
            attendanceStatus = 'DETAINED';
        }

        return {
            percentage: percentage.toFixed(2),
            finalGrade,
            attendanceStatus
        };
    }


    function calculateTotalsAndUpdate() {
    const currentMarks = computeTotalsFromInputs();
    let grandTotal = 0;

    Object.keys(currentMarks).forEach(subject => {
        if (subject === 'GrandTotal' || subject === 'TotalPossible') return;
        const totalElement = qs(`${subject}-Total`);
        if (totalElement) {
        const subjectTotal = currentMarks[subject].Total;
        totalElement.textContent = subjectTotal;
        grandTotal += subjectTotal;
        }
    });

    if (qs('grandTotal')) qs('grandTotal').textContent = grandTotal;
    if (qs('gradeTotal')) qs('gradeTotal').textContent = grandTotal; 
    
    const presentDays = Number(document.getElementById('attendancePresent').value) || 0;
    const totalDays = Number(document.getElementById('attendanceTotal').value) || DEFAULT_ATT_TOTAL;
    
    const status = calculateGradeAndStatus(grandTotal, currentMarks.TotalPossible, presentDays, totalDays);
    
    if (qs('overallPercentage')) qs('overallPercentage').textContent = status.percentage + '%';
    if (qs('finalGrade')) qs('finalGrade').textContent = status.finalGrade;
    
    if (qs('attendanceStatus')) {
        qs('attendanceStatus').textContent = status.attendanceStatus;
        qs('attendanceStatus').classList.remove('text-green-600', 'text-red-600');
        if (status.attendanceStatus === 'PASS') {
            qs('attendanceStatus').classList.add('text-green-600');
        } else {
            qs('attendanceStatus').classList.add('text-red-600');
        }
    }
    
    updateChart(currentMarks);
    }


    /* ----------------- STUDENT SAVE & LOAD LOGIC (FIXED) ----------------- */

    function loadStudent(key) {
    const [cls, admission] = key.split('|');
    const student = state.studentsByClass[cls] && state.studentsByClass[cls][key];
    if (!student) return;
    
    state.selectedStudentKey = key;
    state.selectedClass = cls;

    updateCycleIndex(key);
    
    // FIXES NAME SWAP
    if (qs('admissionInput')) qs('admissionInput').value = student.admission || '';
    if (qs('studentNameInput')) qs('studentNameInput').value = student.studentName || ''; 
    if (qs('fatherNameInput')) qs('fatherNameInput').value = student.fatherName || '';
    
    if (qs('admissionNo')) qs('admissionNo').textContent = student.admission || '—';
    if (qs('classSection')) qs('classSection').textContent = displayClassLabel(student.cls);
    if (qs('studentName')) qs('studentName').textContent = student.studentName || '—'; 
    if (qs('fatherName')) qs('fatherName').textContent = student.fatherName || '—';

    if (qs('teachersRemark')) qs('teachersRemark').value = student.remarks || ''; 

    renderMarksTableForClass(student.cls); 
    
    if (student.marks) {
        Object.keys(student.marks).forEach(subject => {
        Object.keys(student.marks[subject]).forEach(term => {
            const input = qs(`${subject}-${term}`);
            if (input && TERMS.includes(term)) input.value = student.marks[subject][term];
        });
        });
    }
    
    if (student.coscholastic && qs('coscholasticBody')) {
        qs('coscholasticBody').innerHTML = `
        <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" value="${student.coscholastic.workHabits || ''}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
        <tr><td>Behavior</td><td><input type="text" id="behaviorInput" value="${student.coscholastic.behavior || ''}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
        `;
    }

    if (student.attendance) {
        document.querySelectorAll('#attendancePresent').forEach(el => el.value = student.attendance.Present || 0);
        document.querySelectorAll('#attendanceTotal').forEach(el => el.value = student.attendance.Total || DEFAULT_ATT_TOTAL);
    }
    
    attachMarksInputsListeners();
    calculateTotalsAndUpdate();
    }

    function saveCurrentStudent() {
        if (!state.selectedStudentKey) {
            const cls = qs('classSelect').value;
            const admission = qs('admissionInput').value.trim();
            if (cls && admission) {
                state.selectedStudentKey = `${cls}|${admission}`;
                state.studentsByClass[cls] = state.studentsByClass[cls] || {};
                state.studentsByClass[cls][state.selectedStudentKey] = { 
                    cls: cls, admission: admission, studentName: '', fatherName: '', marks: {}, coscholastic: {}, attendance: { Present: 0, Total: DEFAULT_ATT_TOTAL }, remarks: '' 
                };
            } else {
                return alert('Please load a student or enter Class and Admission No. to save.');
            }
        }

        let student = getCurrentStudent();
        if (!student) return;

        // NAME SWAP FIX CONFIRMED
        student.studentName = qs('studentNameInput').value.trim(); 
        student.fatherName = qs('fatherNameInput') ? qs('fatherNameInput').value.trim() : '';
        
        student.remarks = qs('teachersRemark') ? qs('teachersRemark').value.trim() : '';

        student.marks = computeTotalsFromInputs();
        
        student.coscholastic = {
            workHabits: qs('workHabitsInput') ? qs('workHabitsInput').value.trim() : '',
            behavior: qs('behaviorInput') ? qs('behaviorInput').value.trim() : ''
        };
        
        student.attendance.Present = Number(document.getElementById('attendancePresent').value) || 0;
        student.attendance.Total = Number(document.getElementById('attendanceTotal').value) || DEFAULT_ATT_TOTAL;

        state.studentsByClass[student.cls][state.selectedStudentKey] = student;
        
        calculateTotalsAndUpdate();
        persistStudents(); 
    }


    /* ----------------- CLOUD SAVE & LOAD (FIXED) ----------------- */

    async function saveToSheet(student) {
        if (!SHEET_API_URL || SHEET_API_URL.indexOf('/exec') === -1) {
            alert('SHEET_API_URL is missing or incorrect. Local save preserved.');
            return;
        }
        
        try {
            const url = SHEET_API_URL + '?action=save&data=' + encodeURIComponent(JSON.stringify(student));
            const res = await fetch(url, { method: 'POST' });
            const data = await res.json();
            
            if (data.status === 'ok') {
                loadAndShowAllData(); 
                alert('Saved to Google Sheets successfully.');
            } else {
                alert('Save to Google Sheets failed: ' + (data.error || data.message || JSON.stringify(data)));
            }
        } catch (err) {
            console.error('saveToSheet error', err);
            alert('Error connecting to Google Sheets. Check console/network.');
        }
    }

    async function loadFromSheet(cls, admission) {
        if (!SHEET_API_URL || SHEET_API_URL.indexOf('/exec') === -1) return;

        try {
            const url = `${SHEET_API_URL}?action=load&cls=${encodeURIComponent(cls)}&admission=${encodeURIComponent(admission)}`;
            
            const res = await fetch(url, { method: 'GET' });
            const data = await res.json();
            
            if (data.status === 'ok' && data.student) {
                const s = data.student;
                const key = `${s.cls}|${s.admission}`;
                state.studentsByClass[s.cls] = state.studentsByClass[s.cls] || {};
                state.studentsByClass[s.cls][key] = s;
                persistStudents();
                state.selectedStudentKey = key;
                loadStudent(key);
                alert('Loaded student from Google Sheets and saved a local backup.');
            } else {
                alert('Student not found in Google Sheets. You may add locally and then Save to push to cloud.');
            }
        } catch (err) {
            console.error('loadFromSheet error', err);
            alert('Error loading from Google Sheets. Check console and network.');
        }
    }

    async function loadAndShowAllData() {
        if (!SHEET_API_URL || SHEET_API_URL.indexOf('/exec') === -1) return;

        try {
            const url = `${SHEET_API_URL}?action=loadAll`;
            const res = await fetch(url, { method: 'GET' });
            const data = await res.json();

            if (data.status === 'ok' && data.students) {
                state.allStudentsData = data.students; 
                showDashboardTopper(state.allStudentsData);
                updateClassCycleList(); 
            } else {
                console.warn("Could not load all data for dashboard.", data.error);
            }
        } catch (err) {
            console.error("Error fetching all data for dashboard:", err);
        }
    }

    function showDashboardTopper(allStudents) {
        const cls = qs('dashboardClassSelect') ? qs('dashboardClassSelect').value : state.selectedClass;
        
        if (!cls || allStudents.length === 0) {
            if (qs('classTopperDashboard')) qs('classTopperDashboard').textContent='Class Topper: —'; 
            if (qs('schoolTopperDashboard')) qs('schoolTopperDashboard').textContent='School Topper: —'; 
            return;
        }

        const classStudents = allStudents.filter(s => s.cls === cls);
        
        let classTopper = { name:'—', total:-1 };
        let schoolTopper = { name:'—', total:-1 };

        const getTotalMarks = (s) => {
            let total = 0;
            if (s.marks && typeof s.marks === 'object') {
                Object.keys(s.marks).forEach(subject => {
                    if (subject !== 'GrandTotal' && s.marks[subject] && s.marks[subject].Total) {
                        total += s.marks[subject].Total;
                    }
                });
            }
            return total;
        };
        
        allStudents.forEach(s => {
            const studentName = s.studentName || 'N/A';
            const tot = getTotalMarks(s);
            if (tot > schoolTopper.total) { schoolTopper={name:studentName,total:tot}; }
        });
        
        classStudents.forEach(s => {
            const studentName = s.studentName || 'N/A';
            const tot = getTotalMarks(s);
            if (tot > classTopper.total) { classTopper={name:studentName,total:tot}; }
        });

        if (qs('classTopperDashboard')) qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} — ${classTopper.total > -1 ? classTopper.total : 0}`;
        if (qs('schoolTopperDashboard')) qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} — ${schoolTopper.total > -1 ? schoolTopper.total : 0}`;
    }


    /* ----------------- QUICK CYCLE NAVIGATION ----------------- */

    function quickCycle(direction) {
        if (state.classCycleList.length === 0) {
            return alert('No student list available for this class. Please wait for the initial cloud sync.');
        }

        let newIndex = state.cycleIndex + direction;

        if (newIndex >= 0 && newIndex < state.classCycleList.length) {
            saveCurrentStudent(); // Auto-save before switching
            
            state.cycleIndex = newIndex;
            const student = state.classCycleList[state.cycleIndex];
            const key = `${student.cls}|${student.admission}`;
            
            state.selectedStudentKey = key;
            loadStudent(key);
            
        } else if (newIndex < 0) {
            alert('You are at the first student in the list.');
        } else if (newIndex >= state.classCycleList.length) {
            alert('You have reached the end of the student list.');
        }
    }


    /* ----------------- CHART LOGIC ----------------- */

    function initChart() {
    const chartElement = qs('marksChart');
    if (!chartElement) return; 

    const ctx = chartElement.getContext('2d');
    state.chart = new Chart(ctx, {
        type: 'bar',
        data: {
        labels: [],
        datasets: [{
            label: 'Total Marks',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
            beginAtZero: true
            }
        }
        }
    });
    }

    function updateChart(marks) {
    if (!state.chart || !marks) return;

    const labels = [];
    const data = [];
    
    Object.keys(marks).filter(key => key !== 'GrandTotal' && key !== 'TotalPossible').forEach(subject => {
        labels.push(subject);
        data.push(marks[subject].Total || 0);
    });

    state.chart.data.labels = labels;
    state.chart.data.datasets[0].data = data;
    state.chart.update();
    }


    /* ----------------- BULK PRINT LOGIC ----------------- */

    async function bulkPrintReports() {
        const cls = qs('classSelect').value;
        if (!cls) return alert('Please select a class for bulk printing.');

        const studentsToPrint = state.classCycleList;

        if (studentsToPrint.length === 0) {
            alert('No student data loaded for this class. Please wait for the initial load from Google Sheet.');
            await loadAndShowAllData(); // Force reload
            const recheckedStudents = state.allStudentsData.filter(s => s.cls === cls);
            if (recheckedStudents.length === 0) {
                return alert(`No students found for class ${cls}.`);
            }
            studentsToPrint.push(...recheckedStudents);
        }

        if (!confirm(`Are you sure you want to print ${studentsToPrint.length} reports for class ${cls}?`)) {
            return;
        }

        const controlPanel = qs('controlPanel');
        const dashboard = qs('dashboard');
        if (controlPanel) controlPanel.classList.add('no-print');
        if (dashboard) dashboard.classList.add('no-print');

        for (const student of studentsToPrint) {
            const key = `${student.cls}|${student.admission}`;
            state.studentsByClass[student.cls] = state.studentsByClass[student.cls] || {};
            state.studentsByClass[student.cls][key] = student;
            state.selectedStudentKey = key;
            
            loadStudent(key); 

            await new Promise(r => setTimeout(r, 500)); 
            window.print();
        }

        if (controlPanel) controlPanel.classList.remove('no-print');
        if (dashboard) dashboard.classList.remove('no-print');
        
        state.selectedStudentKey = null;
        clearStudentView(cls);
    }


    /* ----------------- EVENT LISTENERS ----------------- */

    function attachMarksInputsListeners() {
    if (qs('marksTableBody')) qs('marksTableBody').querySelectorAll('input.marks-input').forEach(input => {
        input.removeEventListener('input', calculateTotalsAndUpdate); 
        input.addEventListener('input', calculateTotalsAndUpdate);
    });
    
    if(qs('attendancePresent')) qs('attendancePresent').addEventListener('input', calculateTotalsAndUpdate);
    if(qs('attendanceTotal')) qs('attendanceTotal').addEventListener('input', calculateTotalsAndUpdate);
    }

    function attachEventListeners() {
    // Class change listener
    if(qs('classSelect')) qs('classSelect').addEventListener('change', (e) => {
        state.selectedClass = e.target.value;
        clearStudentView(state.selectedClass);
        if (qs('dashboardClassSelect')) {
            qs('dashboardClassSelect').value = state.selectedClass;
            showDashboardTopper(state.allStudentsData);
        }
        updateClassCycleList();
    });
    
    // Dashboard class change listener
    if (qs('dashboardClassSelect')) {
        qs('dashboardClassSelect').addEventListener('change', (e) => {
            showDashboardTopper(state.allStudentsData);
        });
    }

    // Load button
    if(qs('loadStudentButton')) qs('loadStudentButton').addEventListener('click', () => {
        const cls = qs('classSelect').value;
        const admission = qs('admissionInput').value.trim();
        if (cls && admission) {
        loadFromSheet(cls, admission);
        } else {
        alert('Please select a Class and enter an Admission No.');
        }
    });

    // Save button
    if(qs('saveStudentButton')) qs('saveStudentButton').addEventListener('click', () => {
        saveCurrentStudent();
        const student = getCurrentStudent();
        if (student) {
        saveToSheet(student);
        }
    });
    
    // Quick Cycle Buttons
    if(qs('prevStudentButton')) qs('prevStudentButton').addEventListener('click', () => quickCycle(-1));
    if(qs('nextStudentButton')) qs('nextStudentButton').addEventListener('click', () => quickCycle(1));

    // Clear button
    if(qs('clearStudentButton')) qs('clearStudentButton').addEventListener('click', () => {
        state.selectedStudentKey = null;
        clearStudentView(state.selectedClass);
    });

    // Bulk Print button
    if(qs('bulkPrintButton')) qs('bulkPrintButton').addEventListener('click', bulkPrintReports);
    }


    /* ----------------- INITIALIZATION ----------------- */

    function init() {
    const stored = localStorage.getItem('ng_students');
    state.studentsByClass = stored ? JSON.parse(stored) : {};
    
    if (qs('classSection')) qs('classSection').textContent = displayClassLabel(state.selectedClass);
    
    attachEventListeners();
    initChart();
    updatePrintDate();
    renderMarksTableForClass(state.selectedClass);
    
    loadAndShowAllData(); 
    }

    window.addEventListener('load', init);
    </script>
</body>
</html>
