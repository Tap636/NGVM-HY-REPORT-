<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NANDI GURUKUL VIDYA MANDIR - Report Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* PRINT STYLES - A4, watermark, footer positions, etc. */
  @media print {
    body { -webkit-print-color-adjust: exact; }

    /* Keep shadows and border intact as requested (don't remove box-shadow) */
    .no-print { display: none !important; }

    /* Make page A4 sized for print */
    .page {
      width: 210mm;
      height: 297mm;
      margin: 0 auto;
      padding: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      background: white;
      position: relative; /* for watermark pseudo element */
      page-break-inside: avoid;
      -webkit-print-color-adjust: exact;
    }

    /* Watermark placed in center of printable area */
    .page::before{
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60%;
      height: 60%;
      background-image: url('watermark.png');
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      opacity: 0.07;
      pointer-events: none;
      z-index: 0;
    }
    /* Ensure page content renders above watermark */
    .page > * { position: relative; z-index: 1; }

    /* Print footer/footer elements positioning */
    #printFooter {
      width: 100%;
      position: fixed;
      bottom: 80px; /* leaves space for disclaimer & date */
      left: 0;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 10px;
    }

    /* Disclaimer and date positions */
    #disclaimer {
      width: 100%;
      text-align: center;
      font-size: 10px;
      position: fixed;
      bottom: 55px;
      left: 0;
      z-index: 1;
    }

    #printDate {
      text-align: center;
      font-size: 10px;
      position: fixed;
      bottom: 30px;
      left: 0;
      width: 100%;
      z-index: 1;
      border: none; /* ensure no lines */
    }

    /* Hide any signature lines for this new print footer (user requested no lines/borders) */
    #printFooter .signature-box { border: none !important; box-shadow: none !important; }
    #printFooter img { display: block; margin: 0 auto; }

    /* Hide old on-screen signature area positioning if it conflicts with print; keep it visible on screen */
    #signatures { display: none !important; }
  }

  /* SCREEN STYLES */
  .page { width: 900px; margin: 20px auto; padding: 18px; background: white; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
  .thin-border { border: 2px solid #0f172a; }
  .school-name { letter-spacing: 1px; }
  input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

  /* Original on-screen signatures (kept for non-print view) */
  #signatures {
    display: flex;
    justify-content: space-between;
    margin-top: 32px;
  }
  #signatures div {
    width: 40%;
    text-align: center;
  }
  #signatures div div {
    border-bottom: 1px solid black;
    margin-top: 40px;
    height: 48px;
  }

  /* Dashboard signature inputs removed from HTML; keep dashboard signs style in case used */
  #dashboardSigns {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 12px;
  }
  #dashboardSigns input {
    flex-grow: 1;
    padding: 4px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  /* Print footer (non-printed borders removed) */
  .signature-label { font-size: 0.875rem; text-align: center; }
  .signature-sign { font-weight: 600; text-align: center; margin-top: 8px; }

</style>
</head>
<body class="bg-gray-100 p-6">

<!-- DASHBOARD FOR TOPPERS (Hidden in print) -->
<div class="no-print mb-4 p-4 bg-yellow-100 border rounded">
  <h2 class="font-bold mb-2">School Dashboard (Topper Analysis)</h2>
  <label class="block text-sm text-gray-600 mb-1">Select Class to See Topper:</label>
  <select id="dashboardClassSelect" class="border rounded px-2 py-1 mb-2">
    <option value="">-- Select Class --</option>
    <option value="Nursery">Nursery</option>
    <option value="LKG">LKG</option>
    <option value="UKG">UKG</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
  </select>
  <p id="classTopperDashboard" class="font-semibold mt-1">Class Topper: —</p>
  <p id="schoolTopperDashboard" class="font-semibold mt-1">School Topper: —</p>

  <!-- NOTE: Class Teacher and Principal signature INPUTS REMOVED from dashboard as requested -->

  <button id="bulkDownloadBtn" class="mt-3 px-3 py-1 bg-indigo-600 text-white rounded">Download Classwise Report Cards</button>
</div>

<div class="page thin-border bg-white">
  <!-- Header -->
  <div class="flex items-center justify-between pb-4 border-b mb-4">
    <div class="flex items-center gap-4">
      <img src="logo.png" class="w-20 h-20 rounded-md" alt="School Logo" />
      <div>
        <h1 class="text-2xl font-extrabold school-name">NANDI GURUKUL VIDYA MANDIR</h1>
        <p class="text-sm">Academic Session: <strong>2025-26</strong></p>
        <p class="text-sm mt-1 text-gray-700 font-semibold">REPORT CARD - TERM 1</p>
      </div>
    </div>

    <div class="text-right no-print">
      <label class="block text-xs text-gray-600">Select Class</label>
      <select id="classSelect" class="border rounded px-2 py-1 bg-white">
        <option value="">-- Select Class --</option>
        <option value="Nursery">Nursery</option>
        <option value="LKG">LKG</option>
        <option value="UKG">UKG</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
      </select>
    </div>
  </div>

  <!-- Teacher Controls -->
  <div class="no-print mb-4">
    <div class="grid grid-cols-4 gap-4 items-end">
      <div>
        <label class="text-sm text-gray-600">Admission Number (Roll No.)</label>
        <input id="admissionInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="e.g. 138/Z18" />
      </div>
      <div>
        <label class="text-sm text-gray-600">Full Name</label>
        <input id="studentNameInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="Student full name" />
      </div>
      <div>
        <button id="addStudentBtn" class="px-3 py-1 bg-blue-600 text-white rounded w-full">Add / Update Student</button>
      </div>
      <div class="flex gap-2 justify-end">
        <button id="loadBtn" class="px-3 py-1 border rounded">Load</button>
        <button id="saveBtn" class="px-3 py-1 bg-green-600 text-white rounded">Save</button>
        <button id="printBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Print</button>
      </div>
    </div>
  </div>

  <!-- Student Info -->
  <div class="grid grid-cols-3 gap-4 mb-4">
    <div>
      <p class="text-sm text-gray-600">Name</p>
      <h2 id="studentName" class="font-semibold">—</h2>
    </div>
    <div>
      <p class="text-sm text-gray-600">Admission No.</p>
      <h2 id="admissionNo" class="font-semibold">—</h2>
    </div>
    <div>
      <p class="text-sm text-gray-600">Class/Section</p>
      <h2 id="classSection" class="font-semibold">—</h2>
    </div>
  </div>

  <!-- Attendance -->
  <div class="mb-4">
    <label class="text-sm text-gray-600 font-semibold">Attendance</label>
    <div class="flex gap-2 items-center">
      <input type="number" id="attendancePresent" min="0" max="130" placeholder="Days Present" class="border px-2 py-1 rounded w-32" />
      <input type="number" id="attendanceTotal" readonly value="130" class="border px-2 py-1 rounded w-40 bg-gray-200 text-center" title="Fixed total 130 working days" />
      <small class="text-xs text-gray-600 ml-2">* Total Working Days Fixed at 130</small>
    </div>
  </div>

  <!-- Marks Table -->
  <div class="overflow-x-auto">
    <table class="w-full border-collapse table-auto text-sm">
      <thead>
        <tr class="bg-green-100">
          <th class="border px-3 py-2 text-left">Subject</th>
          <th class="border px-3 py-2 text-center">Unit Test Written</th>
          <th class="border px-3 py-2 text-center">Unit Test Oral</th>
          <th class="border px-3 py-2 text-center">Half Yearly Written</th>
          <th class="border px-3 py-2 text-center">Half Yearly Oral</th>
          <th class="border px-3 py-2 text-center font-semibold">Term 1 Total</th>
        </tr>
      </thead>
      <tbody id="marksTableBody"></tbody>
      <tfoot>
        <tr class="bg-gray-50">
          <td class="border px-3 py-2 font-semibold text-right">Total</td>
          <td id="totalUTWritten" class="border px-3 py-2 font-semibold text-center">0</td>
          <td id="totalUTOral" class="border px-3 py-2 font-semibold text-center">0</td>
          <td id="totalHYWritten" class="border px-3 py-2 font-semibold text-center">0</td>
          <td id="totalHYOral" class="border px-3 py-2 font-semibold text-center">0</td>
          <td id="totalTerm" class="border px-3 py-2 font-semibold text-center">0</td>
        </tr>
        <tr class="bg-gray-50">
          <td colspan="5" class="border px-3 py-2 font-semibold text-right">Percentage</td>
          <td id="percentage" class="border px-3 py-2 font-semibold text-center">0%</td>
        </tr>
        <!-- REMOVED the previous Remark row below Percentage as requested -->
      </tfoot>
    </table>
  </div>

  <!-- Co-Scholastic & Attendance -->
  <div class="grid grid-cols-3 gap-4 mt-6">
    <div class="col-span-1">
      <div class="border p-4">
        <h3 class="font-semibold mb-2">Co-Scholastic Grades (Optional)</h3>
        <table class="w-full text-sm" id="coscholasticTable"><tbody id="coscholasticBody"><tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr><tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr></tbody></table>
      </div>

      <div class="border p-4 mt-4">
        <h3 class="font-semibold mb-2">Class Teacher's Remark</h3>
        <!-- Replaced editable textarea with an automatically-generated, non-editable display (keeps font size) -->
        <div id="teachersRemark" class="w-full p-2 text-sm border rounded bg-gray-50">Good effort. Keep improving.</div>
      </div>
    </div>

    <!-- Graph -->
    <div class="col-span-2">
      <div class="border p-4">
        <h3 class="font-semibold mb-2">Graphical Analysis (Term 1)</h3>
        <canvas id="marksChart" height="180"></canvas>
      </div>
    </div>
  </div>

  <!-- ON-SCREEN Signatures (kept for non-print view, unchanged except principal now shows image) -->
  <div id="signatures">
    <div>
      <p class="text-sm">Class Teacher: <span id="classTeacherPrintSign">—</span></p>
      <div></div>
    </div>
    <div>
      <!-- Replaced principal signature text with image above the label (keeps text size/alignment) -->
      <p class="text-sm">
        <img src="principal.png" alt="Principal Signature" style="max-height:48px; display:block; margin:0 auto 6px;" />
        Principal: <span id="principalPrintSign">—</span>
      </p>
      <div></div>
    </div>
  </div>

  <!-- PRINT FOOTER (for print) -->
  <div id="printFooter" class="no-print:hidden" style="display:none;">
    <!-- left: class teacher signature label & generated signature -->
    <div class="signature-box" style="width:33%; text-align:left;">
      <div class="signature-label">Class Teacher</div>
      <div class="signature-sign" id="printClassTeacherSign">—</div>
    </div>

    <!-- center: school seal placeholder -->
    <div class="signature-box" style="width:33%; text-align:center;">
      <div style="height:68px; display:flex; align-items:center; justify-content:center;">
        <!-- space reserved for school seal -->
        <div style="width:120px; height:60px; border:0; display:flex; align-items:center; justify-content:center;">
          <!-- intentionally left blank as placeholder for seal -->
          <span class="text-xs text-gray-500">School Seal</span>
        </div>
      </div>
    </div>

    <!-- right: principal signature image and label -->
    <div class="signature-box" style="width:33%; text-align:right;">
      <div style="display:flex; flex-direction:column; align-items:flex-end;">
        <img src="principal.png" alt="Principal" style="max-height:48px; margin-bottom:6px;" />
        <div class="signature-label">Principal</div>
      </div>
    </div>
  </div>

  <!-- Disclaimer (printed above date) -->
  <div id="disclaimer" class="hidden no-print:block" style="display:none;">
    This digitally generated report card is a bonafide record of student's academic performance
  </div>

  <!-- Print Date -->
  <div id="printDate" class="text-center text-xs text-gray-600">Date: —</div>
</div>

<!-- Clear Data Button -->
<div class="no-print text-center mt-6">
  <button id="clearDataBtn" class="px-3 py-1 bg-red-600 text-white rounded">Clear All Data (Requires Password)</button>
</div>

<script>
  // CONSTANTS & DEFINITIONS
  const nurseryToUKGSubjects = [
    { name: "English Written", maxUnitWritten: 15, maxUnitOral: 5, maxHalfWritten: 60, maxHalfOral: 20 },
    { name: "Hindi Written", maxUnitWritten: 15, maxUnitOral: 5, maxHalfWritten: 60, maxHalfOral: 20 },
    { name: "Maths Written", maxUnitWritten: 15, maxUnitOral: 5, maxHalfWritten: 60, maxHalfOral: 20 },
    { name: "Drawing", maxUnitWritten: 20, maxUnitOral: 0, maxHalfWritten: 80, maxHalfOral: 0 }
  ];
  const standardSubjects = [
    { name: "English" },
    { name: "Hindi" },
    { name: "Mathematics" },
    { name: "Science" },
    { name: "Social Science" }
  ];

  // STATE
  let state = {
    selectedClass: '',
    selectedStudentKey: '',
    studentsByClass: {},
    chart: null,
    classTeacherSign: '',
    principalSign: ''
  };

  // UTILITY
  const qs = id => document.getElementById(id);

  // INIT
  function init() {
    const stored = localStorage.getItem('ng_students');
    state.studentsByClass = stored ? JSON.parse(stored) : {};
    const clsTSign = localStorage.getItem('classTeacherSign');
    const prSign = localStorage.getItem('principalSign');
    if (clsTSign) {
      state.classTeacherSign = clsTSign;
      if (qs('classTeacherPrintSign')) qs('classTeacherPrintSign').textContent = clsTSign;
      if (qs('printClassTeacherSign')) qs('printClassTeacherSign').textContent = clsTSign;
      // dashboard input removed, so we don't set it
    }
    if (prSign) {
      state.principalSign = prSign;
      if (qs('principalPrintSign')) qs('principalPrintSign').textContent = prSign;
      // dashboard input removed, so we don't set it in an input
    }
    attachEventListeners();
    initChart();
    updatePrintDate();
    // Show print footer/disclaimer elements only for print; keep them hidden on screen but make accessible for print
    // We'll set style/display toggles when printing using CSS (they are fixed/positioned in @media print).
  }

  // EVENT LISTENERS
  function attachEventListeners() {
    qs('classSelect').addEventListener('change', e => {
      state.selectedClass = e.target.value;
      qs('classSection').textContent = state.selectedClass || '—';
      clearStudentView();
    });

    qs('addStudentBtn').addEventListener('click', () => {
      if (!state.selectedClass) return alert('Select Class first.');
      const admission = qs('admissionInput').value.trim();
      if (!admission) return alert('Enter Admission Number.');
      const name = qs('studentNameInput').value.trim();
      if (!name) return alert('Enter Student Name.');
      const key = `${state.selectedClass}|${admission}`;
      const newStudent = makeEmptyStudent(name, admission, state.selectedClass);
      state.studentsByClass[state.selectedClass] = state.studentsByClass[state.selectedClass] || {};
      // Preserve marks, attendance if student already exists:
      if(state.studentsByClass[state.selectedClass][key]){
        const existing = state.studentsByClass[state.selectedClass][key];
        newStudent.marks = existing.marks;
        newStudent.attendance = existing.attendance;
        newStudent.teachersRemark = existing.teachersRemark;
        newStudent.coscholastic = existing.coscholastic || [];
      }
      state.studentsByClass[state.selectedClass][key] = newStudent;
      persistStudents();
      state.selectedStudentKey = key;
      loadStudent(key);
      alert('Student added/updated. You may now enter marks and save.');
    });

    qs('loadBtn').addEventListener('click', () => {
      if (!state.selectedClass) return alert('Select Class first.');
      const admission = qs('admissionInput').value.trim();
      if (!admission) return alert('Enter Admission Number.');
      const key = `${state.selectedClass}|${admission}`;
      if (!state.studentsByClass[state.selectedClass] || !state.studentsByClass[state.selectedClass][key]) {
        return alert('Student not found. Add student first.');
      }
      state.selectedStudentKey = key;
      loadStudent(key);
    });

    qs('saveBtn').addEventListener('click', () => {
      if (!state.selectedStudentKey) return alert('Load or add a student first.');
      saveCurrentStudent();
      alert('Saved locally. Data ready for graph and topper analysis.');
    });

    qs('printBtn').addEventListener('click', () => {
      if(!state.selectedStudentKey) return alert('Load or add a student first.');
      calculateTotalsAndUpdate();
      // For print, ensure print footer/disclaimer are shown by temporarily toggling display for screen if needed.
      // CSS @media print handles final visibility; call print directly.
      window.print();
    });

    qs('dashboardClassSelect').addEventListener('change', showDashboardTopper);

    // The signature input fields on dashboard were removed. Only attach listeners if inputs exist (guarded).
    if (qs('classTeacherSign')) {
      qs('classTeacherSign').addEventListener('input', e => {
        state.classTeacherSign = e.target.value.trim();
        if (qs('classTeacherPrintSign')) qs('classTeacherPrintSign').textContent = state.classTeacherSign || '—';
        if (qs('printClassTeacherSign')) qs('printClassTeacherSign').textContent = state.classTeacherSign || '—';
        localStorage.setItem('classTeacherSign', state.classTeacherSign);
      });
    }

    if (qs('principalSign')) {
      qs('principalSign').addEventListener('input', e => {
        state.principalSign = e.target.value.trim();
        if (qs('principalPrintSign')) qs('principalPrintSign').textContent = state.principalSign || '—';
        localStorage.setItem('principalSign', state.principalSign);
      });
    }

    qs('bulkDownloadBtn').addEventListener('click', bulkDownloadReports);
    qs('clearDataBtn').addEventListener('click', clearAllData);
  }

  // STUDENT DATA CREATION
  function makeEmptyStudent(name, admission, cls) {
    const isNurseryToUKG = (cls === 'Nursery' || cls === 'LKG' || cls === 'UKG');
    const marks = [];
    if (isNurseryToUKG) {
      nurseryToUKGSubjects.forEach(s => {
        marks.push({
          name: s.name,
          utWritten: 0,
          utOral: 0,
          hyWritten: 0,
          hyOral: 0,
          total: 0,
          maxUTWritten: s.maxUnitWritten,
          maxUTOral: s.maxUnitOral,
          maxHYWritten: s.maxHalfWritten,
          maxHYOral: s.maxHalfOral,
        });
      });
    } else {
      standardSubjects.forEach(s => {
        marks.push({
          name: s.name,
          utWritten: 0,
          utOral: 0,
          hyWritten: 0,
          hyOral: 0,
          total: 0
        });
      });
    }
    return {
      name,
      admission,
      cls,
      marks,
      coscholastic: [],
      attendance: { present: 0, total: 130 },
      teachersRemark: 'Good effort. Keep improving.',
      remark: 'Needs Improvement'
    };
  }

  // SAVE / LOAD LOCAL STORAGE
  function persistStudents() {
    localStorage.setItem('ng_students', JSON.stringify(state.studentsByClass));
  }

  // CLEAR VIEW
  function clearStudentView() {
    state.selectedStudentKey = '';
    qs('studentName').textContent = '—';
    qs('admissionNo').textContent = '—';
    qs('studentNameInput').value = '';
    qs('admissionInput').value = '';
    qs('classSection').textContent = state.selectedClass || '—';
    qs('attendancePresent').value = '';
    qs('attendanceTotal').value = 130;
    // teachersRemark is now a non-editable display
    if (qs('teachersRemark')) qs('teachersRemark').textContent = 'Good effort. Keep improving.';
    qs('coscholasticBody').innerHTML = `
      <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
      <tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
    `;
    renderMarksTable([]);
    calculateTotalsAndUpdate();
  }

  // LOAD STUDENT
  function loadStudent(key) {
    const [cls, admission] = key.split('|');
    const student = state.studentsByClass[cls][key];
    if (!student) return alert('Data not found.');
    state.selectedStudentKey = key;
    state.selectedClass = cls;
    qs('classSelect').value = cls;
    qs('studentName').textContent = student.name;
    qs('admissionNo').textContent = student.admission || '—';
    qs('studentNameInput').value = student.name;
    qs('admissionInput').value = student.admission || '';
    qs('classSection').textContent = cls;
    qs('attendancePresent').value = student.attendance.present ?? '';
    qs('attendanceTotal').value = 130; // fixed total
    // teachersRemark is now auto-generated; display stored teachersRemark if exists (will be overwritten by calculation)
    if (qs('teachersRemark')) qs('teachersRemark').textContent = student.teachersRemark || 'Good effort. Keep improving.';

    // CoScholastic fields
    const workHabits = student.coscholastic?.workHabits || '';
    const behavior = student.coscholastic?.behavior || '';
    qs('coscholasticBody').innerHTML = `
      <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" value="${workHabits}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
      <tr><td>Behavior</td><td><input type="text" id="behaviorInput" value="${behavior}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
    `;

    renderMarksTable(student.marks);
    calculateTotalsAndUpdate();
  }

  // SAVE CURRENT STUDENT
  function saveCurrentStudent() {
    if(!state.selectedStudentKey) return;
    const student = getCurrentStudent();
    if(!student) return;
    // Save attendance and remarks
    student.attendance.present = Number(qs('attendancePresent').value) || 0;
    student.attendance.total = 130; // fixed

    // Do NOT save teachersRemark from a textarea - it's automatically generated. We will overwrite it in calculateTotals.
    // Save coscholastic
    const workHabits = qs('workHabitsInput')? qs('workHabitsInput').value.trim() : '';
    const behavior = qs('behaviorInput')? qs('behaviorInput').value.trim() : '';
    student.coscholastic = { workHabits, behavior };

    // Update marks data from inputs is handled in calculateTotalsAndUpdate (inputs are read there)
    persistStudents();
  }

  // GET CURRENT STUDENT
  function getCurrentStudent() {
    if(!state.selectedStudentKey) return null;
    const [cls] = state.selectedStudentKey.split('|');
    return state.studentsByClass[cls][state.selectedStudentKey];
  }

  // RENDER MARKS TABLE
  function renderMarksTable(marks=[]) {
    const tbody = qs('marksTableBody');
    tbody.innerHTML = '';

    if(marks.length === 0) return;

    const isNurUKG = (state.selectedClass === 'Nursery' || state.selectedClass === 'LKG' || state.selectedClass === 'UKG');
    marks.forEach((m, idx) => {
      const maxUTW = m.maxUTWritten ?? (isNurUKG ? 20 : 20);
      const maxUTO = m.maxUTOral ?? 0;
      const maxHYW = m.maxHYWritten ?? (isNurUKG ? 80 : 80);
      const maxHYO = m.maxHYOral ?? 0;

      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td class="border px-3 py-2">${m.name}</td>
          <td class="border px-3 py-2 text-center">
            <input data-idx="${idx}" data-field="utWritten" type="number" min="0" max="${maxUTW}" class="w-16 p-1 border rounded text-center" value="${m.utWritten || 0}" />
          </td>
          <td class="border px-3 py-2 text-center">
            <input data-idx="${idx}" data-field="utOral" type="number" min="0" max="${maxUTO}" class="w-16 p-1 border rounded text-center" value="${m.utOral || 0}" />
          </td>
          <td class="border px-3 py-2 text-center">
            <input data-idx="${idx}" data-field="hyWritten" type="number" min="0" max="${maxHYW}" class="w-16 p-1 border rounded text-center" value="${m.hyWritten || 0}" />
          </td>
          <td class="border px-3 py-2 text-center">
            <input data-idx="${idx}" data-field="hyOral" type="number" min="0" max="${maxHYO}" class="w-16 p-1 border rounded text-center" value="${m.hyOral || 0}" />
          </td>
          <td class="border px-3 py-2 font-semibold text-center">${m.total || 0}</td>
        </tr>
      `);
    });

    tbody.querySelectorAll('input').forEach(inp => {
      inp.addEventListener('input', () => {
        calculateTotalsAndUpdate();
      });
    });
  }

  // CALCULATE TOTALS & VALIDATE MARKS
  function calculateTotalsAndUpdate() {
    const student = getCurrentStudent();
    if (!student) return;

    const rows = qs('marksTableBody').querySelectorAll('tr');
    let totals = {
      utWritten: 0,
      utOral: 0,
      hyWritten: 0,
      hyOral: 0,
      termTotal: 0
    };

    rows.forEach((tr, idx) => {
      const utWrittenInp = tr.querySelector('input[data-field="utWritten"]');
      const utOralInp = tr.querySelector('input[data-field="utOral"]');
      const hyWrittenInp = tr.querySelector('input[data-field="hyWritten"]');
      const hyOralInp = tr.querySelector('input[data-field="hyOral"]');

      let utWritten = Number(utWrittenInp.value) || 0;
      let utOral = Number(utOralInp.value) || 0;
      let hyWritten = Number(hyWrittenInp.value) || 0;
      let hyOral = Number(hyOralInp.value) || 0;

      // Validation by max marks for Nur - UKG classes
      if (state.selectedClass === "Nursery" || state.selectedClass === "LKG" || state.selectedClass === "UKG") {
        const markObj = student.marks[idx];
        if (utWritten > markObj.maxUTWritten) utWritten = markObj.maxUTWritten;
        if (utOral > markObj.maxUTOral) utOral = markObj.maxUTOral;
        if (hyWritten > markObj.maxHYWritten) hyWritten = markObj.maxHYWritten;
        if (hyOral > markObj.maxHYOral) hyOral = markObj.maxHYOral;

        // Update inputs if exceeded max to reflect corrected value
        if (utWrittenInp.value != utWritten) utWrittenInp.value = utWritten;
        if (utOralInp.value != utOral) utOralInp.value = utOral;
        if (hyWrittenInp.value != hyWritten) hyWrittenInp.value = hyWritten;
        if (hyOralInp.value != hyOral) hyOralInp.value = hyOral;
      }

      // Calculate total for this subject
      const total = utWritten + utOral + hyWritten + hyOral;

      // Update UI cell and state
      tr.children[5].textContent = total;
      student.marks[idx].utWritten = utWritten;
      student.marks[idx].utOral = utOral;
      student.marks[idx].hyWritten = hyWritten;
      student.marks[idx].hyOral = hyOral;
      student.marks[idx].total = total;

      totals.utWritten += utWritten;
      totals.utOral += utOral;
      totals.hyWritten += hyWritten;
      totals.hyOral += hyOral;
      totals.termTotal += total;
    });

    // Update totals in footer
    qs('totalUTWritten').textContent = totals.utWritten;
    qs('totalUTOral').textContent = totals.utOral;
    qs('totalHYWritten').textContent = totals.hyWritten;
    qs('totalHYOral').textContent = totals.hyOral;
    qs('totalTerm').textContent = totals.termTotal;

    // Percentage calculation assuming max total per subject = 100
    const subjectsCount = student.marks.length || 1;
    const percentage = ((totals.termTotal / (subjectsCount * 100)) * 100).toFixed(2);
    qs('percentage').textContent = `${percentage}%`;

    // Assign Remark based on % ranges (this becomes the Class Teacher's remark display)
    let remarkText = 'Needs Improvement';
    if (percentage >= 90) remarkText = 'Outstanding';
    else if (percentage >= 80) remarkText = 'Excellent';
    else if (percentage >= 70) remarkText = 'Very Good';
    else if (percentage >= 60) remarkText = 'Good';
    else if (percentage >= 50) remarkText = 'Average';

    // Set the automated remark into the Class Teacher's remark display
    if (qs('teachersRemark')) qs('teachersRemark').textContent = remarkText;
    // keep both student.remark and student.teachersRemark in state for export
    student.remark = remarkText;
    student.teachersRemark = remarkText;

    // Update print footer class teacher signature text if used
    if (qs('printClassTeacherSign')) qs('printClassTeacherSign').textContent = state.classTeacherSign || (student.teachersRemark || '—');

    updateChart(student);
  }

  // CHART INIT & UPDATE
  function initChart() {
    const ctx = qs('marksChart').getContext('2d');
    state.chart = new Chart(ctx, {
      type: 'bar',
      data: { labels: [], datasets: [] },
      options: { responsive: true, plugins: { legend: { display: true } } }
    });
  }

  function updateChart(student) {
    const labels = student.marks.map(m => m.name);
    const data = student.marks.map(m => m.total);
    const classData = labels.map(label => getClassAverage(student.cls, label));
    const highestData = labels.map(label => getClassHighest(student.cls, label));
    state.chart.data.labels = labels;
    state.chart.data.datasets = [
      { label: 'Obtained', data, backgroundColor: 'rgba(59,130,246,0.7)' },
      { label: 'Class Avg', data: classData, backgroundColor: 'rgba(16,185,129,0.7)' },
      { label: 'Highest', data: highestData, backgroundColor: 'rgba(244,63,94,0.7)' }
    ];
    state.chart.update();
  }

  // CLASS AVG & HIGHEST
  function getClassAverage(cls, subjectName) {
    if (!state.studentsByClass[cls]) return 0;
    const vals = Object.values(state.studentsByClass[cls]).map(s => {
      const sub = s.marks.find(m => m.name === subjectName);
      return sub ? sub.total : 0;
    });
    if (!vals.length) return 0;
    return Math.round(vals.reduce((a, b) => a + b, 0) / vals.length);
  }

  function getClassHighest(cls, subjectName) {
    if (!state.studentsByClass[cls]) return 0;
    const vals = Object.values(state.studentsByClass[cls]).map(s => {
      const sub = s.marks.find(m => m.name === subjectName);
      return sub ? sub.total : 0;
    });
    if (!vals.length) return 0;
    return Math.max(...vals);
  }

  // DASHBOARD TOPPER
  function showDashboardTopper() {
    const cls = qs('dashboardClassSelect').value;
    if (!cls) {
      qs('classTopperDashboard').textContent = 'Class Topper: —';
      qs('schoolTopperDashboard').textContent = 'School Topper: —';
      return;
    }
    let classTopper = { name: '—', total: 0 };
    let schoolTopper = { name: '—', total: 0 };
    Object.keys(state.studentsByClass[cls] || {}).forEach(k => {
      const s = state.studentsByClass[cls][k];
      const t = s.marks.reduce((a, b) => a + b.total, 0);
      if (t > classTopper.total) classTopper = { name: s.name, total: t };
    });
    Object.values(state.studentsByClass).forEach(clsObj => {
      Object.values(clsObj).forEach(s => {
        const t = s.marks.reduce((a, b) => a + b.total, 0);
        if (t > schoolTopper.total) schoolTopper = { name: s.name, total: t };
      });
    });
    qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} — ${classTopper.total}`;
    qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} — ${schoolTopper.total}`;
  }

  // BULK DOWNLOAD
  function bulkDownloadReports() {
    const cls = qs('dashboardClassSelect').value || state.selectedClass;
    if (!cls) return alert('Select a class for bulk download.');
    if (!state.studentsByClass[cls] || !Object.keys(state.studentsByClass[cls]).length) {
      return alert('No students found in this class.');
    }
    const arr = [];
    Object.keys(state.studentsByClass[cls]).forEach(key => {
      const s = state.studentsByClass[cls][key];
      let report = `Report Card - ${cls} - ${s.name}\nAdmission No: ${s.admission}\n\nSubjects:\n`;
      s.marks.forEach(m => {
        report += `${m.name}: Unit Test Written ${m.utWritten || 0}, Unit Test Oral ${m.utOral || 0}, Half Yearly Written ${m.hyWritten || 0}, Half Yearly Oral ${m.hyOral || 0}, Total: ${m.total || 0}\n`;
      });
      report += `\nTotals: UT Written ${s.marks.reduce((a,b)=>a+(b.utWritten||0),0)}, UT Oral ${s.marks.reduce((a,b)=>a+(b.utOral||0),0)}, HY Written ${s.marks.reduce((a,b)=>a+(b.hyWritten||0),0)}, HY Oral ${s.marks.reduce((a,b)=>a+(b.hyOral||0),0)}, Overall ${s.marks.reduce((a,b)=>a+(b.total||0),0)}\n`;
      report += `Percentage: ${((s.marks.reduce((a,b)=>a+(b.total||0),0)/(s.marks.length*100))*100).toFixed(2)}%\nRemark: ${s.remark || '—'}\n\nAttendance: ${s.attendance.present || 0} / 130\nRemark by Teacher: ${s.teachersRemark || '—'}\n\nClass Teacher: ${state.classTeacherSign || '—'}\nPrincipal: ${state.principalSign || '—'}\n\n--------------------------------------------------\n\n`;
      arr.push(report);
    });
    const blob = new Blob(arr, { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ReportCards_${cls}_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // DATA CLEAR
  function clearAllData() {
    const password = prompt('Enter password to clear ALL data:');
    if (password !== '1234') return alert('Incorrect password!');
    if (!confirm('Are you sure? This will remove all saved data!')) return;

    localStorage.clear();
    state.studentsByClass = {};
    state.selectedStudentKey = '';
    clearStudentView();
    alert('All data cleared successfully.');
  }

  // UPDATE PRINT DATE
  function updatePrintDate() {
    const printDate = new Date().toLocaleDateString();
    qs('printDate').textContent = 'Date: ' + printDate;
  }

  // INIT CALL
  init();
</script>

</body>
</html>
