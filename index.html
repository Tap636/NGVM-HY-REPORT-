<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NANDI GURUKUL VIDYA MANDIR - Report Card</title>

<!-- Added patternomaly and xlsx (SheetJS) back for graph and Excel download -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/patternomaly@1.0.4/dist/patternomaly.min.js"></script>
<!-- SheetJS for Excel download -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* -------- PRINT STYLES - Optimized for B&W printing -------- */
@media print {
body { -webkit-print-color-adjust: exact; }
.no-print { display: none !important; }
.screen-only { display: none !important; }
.print-only { display: block !important; } 

/* AGGRESSIVE PADDING REDUCTION (Fixes 2-page issue) */
.page {
  width: 210mm;
  min-height: 297mm; 
  margin: 0 auto;
  padding: 5mm 12.7mm; /* Reduced padding */
  box-shadow: none; /* No shadow on print */
  background: white;
  position: relative;
  page-break-inside: avoid; 
  -webkit-print-color-adjust: exact;
  display: flex; 
  flex-direction: column;
}

/* Watermark centered: Opacity reduced for typical watermark effect */
.page::before{
content: "";
position: absolute; 
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 60%;
height: 60%;
/* Placeholder for actual watermark image */
/* background-image: url('watermark.png'); */ 
background-repeat: no-repeat;
background-position: center;
background-size: contain;
opacity: 0.1; 
pointer-events: none;
z-index: 0;
}

/* Ensure all elements print in black ink */
.school-name-color, .muted, #finalFooter, #disclaimer, #printDate, table, th, td { 
    color: black !important;
}
.bg-green-100 { 
    background-color: #f0fdf4 !important; /* Very light green for headers */
}
.bg-gray-50 {
    background-color: #f9fafb !important; /* Very light gray for footers */
}

/* Footer alignment fixes */
.page-footer-area {
  margin-top: auto; 
  width: 100%;
  padding-top: 3mm; 
}
#finalFooter {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  z-index: 2;
}
#finalFooter .col { 
    width: 33%; 
    box-sizing: border-box; 
    text-align: center; 
    display: flex; 
    flex-direction: column;
    justify-content: flex-end; 
    min-height: 80px; 
}
.principal-img {
    height: 48px; 
    display: block; 
    margin: 0 auto 6px; 
    object-fit: contain;
}
table { page-break-inside:relative; }
tr { page-break-inside:avoid; page-break-after:relative; }
}

/* ---------------- SCREEN ---------------- */
body { background: #ffffff; }
.print-only { display: none; } 
.page { width: 900px; margin: 20px auto; padding: 18px; background: white; box-shadow: 0 6px 18px rgba(0,0,0,0.08); border: 2px solid #0f172a;
}
.school-name-color { color: #4f46e5; } 
.school-name { letter-spacing: 1px; }
input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.muted { color:#6b7280; font-size:0.95rem; } 
.signature-label { font-size:0.95rem; text-align:center; }
table input[type="number"] { text-align:center; }
.small-btn { padding:6px 8px; border-radius:6px; font-size:0.9rem; }
</style>
</head>
<body class="bg-gray-100 p-6">
<div class="no-print mb-4 p-4 bg-yellow-100 border rounded">
<h2 class="font-bold mb-2">School Dashboard (Controls)</h2>
<!-- Download button and Print Date Input (The 'tab' feature you requested) -->
<div class="mt-3 flex gap-4 items-center">
    <button id="bulkDownloadBtn" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded small-btn shadow-md">
        Download Report Cards (Excel)
    </button>
    
    <label class="block text-sm text-gray-600">Set Print Date</label>
    <input id="printDateInput" type="date" class="border rounded px-2 py-1 small-btn shadow-sm" />
</div>
<div class="mt-2 text-xs text-gray-500">
    Select a class in the dropdown below to enable the Topper Analysis and Bulk Download features.
</div>
<div class="mt-3">
    <label class="block text-sm text-gray-600 mb-1">Class Topper Analysis (Optional):</label>
    <select id="dashboardClassSelect" class="border rounded px-2 py-1 mb-2 small-btn">
        <option value="">-- Select Class for Topper --</option>
        <option value="Nursery">Nursery</option>
        <option value="LKG">LKG</option>
        <option value="UKG">UKG</option>
        <option value="1">I</option>
        <option value="2">II</option>
        <option value="3">III</option>
        <option value="4">IV</option>
        <option value="5">V</option>
        <option value="6">VI</option>
        <option value="7">VII</option>
        <option value="8">VIII</option>
        <option value="9">IX</option>
    </select>
    <p id="classTopperDashboard" class="font-semibold mt-1">Class Topper: —</p>
    <p id="schoolTopperDashboard" class="font-semibold mt-1">School Topper: —</p>
</div>
</div>
<div class="page">
  <div class="page-content-wrapper">
    <div class="pb-6 border-b mb-6 relative">
        <img src="https://placehold.co/100x100/4f46e5/ffffff?text=LOGO" class="w-24 h-24 rounded-md absolute top-0 left-3" alt="School Logo" />

        <div class="text-center ml-[112px] mr-[112px]"> 
            <h1 class="text-2xl font-extrabold school-name school-name-color">NANDI GURUKUL VIDYA MANDIR</h1>
            <p class="text-sm">Academic Session: <strong>2025-26</strong></p>
            <p class="text-sm mt-1 text-gray-700 font-semibold">REPORT CARD - HALF YEARLY EXAMINATION</p>
        </div>

        <div class="text-right no-print absolute top-0 right-0">
            <label class="block text-xs text-gray-600">Select Class</label>
            <select id="classSelect" class="border rounded px-2 py-1 bg-white small-btn">
            <option value="">-- Select Class --</option>
            <option value="Nursery">Nursery</option>
            <option value="LKG">LKG</option>
            <option value="UKG">UKG</option>
            <option value="1">I</option>
            <option value="2">II</option>
            <option value="3">III</option>
            <option value="4">IV</option>
            <option value="5">V</option>
            <option value="6">VI</option>
            <option value="7">VII</option>
            <option value="8">VIII</option>
            <option value="9">IX</option>
            </select>
        </div>
    </div>
    <div class="no-print mb-4">
    <div class="grid grid-cols-5 gap-4 items-end">
    <div>
    <label class="text-sm text-gray-600">Admission Number</label>
    <input id="admissionInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="e.g. 138/Z18" />
    </div>
    <div>
    <label class="text-sm text-gray-600">Student Name</label>
    <input id="studentNameInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="Student full name" />
    </div>
    <div>
    <label class="text-sm text-gray-600">Father's Name</label>
    <input id="fatherNameInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="Father's full name" />
    </div>
    <div class="col-span-2 flex gap-2 justify-end">
    <button id="loadBtn" class="px-3 py-1 border rounded small-btn hover:bg-gray-100">Load</button>
    <button id="saveBtn" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded small-btn">Save</button>
    <button id="addStudentBtn" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded small-btn">Add / Update</button>
    <button id="printBtn" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded small-btn">Print Report Card</button>
    </div>
    </div>
    </div>
    <div class="grid grid-cols-4 gap-4 mb-4 mt-4">
    <div>
    <p class="text-sm text-gray-600">Admission No.</p>
    <h2 id="admissionNo" class="font-semibold">—</h2>
    </div>
    <div>
    <p class="text-sm text-gray-600">Name</p>
    <h2 id="studentName" class="font-semibold">—</h2>
    </div>
    <div>
    <p class="text-sm text-gray-600">Father's Name</p>
    <h2 id="fatherName" class="font-semibold">—</h2>
    </div>
    <div>
    <p class="text-sm text-gray-600">Class/Section</p>
    <h2 id="classSection" class="font-semibold">—</h2>
    </div>
    </div>
    
    <div class="mb-4 screen-only">
    <label class="text-sm text-gray-600 font-semibold">Attendance</label>
    <div class="flex gap-2 items-center">
    <input type="number" id="attendancePresent" min="0" max="130" placeholder="Days Present" class="border px-2 py-1 rounded w-32" />
    <input type="number" id="attendanceTotal" readonly value="130" class="border px-2 py-1 rounded w-40 bg-gray-200 text-center" title="Total working days" />
    </div>
    </div>
    
    <div class="overflow-x-auto">
    <table id="marksTable" class="w-full border-collapse table-auto text-sm">
    <thead id="marksTableHead"></thead>
    <tbody id="marksTableBody"></tbody>
    <tfoot id="marksTableFoot"></tfoot>
    </table>
    </div>
    <div class="grid grid-cols-3 gap-4 mt-6"> 
    <div class="col-span-1">
    <div class="border p-4 rounded-lg shadow-sm">
    <h3 class="font-semibold mb-2">Co-Scholastic Grades</h3>
    <table class="w-full text-sm" id="coscholasticTable">
    <tbody id="coscholasticBody">
    <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
    <tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
    </tbody>
    </table>
    </div>
    
    <div class="border p-4 mt-4 rounded-lg shadow-sm">
    <h3 class="font-semibold mb-2">Class Teacher's Remark</h3>
    <div id="teachersRemark" class="w-full p-2 text-sm border rounded bg-gray-50">Good effort. Keep improving.</div>
    </div>
    
    <div class="border p-4 mt-4 print-only rounded-lg shadow-sm">
        <h3 class="font-semibold mb-2">Attendance</h3>
        <div class="flex gap-2 items-center">
            <!-- These values are populated from the state upon printing -->
            <input type="number" id="attendancePresent" min="0" max="130" placeholder="Days Present" class="border px-2 py-1 rounded w-32" />
            <input type="number" id="attendanceTotal" readonly value="130" class="border px-2 py-1 rounded w-40 bg-gray-200 text-center" title="Total working days" />
        </div>
    </div>
    
    </div>
    <div class="col-span-2">
    <div class="border p-4 rounded-lg shadow-sm">
    <h3 class="font-semibold mb-2">Graphical Analysis (Half Yearly)</h3>
    <!-- Height fixed for better rendering -->
    <canvas id="marksChart" height="250"></canvas>
    </div>
    </div>
    </div>
  </div>
  <div class="page-footer-area">
    <div id="finalFooter" style="display:flex; justify-content:space-between; align-items:flex-start;">
    <div class="col left" style="text-align:left;">
    <div class="signature-space"></div>
    <div class="signature-label">Class Teacher</div>
    </div>
    <div class="col" style="text-align:center;">
    <div class="signature-space"></div>
    <div class="signature-label">School Seal</div>
    </div>
    <div class="col right" style="text-align:right;">
    <!-- Placeholder for Principal Signature -->
    <img src="https://placehold.co/100x48/f9fafb/374151?text=SIGNATURE" alt="Principal" class="principal-img" />
    <div class="signature-label">Principal</div>
    </div>
    </div>
    <div id="disclaimer" class="muted text-center">
    *This digitally generated report card is a bonafide record of student's academic performance.
    </div>
    <!-- Print Date Display -->
    <div id="printDate" class="text-center muted">Date: —</div>
  </div>
  </div>
<div class="no-print text-center mt-6">
<button id="clearDataBtn" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded small-btn">Clear All Data (Requires Password)</button>
</div>
<script>
/* ---------------- CONFIG & SUBJECTS ---------------- */
const SUBJECTS_NUR_TO_UKG = [
{ name: "English", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
{ name: "Hindi", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
{ name: "Maths", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
// Drawing: special maxima
{ name: "Drawing", utMax: 20, utOralMax: 0, hyMax: 80, hyOralMax: 0 }
];
const SUBJECTS_1_TO_5 = ["Hindi", "English", "Mathematics", "Computer", "E.V.S.", "Drawing", "G.K."];
const SUBJECTS_6_TO_8 = ["Hindi", "English", "Mathematics", "Computer", "Drawing", "G.K.", "Science", "S.S.T."];
const SUBJECTS_9 = ["Hindi", "English", "Mathematics", "Science", "S.S.T.", "Drawing"];
const DEFAULT_ATT_TOTAL = 130;

/* ---------------- STATE ---------------- */
let state = {
selectedClass: '',
selectedStudentKey: '',
studentsByClass: {},
chart: null
};

/* ---------------- UTIL ---------------- */
const qs = id => document.getElementById(id);

/* ---------------- INIT ---------------- */
function init() {
const stored = localStorage.getItem('ng_students');
state.studentsByClass = stored ? JSON.parse(stored) : {};
attachEventListeners();
initChart();
// Restore and display the print date on load
const storedDate = localStorage.getItem('ng_print_date');
if (storedDate && qs('printDateInput')) {
  qs('printDateInput').value = storedDate;
}
updatePrintDate();
renderMarksTableForClass(''); // initial empty
}
init();

/* ---------------- MAP & HELPERS ---------------- */
function interpretClassValue(val) {
if (!val) return '';
const romanMap = { "I":"1","II":"2","III":"3","IV":"4","V":"5","VI":"6","VII":"7","VIII":"8","IX":"9" };
if (romanMap[val]) return romanMap[val];
return val;
}
function displayClassLabel(cls) {
if (!cls) return '—';
if (cls === 'Nursery' || cls === 'LKG' || cls === 'UKG') return cls;
const map = {1:'I',2:'II',3:'III',4:'IV',5:'V',6:'VI',7:'VII',8:'VIII',9:'IX'};
return map[Number(cls)] || cls;
}

/* ---------------- EVENT LISTENERS ---------------- */
function attachEventListeners() {
qs('classSelect').addEventListener('change', e => {
const val = interpretClassValue(e.target.value);
state.selectedClass = val;
qs('classSection').textContent = displayClassLabel(val);
clearStudentView();
renderMarksTableForClass(val);
});
qs('addStudentBtn').addEventListener('click', () => {
if (!state.selectedClass) return alert('Select Class first.');
const admission = qs('admissionInput').value.trim();
if (!admission) return alert('Enter Admission Number.');
const name = qs('studentNameInput').value.trim();
if (!name) return alert('Enter Student Name.');
const fatherName = qs('fatherNameInput').value.trim();
const key = `${state.selectedClass}|${admission}`;
state.studentsByClass[state.selectedClass] = state.studentsByClass[state.selectedClass] || {};
const student = makeEmptyStudent(name, admission, state.selectedClass, fatherName);
if (state.studentsByClass[state.selectedClass][key]) {
// preserve existing marks
const ex = state.studentsByClass[state.selectedClass][key];
student.marks = ex.marks || student.marks;
student.attendance = ex.attendance || ex.attendance;
student.coscholastic = ex.coscholastic || student.coscholastic;
student.teachersRemark = ex.teachersRemark || student.teachersRemark;
student.fatherName = fatherName || ex.fatherName || student.fatherName;
}
state.studentsByClass[state.selectedClass][key] = student;
persistStudents();
state.selectedStudentKey = key;
loadStudent(key);
alert('Student added/updated. You may now enter marks and save.');
});
qs('loadBtn').addEventListener('click', () => {
if (!state.selectedClass) return alert('Select Class first.');
const admission = qs('admissionInput').value.trim();
if (!admission) return alert('Enter Admission Number.');
const key = `${state.selectedClass}|${admission}`;
if (!state.studentsByClass[state.selectedClass] || !state.studentsByClass[state.selectedClass][key]) {
return alert('Student not found. Add student first.');
}
state.selectedStudentKey = key;
loadStudent(key);
});
qs('saveBtn').addEventListener('click', () => {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
saveCurrentStudent();
alert('Saved locally.');
});

// **PRINT BUTTON LOGIC**
qs('printBtn').addEventListener('click', () => {
    if (!state.selectedStudentKey) return alert('Load or add a student first.');
    
    // 1. Persist the print date from the input field
    if (qs('printDateInput') && qs('printDateInput').value) {
      localStorage.setItem('ng_print_date', qs('printDateInput').value);
    }
    updatePrintDate(); // Update the displayed date on the report card
    calculateTotalsAndUpdate();
    
    // 2. Trigger Print
    window.print();
});

qs('dashboardClassSelect').addEventListener('change', showDashboardTopper);
qs('bulkDownloadBtn').addEventListener('click', bulkDownloadReports);
qs('clearDataBtn').addEventListener('click', clearAllData);

// **PRINT DATE INPUT LISTENER (Persists on change)**
if (qs('printDateInput')) {
  qs('printDateInput').addEventListener('change', () => {
    const v = qs('printDateInput').value;
    if (v) localStorage.setItem('ng_print_date', v);
    else localStorage.removeItem('ng_print_date');
    updatePrintDate();
  });
}
}

/* ---------------- PERSISTENCE ---------------- */
function persistStudents() {
localStorage.setItem('ng_students', JSON.stringify(state.studentsByClass));
}

/* ---------------- STUDENT FACTORY ---------------- */
function makeEmptyStudent(name, admission, cls, fatherName='') {
const marks = [];
if (isNurToUkg(cls)) {
SUBJECTS_NUR_TO_UKG.forEach(s => {
marks.push({
name: s.name,
ut: 0,
utOral: s.utOralMax || 0,
hy: 0,
hyOral: s.hyOralMax || 0,
total: 0,
max: { ut: s.utMax, utOral: s.utOralMax, hy: s.hyMax, hyOral: s.hyOralMax }
});
});
} else {
const subs = subjectsForClass(cls);
subs.forEach(s => {
if (s === 'G.K.') {
marks.push({ name: s, grade: 'A', isGrade: true });
} else {
marks.push({ name: s, ut: 0, hy: 0, total: 0, isGrade: false, max: { ut: 20, hy: 80 } });
}
});
}
return {
name, admission, cls, fatherName, marks,
coscholastic: {},
attendance: { present: 0, total: DEFAULT_ATT_TOTAL },
teachersRemark: 'Good effort. Keep improving.',
remark: ''
};
}
function isNurToUkg(cls) {
return cls === 'Nursery' || cls === 'LKG' || cls === 'UKG';
}
function subjectsForClass(cls) {
const n = Number(cls);
if (n >=1 && n <=5) return SUBJECTS_1_TO_5.slice();
if (n >=6 && n <=8) return SUBJECTS_6_TO_8.slice();
if (n === 9) return SUBJECTS_9.slice();
return [];
}

/* ---------------- RENDER MARKS TABLE PER CLASS ---------------- */
function renderMarksTableForClass(cls) {
// ... (Render Marks Table logic remains the same) ...
const thead = qs('marksTableHead');
const tbody = qs('marksTableBody');
const tfoot = qs('marksTableFoot');
tbody.innerHTML = '';
tfoot.innerHTML = '';
if (!cls) {
thead.innerHTML = `<tr class="bg-green-100"><th class="border px-3 py-2 text-left">Subject</th><th class="border px-3 py-2 text-center">Unit Test</th><th class="border px-3 py-2 text-center">Half Yearly</th><th class="border px-3 py-2 text-center">Overall Performance</th></tr>`;
return;
}
if (isNurToUkg(cls)) {
thead.innerHTML = `
<tr class="bg-green-100">
<th class="border px-3 py-2 text-left">Subject</th>
<th class="border px-3 py-2 text-center">Unit Test Written</th>
<th class="border px-3 py-2 text-center">Unit Test Oral</th>
<th class="border px-3 py-2 text-center">Half Yearly Written</th>
<th class="border px-3 py-2 text-center">Half Yearly Oral</th>
<th class="border px-3 py-2 text-center font-semibold">Overall Performance</th>
</tr>
`;
const student = getCurrentStudent();
const rows = student ? student.marks : SUBJECTS_NUR_TO_UKG.map(s => ({ name: s.name }));
rows.forEach((m, idx) => {
const max = (m.max || SUBJECTS_NUR_TO_UKG[idx]);
const utMax = max.ut;
const utOralMax = max.utOral;
const hyMax = max.hy;
const hyOralMax = max.hyOral;
const utVal = (student && student.marks[idx]) ? (student.marks[idx].ut || 0) : 0;
const utOralVal = (student && student.marks[idx]) ? (student.marks[idx].utOral || 0) : 0;
const hyVal = (student && student.marks[idx]) ? (student.marks[idx].hy || 0) : 0;
const hyOralVal = (student && student.marks[idx]) ? (student.marks[idx].hyOral || 0) : 0;
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${m.name}</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="ut" type="number" min="0" max="${utMax}" value="${utVal}" class="w-16 p-1 border rounded" />
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="utOral" type="number" min="0" max="${utOralMax}" value="${utOralVal}" class="w-16 p-1 border rounded" ${utOralMax===0?'disabled':''} />
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="hy" type="number" min="0" max="${hyMax}" value="${hyVal}" class="w-16 p-1 border rounded" />
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="hyOral" type="number" min="0" max="${hyOralMax}" value="${hyOralVal}" class="w-16 p-1 border rounded" ${hyOralMax===0?'disabled':''} />
</td>
<td class="border px-3 py-2 font-semibold text-center">${student ? (student.marks[idx].total || 0) : 0}</td>
</tr>
`);
});
tfoot.innerHTML = `
<tr class="bg-gray-50">
<td class="border px-3 py-2 font-semibold text-right">Total</td>
<td id="totalUT" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalUTOral" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalHY" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalHYOral" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalOverall" class="border px-3 py-2 font-semibold text-center">0</td>
</tr>
<tr class="bg-gray-50">
<td colspan="5" class="border px-3 py-2 font-semibold text-right">Percentage</td>
<td id="percentage" class="border px-3 py-2 font-semibold text-center">0%</td>
</tr>
`;
} else {
// Classes 1-9: no oral columns, UT=20 HY=80; G.K. grade
thead.innerHTML = `
<tr class="bg-green-100">
<th class="border px-3 py-2 text-left">Subject</th>
<th class="border px-3 py-2 text-center">Unit Test - 20</th>
<th class="border px-3 py-2 text-center">Half Yearly - 80</th>
<th class="border px-3 py-2 text-center font-semibold">Overall Performance</th>
</tr>
`;
const subs = subjectsForClass(cls);
const student = getCurrentStudent();
subs.forEach((s, idx) => {
const mark = student ? student.marks[idx] : null;
if (s === 'G.K.') {
const grade = mark ? (mark.grade || 'A') : 'A';
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${s}</td>
<td class="border px-3 py-2 text-center">—</td>
<td class="border px-3 py-2 text-center">—</td>
<td class="border px-3 py-2 text-center">
<select data-idx="${idx}" data-field="grade" class="grade-select">
<option value="A"${grade==='A'?' selected':''}>A</option>
<option value="B"${grade==='B'?' selected':''}>B</option>
<option value="C"${grade==='C'?' selected':''}>C</option>
<option value="D"${grade==='D'?' selected':''}>D</option>
</select>
</td>
</tr>
`);
} else {
const utVal = mark ? (mark.ut || 0) : 0;
const hyVal = mark ? (mark.hy || 0) : 0;
const overall = mark ? (mark.total || 0) : 0;
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${s}</td>
<td class="border px-3 py-2 text-center"><input data-idx="${idx}" data-field="ut" type="number" min="0" max="20" value="${utVal}" class="w-16 p-1 border rounded" /></td>
<td class="border px-3 py-2 text-center"><input data-idx="${idx}" data-field="hy" type="number" min="0" max="80" value="${hyVal}" class="w-16 p-1 border rounded" /></td>
<td class="border px-3 py-2 font-semibold text-center">${overall}</td>
</tr>
`);
}
});
tfoot.innerHTML = `
<tr class="bg-gray-50">
<td class="border px-3 py-2 font-semibold text-right">Total</td>
<td id="totalUT" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalHY" class="border px-3 py-2 font-semibold text-center">0</td>
<td id="totalOverall" class="border px-3 py-2 font-semibold text-center">0</td>
</tr>
<tr class="bg-gray-50">
<td colspan="3" class="border px-3 py-2 font-semibold text-right">Percentage</td>
<td id="percentage" class="border px-3 py-2 font-semibold text-center">0%</td>
</tr>
`;
}
attachMarksInputsListeners();
calculateTotalsAndUpdate();
}
/* ---------------- ATTACH INPUT LISTENERS & VALIDATION ---------------- */
function attachMarksInputsListeners() {
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
el.addEventListener('input', e => {
autoClampInput(el);
calculateTotalsAndUpdate();
});
el.addEventListener('blur', () => { autoClampInput(el); calculateTotalsAndUpdate(); });
});
}
function autoClampInput(el) {
if (!el) return;
if (el.tagName.toLowerCase() === 'select') return;
const max = Number(el.max);
const min = Number(el.min) || 0;
let val = Number(el.value);
if (isNaN(val)) {
el.value = '';
return;
}
if (!isNaN(max) && max >= 0 && val > max) {
el.value = max;
val = max;
}
if (!isNaN(min) && val < min) {
el.value = min;
}
}

/* ---------------- LOAD / SAVE STUDENT ---------------- */
function loadStudent(key) {
const [cls, admission] = key.split('|');
const student = state.studentsByClass[cls] && state.studentsByClass[cls][key];
if (!student) return alert('Student data not found.');
state.selectedStudentKey = key;
state.selectedClass = cls;
const romanMap = { "1":"I","2":"II","3":"III","4":"IV","5":"V","6":"VI","7":"VII","8":"VIII","9":"IX" };
if (cls === 'Nursery' || cls === 'LKG' || cls === 'UKG') {
qs('classSelect').value = cls;
} else {
qs('classSelect').value = romanMap[cls] || cls;
}
qs('studentName').textContent = student.name;
qs('admissionNo').textContent = student.admission || '—';
qs('classSection').textContent = displayClassLabel(student.cls);
qs('fatherName').textContent = student.fatherName || '—';
qs('studentNameInput').value = student.name;
qs('admissionInput').value = student.admission || '';
if (qs('fatherNameInput')) {
qs('fatherNameInput').value = student.fatherName || '';
}
document.querySelectorAll('#attendancePresent').forEach(el => el.value = student.attendance.present || 0);
document.querySelectorAll('#attendanceTotal').forEach(el => el.value = student.attendance.total || DEFAULT_ATT_TOTAL);

renderMarksTableForClass(student.cls);

qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
const idx = Number(el.getAttribute('data-idx'));
const field = el.getAttribute('data-field');
if (!Number.isFinite(idx)) return;
const m = student.marks[idx];
if (!m) return;
if (el.tagName.toLowerCase() === 'select') {
el.value = m.grade || 'A';
} else {
const val = m[field] ?? (m[field] === 0 ? 0 : '');
if (typeof val === 'number') el.value = val;
}
});
student.coscholastic = student.coscholastic || {};
qs('coscholasticBody').innerHTML = `
<tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" value="${student.coscholastic.workHabits || ''}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
<tr><td>Behavior</td><td><input type="text" id="behaviorInput" value="${student.coscholastic.behavior || ''}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
`;
attachMarksInputsListeners();
calculateTotalsAndUpdate();
}
function saveCurrentStudent() {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
const student = getCurrentStudent();
if (!student) return;
const attPresentEls = document.querySelectorAll('#attendancePresent');
const attTotalEls = document.querySelectorAll('#attendanceTotal');
student.attendance.present = Number(attPresentEls[0].value) || 0;
student.attendance.total = Number(attTotalEls[0].value) || DEFAULT_ATT_TOTAL;
student.fatherName = qs('fatherNameInput') ? qs('fatherNameInput').value.trim() : '';
student.coscholastic = {
workHabits: qs('workHabitsInput') ? qs('workHabitsInput').value.trim() : '',
behavior: qs('behaviorInput') ? qs('behaviorInput').value.trim() : ''
};
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
const idx = Number(el.getAttribute('data-idx'));
const field = el.getAttribute('data-field');
if (!Number.isFinite(idx)) return;
student.marks[idx] = student.marks[idx] || {};
if (el.tagName.toLowerCase() === 'select') {
student.marks[idx].grade = el.value;
student.marks[idx].isGrade = true;
} else {
student.marks[idx][field] = Number(el.value) || 0;
}
});
calculateTotalsAndUpdate();
persistStudents();
}

/* ---------------- GET STUDENT ---------------- */
function getCurrentStudent() {
if (!state.selectedStudentKey) return null;
const [cls] = state.selectedStudentKey.split('|');
return state.studentsByClass[cls] && state.studentsByClass[cls][state.selectedStudentKey];
}

/* ---------------- CALCULATIONS & REMARKS ---------------- */
function calculateTotalsAndUpdate() {
const student = getCurrentStudent();
if (student) {
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
const idx = Number(el.getAttribute('data-idx'));
const field = el.getAttribute('data-field');
if (!Number.isFinite(idx)) return;
student.marks[idx] = student.marks[idx] || {};
if (el.tagName.toLowerCase() === 'select') {
student.marks[idx].grade = el.value;
student.marks[idx].isGrade = true;
} else {
student.marks[idx][field] = Number(el.value) || 0;
}
});
}
let percentage = 0;
if (student && isNurToUkg(student.cls)) {
let totals = { ut:0, utOral:0, hy:0, hyOral:0, overall:0 };
student.marks.forEach(m => {
const ut = Number(m.ut) || 0;
const utOral = Number(m.utOral) || 0;
const hy = Number(m.hy) || 0;
const hyOral = Number(m.hyOral) || 0;
const subjTotal = ut + utOral + hy + hyOral;
m.total = subjTotal;
totals.ut += ut; totals.utOral += utOral; totals.hy += hy; totals.hyOral += hyOral; totals.overall += subjTotal;
});
if (qs('totalUT')) qs('totalUT').textContent = totals.ut;
if (qs('totalUTOral')) qs('totalUTOral').textContent = totals.utOral;
if (qs('totalHY')) qs('totalHY').textContent = totals.hy;
if (qs('totalHYOral')) qs('totalHYOral').textContent = totals.hyOral;
if (qs('totalOverall')) qs('totalOverall').textContent = totals.overall;
const subjCount = student.marks.length || 1;
percentage = ((totals.overall / (subjCount * 100)) * 100).toFixed(2);
if (qs('percentage')) qs('percentage').textContent = percentage + '%';
} else if (student) {
let totals = { ut:0, hy:0, overall:0, numericCount:0 };
student.marks.forEach(m => {
if (m.isGrade) {
// skip
} else {
const ut = Number(m.ut) || 0;
const hy = Number(m.hy) || 0;
const t = ut + hy;
m.total = t;
totals.ut += ut; totals.hy += hy; totals.overall += t; totals.numericCount++;
}
});
if (qs('totalUT')) qs('totalUT').textContent = totals.ut;
if (qs('totalHY')) qs('totalHY').textContent = totals.hy;
if (qs('totalOverall')) qs('totalOverall').textContent = totals.overall;
const denom = (totals.numericCount || 1) * 100;
percentage = denom>0?((totals.overall/denom)*100).toFixed(2):'0.00';
if (qs('percentage')) qs('percentage').textContent = percentage + '%';
} else {
computeTotalsFromInputs();
}
if (student) {
let remarkText = 'Needs Improvement';
const p = Number(percentage);
if (p >= 90) remarkText = 'Outstanding';
else if (p >= 80) remarkText = 'Excellent';
else if (p >= 70) remarkText = 'Very Good';
else if (p >= 60) remarkText = 'Good';
else if (p >= 50) remarkText = 'Average';
student.remark = remarkText;
student.teachersRemark = remarkText;
qs('teachersRemark').textContent = remarkText;

qs('marksTableBody').querySelectorAll('tr').forEach((tr, idx) => {
const m = student.marks[idx];
if (!m) return;
const overallCell = tr.children[tr.children.length - 1];
overallCell.textContent = m.isGrade ? (m.grade || '—') : (m.total || 0);
});
}
if (student) updateChart(student);
persistStudents();
}

function computeTotalsFromInputs() {
let totalUT = 0, totalHY = 0, totalOverall = 0;
qs('marksTableBody').querySelectorAll('input').forEach(el => {
const field = el.getAttribute('data-field');
const val = Number(el.value) || 0;
// Basic logic for non-NUR/LKG/UKG classes to calculate totals from what's on screen
if (field === 'ut') totalUT += val;
if (field === 'hy') totalHY += val;
totalOverall += val;
});
if (qs('totalUT')) qs('totalUT').textContent = totalUT;
if (qs('totalHY')) qs('totalHY').textContent = totalHY;
if (qs('totalOverall')) qs('totalOverall').textContent = totalOverall;
}

/* ----------------- CHART (MODIFIED COLORS) ----------------- */
function initChart() {
const ctx = qs('marksChart').getContext('2d');
state.chart = new Chart(ctx, {
type: 'bar',
data: { labels: [], datasets: [] },
options: { 
    responsive: true, 
    plugins:{ legend: { display: true } }, 
    scales:{ y: { beginAtZero:true, max:100 } },
    // Ensure all borders are black for printing clarity
    elements: {
        bar: {
            borderColor: 'rgba(0, 0, 0, 1)',
            borderWidth: 1
        }
    }
}
});
}

function updateChart(student) {
const labels = student.marks.map(m => m.name).filter(name => name !== 'G.K.');
const obtained = student.marks.filter(m => !m.isGrade).map(m => m.total || 0);
const classAvg = labels.map(l => getClassAverage(student.cls, l));
const classHigh = labels.map(l => getClassHighest(student.cls, l));

// **CRITICAL COLOR CHANGES FOR B&W PRINTING**
// 1. Obtained: Solid Black
const obtainedColor = 'rgba(0,0,0,1)';
// 2. Class Average: White with pattern (Black diagonal lines on a white background)
const classAvgPattern = pattern.draw('diagonal', 'rgba(0,0,0,1)', 'rgba(255,255,255,1)', 6); 
// 3. Class Highest: Solid Gray (mid-tone gray for contrast with black and white)
const classHighColor = 'rgba(150,150,150,1)'; 

state.chart.data.labels = labels;
state.chart.data.datasets = [
{ label: 'Obtained', data: obtained, backgroundColor: obtainedColor, borderColor: '#000', borderWidth:1 },
{ label: 'Class Average', data: classAvg, backgroundColor: classAvgPattern, borderColor: '#000', borderWidth:1 },
{ label: 'Class Highest', data: classHigh, backgroundColor: classHighColor, borderColor: '#000', borderWidth:1 }
];
state.chart.update();
}

function getClassAverage(cls, subjectName) {
if (!state.studentsByClass[cls]) return 0;
const vals = Object.values(state.studentsByClass[cls]).map(s => {
const sub = s.marks.find(m => m.name === subjectName);
return sub ? (sub.total || 0) : 0;
}).filter(v => typeof v === 'number');
if (!vals.length) return 0;
return Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
}
function getClassHighest(cls, subjectName) {
if (!state.studentsByClass[cls]) return 0;
const vals = Object.values(state.studentsByClass[cls]).map(s => {
const sub = s.marks.find(m => m.name === subjectName);
return sub ? (sub.total || 0) : 0;
}).filter(v => typeof v === 'number');
if (!vals.length) return 0;
return Math.max(...vals);
}

/* ---------------- DASHBOARD & BULK DOWNLOAD ---------------- */
function showDashboardTopper() {
// ... (Topper logic remains the same) ...
const cls = qs('dashboardClassSelect').value;
if (!cls) { qs('classTopperDashboard').textContent='Class Topper: —'; qs('schoolTopperDashboard').textContent='School Topper: —'; return; }
let classTopper = { name:'—', total:0 };
let schoolTopper = { name:'—', total:0 };
Object.keys(state.studentsByClass[cls]||{}).forEach(k => {
const s = state.studentsByClass[cls][k];
const tot = s.marks.reduce((a,b)=>a+(b.total||0),0);
if (tot > classTopper.total) classTopper={name:s.name,total:tot};
});
Object.values(state.studentsByClass).forEach(clsObj => {
Object.values(clsObj).forEach(s => {
const tot = s.marks.reduce((a,b)=>a+(b.total||0),0);
if (tot > schoolTopper.total) schoolTopper={name:s.name,total:tot};
});
});
qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} — ${classTopper.total}`;
qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} — ${schoolTopper.total}`;
}

// **EXCEL DOWNLOAD LOGIC (Using SheetJS - xlsx)**
function bulkDownloadReports() {
const clsInput = qs('dashboardClassSelect').value || state.selectedClass;
if (!clsInput) return alert('Select a class for bulk download.');
const cls = interpretClassValue(clsInput);
if (!state.studentsByClass[cls] || !Object.keys(state.studentsByClass[cls]).length) return alert('No students found in this class.');
const students = Object.keys(state.studentsByClass[cls]).map(k => state.studentsByClass[cls][k]);

let subjects = [];
if (isNurToUkg(cls)) {
    subjects = SUBJECTS_NUR_TO_UKG.map(s => s.name);
} else {
    subjects = subjectsForClass(cls);
}

const rows = students.map(s => {
  const base = {
    'Student Name': s.name || '',
    "Father's Name": s.fatherName || '',
    'Admission No': s.admission || '',
    'Class': displayClassLabel(s.cls || cls),
  };
  // Logic to map marks to Excel columns
  if (isNurToUkg(cls)) {
    subjects.forEach(sub => {
      const mark = s.marks.find(m => m.name === sub) || {};
      base[`${sub} - UT Written`] = mark.ut ?? 0;
      base[`${sub} - UT Oral`] = mark.utOral ?? 0;
      base[`${sub} - HY Written`] = mark.hy ?? 0;
      base[`${sub} - HY Oral`] = mark.hyOral ?? 0;
      base[`${sub} - Overall`] = mark.total ?? 0;
    });
  } else {
    subjects.forEach(sub => {
      const mark = s.marks.find(m => m.name === sub) || {};
      if (mark.isGrade) {
        base[`${sub} - Grade`] = mark.grade || '';
      } else {
        base[`${sub} - UT(20)`] = mark.ut ?? 0;
        base[`${sub} - HY(80)`] = mark.hy ?? 0;
        base[`${sub} - Overall`] = mark.total ?? 0;
      }
    });
  }
  const overall = (s.marks || []).reduce((a,b) => a + (Number(b.total) || 0), 0);
  const numericMarks = (s.marks || []).filter(m => !m.isGrade);
  const numericCount = numericMarks.length || 1;
  const maxPossible = numericCount * 100;
  const percentage = maxPossible > 0 ? ((overall / maxPossible) * 100).toFixed(2) : '0.00';

  base['Total Overall'] = overall;
  base['Percentage'] = percentage + '%';
  base['Attendance'] = `${s.attendance.present || 0} / ${s.attendance.total || DEFAULT_ATT_TOTAL}`;
  base['Teacher Remark'] = s.teachersRemark || s.remark || '';
  return base;
});

const wb = XLSX.utils.book_new();
const ws = XLSX.utils.json_to_sheet(rows);
XLSX.utils.book_append_sheet(wb, ws, `Class_${displayClassLabel(cls)}_Marks`);
const filename = `ReportCards_${displayClassLabel(cls)}_${new Date().toISOString().split('T')[0]}.xlsx`;
XLSX.writeFile(wb, filename);
}

/* ---------------- CLEAR DATA ---------------- */
function clearAllData() {
const password = prompt('Enter password to clear ALL data:');
if (password !== '1234') return alert('Incorrect password!');
if (!confirm('Are you sure? This will remove all saved data!')) return;
localStorage.clear();
state.studentsByClass = {};
state.selectedStudentKey = '';
clearStudentView();
alert('All data cleared successfully.');
}

function clearStudentView() {
state.selectedStudentKey = '';
qs('studentName').textContent = '—';
qs('admissionNo').textContent = '—';
if (qs('fatherName')) qs('fatherName').textContent = '—';
qs('studentNameInput').value = '';
qs('admissionInput').value = '';
if (qs('fatherNameInput')) qs('fatherNameInput').value = '';
qs('classSection').textContent = state.selectedClass ? displayClassLabel(state.selectedClass) : '—';
document.querySelectorAll('#attendancePresent').forEach(el => el.value = '');
document.querySelectorAll('#attendanceTotal').forEach(el => el.value = DEFAULT_ATT_TOTAL);

qs('coscholasticBody').innerHTML = `
<tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
<tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
`;
if (qs('teachersRemark')) qs('teachersRemark').textContent = 'Good effort. Keep improving.';
renderMarksTableForClass(state.selectedClass);
}

// **UPDATE PRINT DATE LOGIC**
function updatePrintDate() {
const stored = localStorage.getItem('ng_print_date');
let printDate;
if (stored) {
  // Use stored value if available
  const d = new Date(stored + 'T00:00:00'); 
  printDate = d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
} else {
  // Use current date if no stored value
  printDate = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
}
qs('printDate').textContent = 'Date: ' + printDate;
}
</script>
</body>
</html>

