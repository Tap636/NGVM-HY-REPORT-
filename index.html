<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NANDI GURUKUL VIDYA MANDIR - Report Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  @page {
    size: A4;
    margin: 0;
  }
  body {
    margin: 0;
    padding: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: #f3f4f6;
  }
  @media print {
    body {
      -webkit-print-color-adjust: exact;
      background: white;
      margin: 0;
      padding: 0;
    }
    .no-print {
      display: none !important;
    }
    .page {
      box-shadow: none;
      margin: 0;
      padding: 20mm 20mm 50mm 20mm;
      width: 210mm;
      min-height: 297mm;
      border: 1px solid #0f172a;
      box-sizing: border-box;
      background: white;
      page-break-after: always;
      position: relative;
      overflow: visible;
    }
    #printDate {
      text-align: center;
      font-size: 10px;
      margin-top: 2mm;
      width: 100%;
      position: absolute;
      bottom: 15mm;
      left: 0;
    }
    #signaturesPrint {
      position: absolute;
      bottom: 28mm;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 15mm;
      box-sizing: border-box;
      align-items: center;
      font-size: 11px;
      font-weight: 600;
    }
    #signaturesPrint > div {
      width: 32%;
      text-align: center;
    }
    #signaturesPrint > .school-seal {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #signaturesPrint > .school-seal img {
      opacity: 0.15;
      width: 70px;
      height: auto;
    }
    #disclaimerPrint {
      position: absolute;
      bottom: 10mm;
      width: 100%;
      font-size: 9px;
      text-align: center;
      color: #44444499;
      font-style: italic;
      font-weight: 500;
      padding: 0 20mm;
      box-sizing: border-box;
    }
  }
  .page {
    width: 210mm;
    min-height: 297mm;
    margin: 10mm auto;
    padding: 20mm 20mm 70px 20mm;
    background: white;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    font-size: 12px;
    box-sizing: border-box;
    border: 2px solid #0f172a;
    position: relative;
    overflow: visible;
  }
  .school-name {
    letter-spacing: 1px;
  }
  input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
  table {
    border-collapse: collapse;
  }
  th, td {
    border: 1px solid #0f172a;
    padding: 6px 8px;
    font-size: 11px;
  }
  th {
    background: #d1fae5;
    font-weight: 700;
    text-align: center;
  }
  td.text-left {
    text-align: left;
  }
  #signatures {
    display: flex;
    justify-content: space-between;
    margin-top: 24px;
    font-size: 12px;
  }
  #signatures div {
    width: 32%;
    text-align: center;
  }
  #signatures div div {
    border-bottom: 1px solid black;
    margin-top: 16px;
    height: 48px;
  }
  #coScholasticGrades {
    margin-top: 16px;
  }
  #remarksArea {
    margin-top: 8px;
    font-weight: 600;
  }
  .watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.05;
    pointer-events: none;
    user-select: none;
    z-index: 0;
    width: 160mm;
    height: auto;
  }
  .no-print {
    margin-bottom: 20px;
  }
</style>
</head>
<body>

<!-- WATERMARK inside border center -->
<img src="watermark.png" alt="Watermark" class="watermark" />

<!-- DASHBOARD FOR TOPPERS (Hidden in print) -->
<div class="no-print p-4 bg-yellow-100 border rounded max-w-4xl mx-auto">
  <h2 class="font-bold mb-2">School Dashboard (Topper Analysis)</h2>
  <label class="block text-sm text-gray-600 mb-1">Select Class to See Topper:</label>
  <select id="dashboardClassSelect" class="border rounded px-2 py-1 mb-2 w-60">
    <option value="">-- Select Class --</option>
    <option value="Nursery">Nursery</option>
    <option value="LKG">LKG</option>
    <option value="UKG">UKG</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
  </select>
  <p id="classTopperDashboard" class="font-semibold mt-1">Class Topper: —</p>
  <p id="schoolTopperDashboard" class="font-semibold mt-1">School Topper: —</p>
  <button id="bulkDownloadBtn" class="mt-3 px-3 py-1 bg-indigo-600 text-white rounded">Download Classwise Report Cards</button>
</div>

<div class="page bg-white">

  <!-- Header -->
  <div class="flex items-center justify-between pb-4 border-b mb-4">
    <div class="flex items-center gap-4">
      <img src="logo.png" class="w-20 h-20 rounded-md" alt="School Logo" />
      <div>
        <h1 class="text-2xl font-extrabold school-name">NANDI GURUKUL VIDYA MANDIR</h1>
        <p class="text-sm">Academic Session: <strong>2025-26</strong></p>
        <p class="text-sm mt-1 text-gray-700 font-semibold">REPORT CARD - HALF YEARLY EXAMINATION</p>
      </div>
    </div>

    <div class="text-right no-print">
      <label class="block text-xs text-gray-600">Select Class</label>
      <select id="classSelect" class="border rounded px-2 py-1 bg-white">
        <option value="">-- Select Class --</option>
        <option value="Nursery">Nursery</option>
        <option value="LKG">LKG</option>
        <option value="UKG">UKG</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
      </select>
    </div>
  </div>

  <!-- Teacher Controls -->
  <div class="no-print mb-4">
    <div class="grid grid-cols-4 gap-4 items-end">
      <div>
        <label class="text-sm text-gray-600">Admission Number (Roll No.)</label>
        <input id="admissionInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="e.g. 138/Z18" />
      </div>
      <div>
        <label class="text-sm text-gray-600">Full Name</label>
        <input id="studentNameInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="Student full name" />
      </div>
      <div>
        <button id="addStudentBtn" class="px-3 py-1 bg-blue-600 text-white rounded w-full">Add / Update Student</button>
      </div>
      <div class="flex gap-2 justify-end">
        <button id="loadBtn" class="px-3 py-1 border rounded">Load</button>
        <button id="saveBtn" class="px-3 py-1 bg-green-600 text-white rounded">Save</button>
        <button id="printBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Print</button>
      </div>
    </div>
  </div>

  <!-- Student Info -->
  <div class="grid grid-cols-3 gap-4 mb-4">
    <div>
      <p class="text-sm text-gray-600">Name</p>
      <h2 id="studentName" class="font-semibold">—</h2>
    </div>
    <div>
      <p class="text-sm text-gray-600">Admission No.</p>
      <h2 id="admissionNo" class="font-semibold">—</h2>
    </div>
    <div>
      <p class="text-sm text-gray-600">Class/Section</p>
      <h2 id="classSection" class="font-semibold">—</h2>
    </div>
  </div>

  <!-- Attendance -->
  <div class="mb-4">
    <label class="text-sm text-gray-600 font-semibold">Attendance</label>
    <div class="flex gap-2 items-center">
      <input type="number" id="attendancePresent" min="0" max="130" placeholder="Days Present" class="border px-2 py-1 rounded w-32" />
      <input type="number" id="attendanceTotal" readonly value="130" class="border px-2 py-1 rounded w-40 bg-gray-200 text-center" title="Fixed total 130 working days" />
      <small class="text-xs text-gray-600 ml-2">* Total Working Days Fixed at 130</small>
    </div>
  </div>

  <!-- Marks Table -->
  <div class="overflow-x-auto">
    <table class="w-full border-collapse table-auto text-sm">
      <thead id="marksTableHead">
        <!-- Will be dynamically generated -->
      </thead>
      <tbody id="marksTableBody"></tbody>
      <tfoot id="marksTableFoot">
        <!-- Will be dynamically generated -->
      </tfoot>
    </table>
  </div>

  <!-- Co-Scholastic & Attendance -->
  <div class="grid grid-cols-3 gap-4 mt-6">
    <div class="col-span-1">
      <div class="border p-4">
        <h3 class="font-semibold mb-2">Co-Scholastic Grades (Optional)</h3>
        <table class="w-full text-sm" id="coscholasticTable"><tbody id="coscholasticBody"><tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr><tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr></tbody></table>
      </div>

      <div class="border p-4 mt-4">
        <h3 class="font-semibold mb-2">Class Teacher's Remark</h3>
        <textarea id="teachersRemark" class="w-full border p-2 text-sm" rows="3">Good effort. Keep improving.</textarea>
      </div>

      <div id="remarksArea" class="mt-2 font-semibold">Remark: —</div>
    </div>

    <!-- Graph -->
    <div class="col-span-2">
      <div class="border p-4">
        <h3 class="font-semibold mb-2">Graphical Analysis (Term 1)</h3>
        nvas id="marksChart" height="180180"></canvas>
      </div>
    </div>
  </div>

  <!-- Signatures and Seal -->
  <div id="signaturesPrint" class="no-print" aria-hidden="true" style="margin-top: 60px; font-weight: 600; font-size: 11px; display: flex; justify-content: space-between; padding: 0 20px;">
    <div>Class Teacher<div style="border-bottom: 1px solid black; height: 44px; margin-top: 3px;"></div></div>
    <div class="school-seal"><img src="principal.png" alt="School Seal" style="opacity: 0.15; width: 70px; height: auto;" /></div>
    <div>Principal<div><img src="principal.png" alt="Principal Signature" style="width: 80px; height: auto; margin-top: 5px;" /></div></div>
  </div>

  <div id="printDate" class="text-center text-xs text-gray-600" style="margin-top: 6px;">Date: —</div>

  <div id="disclaimerPrint" style="color: #666; font-size: 9px; margin-top: 6px; font-style: italic; text-align: center;">
    This is a digitally generated report card which is a bonafide record of student's academic performance.
  </div>
</div>

<!-- Clear Data Button -->
<div class="no-print text-center mt-6 max-w-4xl mx-auto">
  <button id="clearDataBtn" class="px-3 py-1 bg-red-600 text-white rounded">Clear All Data (Requires Password)</button>
</div>

<script>
  // Subject Lists as per prompt
  const nurseryToUKGSubjects = [
    { name: "English", hasOral: true, maxUTWritten: 15, maxUTOral: 5, maxHYWritten: 60, maxHYOral: 20 },
    { name: "Hindi", hasOral: true, maxUTWritten: 15, maxUTOral: 5, maxHYWritten: 60, maxHYOral: 20 },
    { name: "Maths", hasOral: true, maxUTWritten: 15, maxUTOral: 5, maxHYWritten: 60, maxHYOral: 20 },
    { name: "Drawing", hasOral: false, maxUTWritten: 20, maxUTOral: 0, maxHYWritten: 80, maxHYOral: 0 }
  ];

  const classesSubjects = {
    '1': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '2': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '3': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '4': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '5': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '6': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "Science", "SST"],
    '7': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "Science", "SST"],
    '8': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "Science", "SST"],
    '9': ["Hindi", "English", "Maths", "Drawing", "Science", "SST"]
  };

  const gradedSubjects = ['GK'];

  let state = {
    selectedClass: '',
    selectedStudentKey: '',
    studentsByClass: {},
    chart: null
  };

  const qs = id => document.getElementById(id);

  // Dynamically generate marks table headers based on class and oral disposition
  function generateMarksTableHeaders() {
    const thead = document.getElementById('marksTableHead');
    const tfoot = document.getElementById('marksTableFoot');
    thead.innerHTML = '';
    tfoot.innerHTML = '';
    if (!state.selectedClass) return;

    const isNurUKG = ['Nursery', 'LKG', 'UKG'].includes(state.selectedClass);

    // Subjects for current class
    let subjects = [];
    if (isNurUKG) subjects = nurseryToUKGSubjects;
    else subjects = classesSubjects[state.selectedClass] || [];

    // Create Headers
    let headerRow = document.createElement('tr');
    headerRow.innerHTML = `<th class="border px-3 py-2 text-left">Subject</th>`;

    if (isNurUKG) {
      // Show Written and Oral separately if oral present
      subjects.forEach(s => {
        if (s.hasOral) {
          headerRow.innerHTML += `<th class="border px-3 py-2 text-center">Unit Test Written</th>
                                  <th class="border px-3 py-2 text-center">Unit Test Oral</th>
                                  <th class="border px-3 py-2 text-center">Half Yearly Written</th>
                                  <th class="border px-3 py-2 text-center">Half Yearly Oral</th>`;
        } else {
          headerRow.innerHTML += `<th class="border px-3 py-2 text-center">Unit Test</th>
                                  <th class="border px-3 py-2 text-center">Half Yearly</th>`;
        }
        // One Absent column always
        headerRow.innerHTML += `<th class="border px-3 py-2 text-center">Absent?</th>
                                <th class="border px-3 py-2 text-center font-semibold">Overall Performance</th>`;
      });
      // Simplify header so all subjects have same columns, so rebuild above row:
      // Actually, for uniform table, build common headers as one set:
      headerRow.innerHTML = `<th class="border px-3 py-2 text-left">Subject</th>`;
      if (subjects.some(s => s.hasOral)) {
        headerRow.innerHTML += `<th class="border px-3 py-2 text-center">Unit Test Written</th>
                                <th class="border px-3 py-2 text-center">Unit Test Oral</th>
                                <th class="border px-3 py-2 text-center">Half Yearly Written</th>
                                <th class="border px-3 py-2 text-center">Half Yearly Oral</th>`;
      } else {
        headerRow.innerHTML += `<th class="border px-3 py-2 text-center">Unit Test</th>
                                <th class="border px-3 py-2 text-center">Half Yearly</th>
                                <th class="border px-3 py-2 text-center hidden">Unit Test Oral</th>
                                <th class="border px-3 py-2 text-center hidden">Half Yearly Oral</th>`;
      }
      headerRow.innerHTML += `<th class="border px-3 py-2 text-center">Absent?</th>
                              <th class="border px-3 py-2 text-center font-semibold">Overall Performance</th>`;
    } else {
      // Above UKG all no oral columns, "Written" removed after UT/HY headers
      headerRow.innerHTML += `<th class="border px-3 py-2 text-center">Unit Test</th>
                              <th class="border px-3 py-2 text-center hidden">Unit Test Oral</th>
                              <th class="border px-3 py-2 text-center">Half Yearly</th>
                              <th class="border px-3 py-2 text-center hidden">Half Yearly Oral</th>
                              <th class="border px-3 py-2 text-center">Absent?</th>
                              <th class="border px-3 py-2 text-center font-semibold">Overall Performance</th>`;
    }
    thead.appendChild(headerRow);

    // Footer row for totals and percentage
    let footRowTotal = document.createElement('tr');
    footRowTotal.className = 'bg-gray-50';
    footRowTotal.innerHTML = `<td class="border px-3 py-2 font-semibold text-right">Total</td>`;
    if (isNurUKG) {
      if (subjects.some(s => s.hasOral)) {
        footRowTotal.innerHTML += `
          <td id="totalUTWritten" class="border px-3 py-2 font-semibold text-center">0</td>
          <td id="totalUTOral" class="border px-3 py-2 font-semibold text-center">0</td>
          <td id="totalHYWritten" class="border px-3 py-2 font-semibold text-center">0</td>
          <td id="totalHYOral" class="border px-3 py-2 font-semibold text-center">0</td>`;
      } else {
        footRowTotal.innerHTML += `
          <td id="totalUTWritten" class="border px-3 py-2 font-semibold text-center">0</td>
          <td id="totalHYWritten" class="border px-3 py-2 font-semibold text-center">0</td>
          <td class="border px-3 py-2"></td>
          <td class="border px-3 py-2"></td>`;
      }
    } else {
      footRowTotal.innerHTML += `
        <td id="totalUTWritten" class="border px-3 py-2 font-semibold text-center">0</td>
        <td class="border px-3 py-2"></td>
        <td id="totalHYWritten" class="border px-3 py-2 font-semibold text-center">0</td>
        <td class="border px-3 py-2"></td>`;
    }
    footRowTotal.innerHTML += `<td class="border px-3 py-2"></td>
                               <td id="totalTerm" class="border px-3 py-2 font-semibold text-center">0</td>`;
    tfoot.appendChild(footRowTotal);

    let footRowPerc = document.createElement('tr');
    footRowPerc.className = 'bg-gray-50';
    footRowPerc.innerHTML = `<td colspan="${isNurUKG ? (subjects.some(s => s.hasOral) ? 6 : 5) : 5}" 
      class="border px-3 py-2 font-semibold text-right">Percentage</td>
      <td id="percentage" class="border px-3 py-2 font-semibold text-center">0%</td>`;
    tfoot.appendChild(footRowPerc);

    // Remark row moved below co-scholastic in interface, so omitted here
  }

  // On class/student load: call to generate marks table and headers
  function renderMarksTable(marks=[]) {
    generateMarksTableHeaders();
    const tbody = qs('marksTableBody');
    tbody.innerHTML = '';
    if (!marks.length) return;

    // Determine if oral columns shown
    const isNurUKG = ['Nursery', 'LKG', 'UKG'].includes(state.selectedClass);
    const showOral = isNurUKG && marks.some(s => s.maxUTOral > 0);

    marks.forEach((m, idx) => {
      const tr = document.createElement('tr');
      tr.className = idx % 2 === 0 ? '' : '';

      // Build row dynamically based on oral columns presence
      let rowHtml = `<td class="border px-3 py-2 text-left">${m.name}</td>`;

      if (showOral) {
        rowHtml += `<td class="border px-3 py-2 text-center">
          <input type="number" min="0" max="${m.maxUTWritten}" value="${m.utWritten || ''}" data-idx="${idx}" data-field="utWritten"
            class="w-16 p-1 border rounded text-center"/>
          </td>
          <td class="border px-3 py-2 text-center">
          <input type="number" min="0" max="${m.maxUTOral}" value="${m.utOral || ''}" data-idx="${idx}" data-field="utOral"
            class="w-16 p-1 border rounded text-center"/>
          </td>
          <td class="border px-3 py-2 text-center">
          <input type="number" min="0" max="${m.maxHYWritten}" value="${m.hyWritten || ''}" data-idx="${idx}" data-field="hyWritten"
            class="w-16 p-1 border rounded text-center"/>
          </td>
          <td class="border px-3 py-2 text-center">
          <input type="number" min="0" max="${m.maxHYOral}" value="${m.hyOral || ''}" data-idx="${idx}" data-field="hyOral"
            class="w-16 p-1 border rounded text-center"/>
          </td>`;
      } else {
        // Hide oral columns - clear oral data, only show written UT and HY
        m.utOral = 0;
        m.hyOral = 0;
        rowHtml += `
          <td class="border px-3 py-2 text-center">
          <input type="number" min="0" max="20" value="${m.utWritten || ''}" data-idx="${idx}" data-field="utWritten"
            class="w-16 p-1 border rounded text-center"/>
          </td>
          <td class="border px-3 py-2 text-center hidden"></td>
          <td class="border px-3 py-2 text-center">
          <input type="number" min="0" max="80" value="${m.hyWritten || ''}" data-idx="${idx}" data-field="hyWritten"
            class="w-16 p-1 border rounded text-center"/>
          </td>
          <td class="border px-3 py-2 text-center hidden"></td>`;
      }

      rowHtml += `<td class="border px-3 py-2 text-center">
          <input type="checkbox" class="absentCheckbox" data-idx="${idx}" ${m.absent ? 'checked' : ''} />
          </td>`;
      rowHtml += `<td class="border px-3 py-2 text-center font-semibold">${m.total || 0}</td>`;

      tr.innerHTML = rowHtml;
      tbody.appendChild(tr);
    });

    // Attach input listeners
    tbody.querySelectorAll('input[type="number"]').forEach(inp => inp.addEventListener('input', calculateTotalsAndUpdate));
    tbody.querySelectorAll('.absentCheckbox').forEach(chk => chk.addEventListener('change', (e) => {
      const idx = Number(e.target.dataset.idx);
      const student = getCurrentStudent();
      if (!student) return;
      student.marks[idx].absent = e.target.checked;
      calculateTotalsAndUpdate();
    }));
  }

  // Previous limits, calculations etc unchanged but adapted to new dynamic table...
  function calculateTotalsAndUpdate() {
    const student = getCurrentStudent();
    if (!student) return;

    let totals = { utWritten: 0, utOral: 0, hyWritten: 0, hyOral: 0, termTotal: 0 };
    const rows = qs('marksTableBody').querySelectorAll('tr');

    rows.forEach((tr, idx) => {
      const mark = student.marks[idx];
      if (mark.absent) {
        mark.utWritten = 0; mark.utOral = 0; mark.hyWritten = 0; mark.hyOral = 0; mark.total = 0;
        tr.children[tr.children.length -1].textContent = 'Absent';
        return;
      }

      let utWritten = Number(tr.querySelector('input[data-field=utWritten]').value) || 0;
      let utOral = 0, hyWritten = 0, hyOral = 0;

      // For Nur - UKG handle oral columns presence
      const isNurUKG = ['Nursery', 'LKG', 'UKG'].includes(state.selectedClass);
      if (isNurUKG) {
        utOral = Number(tr.querySelector('input[data-field=utOral]').value) || 0;
        hyWritten = Number(tr.querySelector('input[data-field=hyWritten]').value) || 0;
        hyOral = Number(tr.querySelector('input[data-field=hyOral]').value) || 0;
      } else {
        hyWritten = Number(tr.querySelector('input[data-field=hyWritten]').value) || 0;
        utOral = 0; hyOral = 0;
      }

      // Clamp values by max allowed
      utWritten = Math.min(utWritten, mark.maxUTWritten);
      utOral = Math.min(utOral, mark.maxUTOral);
      hyWritten = Math.min(hyWritten, mark.maxHYWritten);
      hyOral = Math.min(hyOral, mark.maxHYOral);

      mark.utWritten = utWritten;
      mark.utOral = utOral;
      mark.hyWritten = hyWritten;
      mark.hyOral = hyOral;
      const subjTotal = utWritten + utOral + hyWritten + hyOral;
      mark.total = subjTotal;

      tr.children[tr.children.length -1].textContent = subjTotal;

      totals.utWritten += utWritten;
      totals.utOral += utOral;
      totals.hyWritten += hyWritten;
      totals.hyOral += hyOral;
      totals.termTotal += subjTotal;
    });

    qs('totalUTWritten').textContent = totals.utWritten;
    qs('totalUTOral').textContent = totals.utOral;
    qs('totalHYWritten').textContent = totals.hyWritten;
    qs('totalHYOral').textContent = totals.hyOral;
    qs('totalTerm').textContent = totals.termTotal;

    // Percentage assuming each subject max 100 marks total
    let subjectsCount = student.marks.length || 1;
    const percent = ((totals.termTotal / (subjectsCount * 100)) * 100).toFixed(2);
    qs('percentage').textContent = percent + '%';

    // Remark logic moved below co-scholastic, autofill possible for class teacher:
    let remark = 'Needs Improvement';
    if (percent >= 90) remark = 'Outstanding';
    else if (percent >= 80) remark = 'Excellent';
    else if (percent >= 70) remark = 'Very Good';
    else if (percent >= 60) remark = 'Good';
    else if (percent >= 50) remark = 'Average';
    qs('remark').textContent = remark;

    if (!qs('teachersRemark').value.trim() || qs('teachersRemark').value.toLowerCase().includes('good effort')) {
      qs('teachersRemark').value =
        remark === 'Outstanding' ? "Exceptional performance, keep it up!" :
        remark === 'Excellent' ? "Excellent work and dedication." :
        remark === 'Very Good' ? "Strong performance, well done." :
        remark === 'Good' ? "Good understanding, room to improve." :
        remark === 'Average' ? "Average performance, please focus more." :
        "Needs more effort to improve.";
    }

    student.remark = remark;
    updateChart(student);
  }

  // Chart remains as before, label "Class Avg" for average dataset etc.
  function initChart() {
    const ctx = qs('marksChart').getContext('2d');
    state.chart = new Chart(ctx, {
      type: 'bar',
      data: { labels: [], datasets: [] },
      options: { responsive: true, plugins: { legend: { display: true } } }
    });
  }

  function updateChart(student) {
    const labels = student.marks.map(m => m.name);
    const data = student.marks.map(m => m.total);
    const classData = labels.map(label => getClassAverage(student.cls, label));
    const highestData = labels.map(label => getClassHighest(student.cls, label));
    state.chart.data.labels = labels;
    state.chart.data.datasets = [
      { label: 'Obtained', data, backgroundColor: 'rgba(59,130,246,0.7)' },
      { label: 'Class Avg', data: classData, backgroundColor: 'rgba(16,185,129,0.7)' },
      { label: 'Highest', data: highestData, backgroundColor: 'rgba(244,63,94,0.7)' }
    ];
    state.chart.update();
  }

  function getClassAverage(cls, subjectName) {
    if (!state.studentsByClass[cls]) return 0;
    const vals = Object.values(state.studentsByClass[cls]).map(s => {
      const sub = s.marks.find(m => m.name === subjectName);
      return sub ? sub.total : 0;
    }).filter(v => v > 0);
    if (vals.length === 0) return 0;
    return Math.round(vals.reduce((a, b) => a + b, 0) / vals.length);
  }

  function getClassHighest(cls, subjectName) {
    if (!state.studentsByClass[cls]) return 0;
    const vals = Object.values(state.studentsByClass[cls]).map(s => {
      const sub = s.marks.find(m => m.name === subjectName);
      return sub ? sub.total : 0;
    });
    if (vals.length === 0) return 0;
    return Math.max(...vals);
  }

  function showDashboardTopper() {
    const cls = qs('dashboardClassSelect').value;
    if (!cls) {
      qs('classTopperDashboard').textContent = 'Class Topper: —';
      qs('schoolTopperDashboard').textContent = 'School Topper: —';
      return;
    }
    let classTopper = { name: '—', total: 0 };
    let schoolTopper = { name: '—', total: 0 };
    Object.keys(state.studentsByClass[cls] || {}).forEach(k => {
      const s = state.studentsByClass[cls][k];
      const t = s.marks.reduce((a, b) => a + b.total, 0);
      if (t > classTopper.total) classTopper = { name: s.name, total: t };
    });
    Object.values(state.studentsByClass).forEach(clsObj => {
      Object.values(clsObj).forEach(s => {
        const t = s.marks.reduce((a, b) => a + b.total, 0);
        if (t > schoolTopper.total) schoolTopper = { name: s.name, total: t };
      });
    });
    qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} — ${classTopper.total}`;
    qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} — ${schoolTopper.total}`;
  }

  function bulkDownloadReports() {
    const cls = qs('dashboardClassSelect').value || state.selectedClass;
    if (!cls) return alert('Select a class for bulk download.');
    if (!state.studentsByClass[cls] || !Object.keys(state.studentsByClass[cls]).length) {
      return alert('No students found in this class.');
    }
    const arr = [];
    Object.keys(state.studentsByClass[cls]).forEach(key => {
      const s = state.studentsByClass[cls][key];
      let report = `Report Card - ${cls} - ${s.name}\nAdmission No: ${s.admission}\n\nSubjects:\n`;
      s.marks.forEach(m => {
        report += `${m.name}: Unit Test Written ${m.utWritten || 0}, Unit Test Oral ${m.utOral || 0}, Half Yearly Written ${m.hyWritten || 0}, Half Yearly Oral ${m.hyOral || 0}, Total: ${m.total || 0}\n`;
      });
      report += `\nTotals: UT Written ${s.marks.reduce((a,b)=>a+(b.utWritten||0),0)}, UT Oral ${s.marks.reduce((a,b)=>a+(b.utOral||0),0)}, HY Written ${s.marks.reduce((a,b)=>a+(b.hyWritten||0),0)}, HY Oral ${s.marks.reduce((a,b)=>a+(b.hyOral||0),0)}, Overall ${s.marks.reduce((a,b)=>a+(b.total||0),0)}\n`;
      report += `Percentage: ${((s.marks.reduce((a,b)=>a+(b.total||0),0)/(s.marks.length*100))*100).toFixed(2)}%\nRemark: ${s.remark || '—'}\n\nAttendance: ${s.attendance.present || 0} / 130\nRemark by Teacher: ${s.teachersRemark || '—'}\n\nClass Teacher: —\nPrincipal: —\n\n--------------------------------------------------\n\n`;
      arr.push(report);
    });
    const blob = new Blob(arr, { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ReportCards_${cls}_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function clearAllData() {
    const pass = prompt('Enter password to clear ALL data:');
    if (pass !== '1234') return alert('Incorrect password!');
    if (!confirm('Are you sure? This will remove all saved data!')) return;

    localStorage.clear();
    state.studentsByClass = {};
    state.selectedStudentKey = '';
    clearStudentView();
    alert('All data cleared successfully.');
  }

  function updatePrintDate() {
    const printDate = new Date().toLocaleDateString();
    qs('printDate').textContent = 'Date: ' + printDate;
  }

  // Remains: attachEventListeners listeners from original code
  
  init();
</script>

</body>
</html>
