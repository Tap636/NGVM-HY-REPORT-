<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NANDI GURUKUL VIDYA MANDIR - Report Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  @page {
    size: A4;
    margin: 0;
  }
  body {
    margin: 0;
    padding: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: #f3f4f6;
  }
  @media print {
    body {
      -webkit-print-color-adjust: exact;
      background: white;
      margin: 0;
      padding: 0;
    }
    .no-print {
      display: none !important;
    }
    .page {
      box-shadow: none;
      margin: 0;
      padding: 20mm 20mm 40mm 20mm;
      width: 210mm;
      min-height: 297mm;
      border: 1px solid #0f172a;
      box-sizing: border-box;
      background: white;
      page-break-after: always;
      position: relative;
      overflow: visible;
    }
    #printDate {
      text-align: center;
      font-size: 10px;
      margin-top: 2mm;
      width: 100%;
      position: absolute;
      bottom: 10mm;
      left: 0;
    }
    #signaturesPrint {
      position: absolute;
      bottom: 25mm;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 15mm;
      box-sizing: border-box;
      align-items: center;
    }
    #signaturesPrint > div {
      width: 32%;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
    }
    #signaturesPrint > .school-seal {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #signaturesPrint > .school-seal img {
      opacity: 0.15;
      width: 75px;
      height: auto;
    }
    #disclaimerPrint {
      position: absolute;
      bottom: 5mm;
      width: 100%;
      font-size: 9px;
      text-align: center;
      color: #44444499;
      font-style: italic;
      font-weight: 500;
      padding: 0 20mm;
      box-sizing: border-box;
    }
  }
  .page {
    width: 210mm;
    min-height: 297mm;
    margin: 10mm auto;
    padding: 20mm 20mm 60px 20mm;
    background: white;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    font-size: 12px;
    box-sizing: border-box;
    border: 2px solid #0f172a;
    position: relative;
    overflow: visible;
  }
  .school-name {
    letter-spacing: 1px;
  }
  input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
  table {
    border-collapse: collapse;
  }
  th, td {
    border: 1px solid #0f172a;
    padding: 6px 8px;
    font-size: 11px;
  }
  th {
    background: #d1fae5;
    font-weight: 700;
    text-align: center;
  }
  td.text-left {
    text-align: left;
  }
  #signatures {
    display: flex;
    justify-content: space-between;
    margin-top: 24px;
    font-size: 12px;
  }
  #signatures div {
    width: 32%;
    text-align: center;
  }
  #signatures div div {
    border-bottom: 1px solid black;
    margin-top: 16px;
    height: 48px;
  }
  #coScholasticGrades {
    margin-top: 16px;
  }
  #remarksArea {
    margin-top: 8px;
    font-weight: 600;
  }
  .watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.05;
    pointer-events: none;
    user-select: none;
    z-index: 0;
    width: 180mm;
    height: auto;
  }
  .no-print {
    margin-bottom: 20px;
  }
  input[readonly] {
    background-color: #e5e7eb;
  }
  .hidden {
    display: none !important;
  }
</style>
</head>
<body>

<!-- WATERMARK inside the border & centered -->
<img src="watermark.png" alt="Watermark" class="watermark" />

<!-- DASHBOARD FOR TOPPERS (Hidden in print) -->
<div class="no-print p-4 bg-yellow-100 border rounded max-w-4xl mx-auto">
  <h2 class="font-bold mb-2">School Dashboard (Topper Analysis)</h2>
  <label class="block text-sm text-gray-600 mb-1">Select Class to See Topper:</label>
  <select id="dashboardClassSelect" class="border rounded px-2 py-1 mb-2 w-60">
    <option value="">-- Select Class --</option>
    <option value="Nursery">Nursery</option>
    <option value="LKG">LKG</option>
    <option value="UKG">UKG</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
  </select>
  <p id="classTopperDashboard" class="font-semibold mt-1">Class Topper: —</p>
  <p id="schoolTopperDashboard" class="font-semibold mt-1">School Topper: —</p>
  <button id="bulkDownloadBtn" class="mt-3 px-3 py-1 bg-indigo-600 text-white rounded">Download Classwise Report Cards</button>
</div>

<div class="page bg-white">

  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
    <div style="display: flex; align-items: center; gap: 16px;">
      <img src="logo.png" alt="School Logo" style="width: 90px; height: 90px; object-fit: contain;" />
      <div>
        <h1 class="text-2xl font-extrabold school-name" style="margin-bottom: 2px;">NANDI GURUKUL VIDYA MANDIR</h1>
        <p style="font-size: 12px; margin-bottom: 0;">Academic Session: <strong>2025-26</strong></p>
        <p class="font-semibold" style="font-size: 12px; letter-spacing: 0.1em;">REPORT CARD - HALF YEARLY EXAMINATION</p>
      </div>
    </div>
    <div>
      <label for="classSelect" class="text-xs font-semibold">Select Class</label><br/>
      <select id="classSelect" style="padding: 4px 8px; font-size: 12px; margin-top: 4px;">
        <option value="">-- Select Class --</option>
        <option value="Nursery">Nursery</option>
        <option value="LKG">LKG</option>
        <option value="UKG">UKG</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
      </select>
    </div>
  </div>

  <!-- Student Info and Admission -->
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 18px;">
    <div>
      <label for="admissionInput" class="text-xs font-semibold">Admission Number (Roll No.)</label><br/>
      <input id="admissionInput" type="text" style="width: 100%; padding: 6px; font-size: 12px;" placeholder="e.g. 138/Z18" />
    </div>
    <div>
      <label for="studentNameInput" class="text-xs font-semibold">Full Name</label><br/>
      <input id="studentNameInput" type="text" style="width: 100%; padding: 6px; font-size: 12px;" placeholder="Student full name" />
    </div>
    <div style="display: flex; align-items: flex-end; gap: 6px;">
      <button id="addStudentBtn" style="width: 100%; background-color: #2563eb;color: white; padding: 6px 0; font-weight: 600; font-size: 12px; border-radius: 4px;">Add / Update Student</button>
    </div>
    <div style="display: flex; gap: 6px; justify-content: flex-end; align-items: flex-end;">
      <button id="loadBtn" style="padding: 6px 12px; font-size: 12px; border: 1px solid #111827; border-radius: 4px;">Load</button>
      <button id="saveBtn" style="padding: 6px 12px; font-size: 12px; background-color: #16a34a; color: white; font-weight: 600; border-radius: 4px;">Save</button>
      <button id="printBtn" style="padding: 6px 12px; font-size: 12px; background-color: #4f46e5; color: white; font-weight: 600; border-radius: 4px;">Print</button>
    </div>
  </div>

  <!-- Display loaded info -->
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 14px; font-size: 12px; font-weight: 600;">
    <div>Name: <span id="studentName" style="font-weight: 700;">—</span></div>
    <div>Admission No: <span id="admissionNo" style="font-weight: 700;">—</span></div>
    <div>Class/Section: <span id="classSection" style="font-weight: 700;">—</span></div>
  </div>

  <!-- Attendance -->
  <div style="margin-bottom: 18px; font-size: 12px; font-weight: 600;">
    Attendance: 
    <input type="number" id="attendancePresent" min="0" max="130" style="width: 50px; padding: 4px; font-weight: normal;" placeholder="Present" /> / 
    <input type="number" id="attendanceTotal" readonly value="130" 
      style="width: 50px; padding: 4px; background:#e5e7eb; border:none; font-weight: normal;" title="Total working days fixed to 130" />
  </div>

  <!-- Marks Table -->
  <div style="overflow-x:auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
      <thead>
        <tr>
          <th>Subject</th>
          <th class="writtenCol utWrittenCol">Unit Test</th>
          <th class="writtenCol utOralCol">Oral</th>
          <th class="writtenCol hyWrittenCol">Half Yearly</th>
          <th class="writtenCol hyOralCol">Oral</th>
          <th>Absent?</th>
          <th style="font-weight: 700;">Overall Performance</th>
        </tr>
      </thead>
      <tbody id="marksTableBody"></tbody>
      <tfoot>
        <tr>
          <td style="font-weight: 700; text-align: right;">Total</td>
          <td id="totalUTWritten" class="writtenCol text-center" style="font-weight: 700;"></td>
          <td id="totalUTOral" class="writtenCol text-center"></td>
          <td id="totalHYWritten" class="writtenCol text-center" style="font-weight: 700;"></td>
          <td id="totalHYOral" class="writtenCol text-center"></td>
          <td></td>
          <td id="totalTerm" class="text-center" style="font-weight: 700;"></td>
        </tr>
        <tr>
          <td colspan="6" style="font-weight: 700; text-align: right;">Percentage</td>
          <td id="percentage" class="text-center" style="font-weight: 700;">0%</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Co-Scholastic Grades -->
  <div id="coScholasticGrades" style="margin-top: 16px;">
    <h3 style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">Co-Scholastic Grades (Optional)</h3>
    <table style="width: 100%; font-size: 11px;">
      <tbody id="coscholasticBody">
        <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" style="width: 100%; padding: 4px; font-size: 11px;" /></td></tr>
        <tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" style="width: 100%; padding: 4px; font-size: 11px;" /></td></tr>
      </tbody>
    </table>
  </div>

  <!-- Remarks below co-scholastic -->
  <div id="remarksArea" style="margin-top: 8px; font-weight: 600;">Remark: —</div>

  <!-- Graph -->
  <div style="margin-top: 18px; width: 100%;">
    <h3 style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">Graphical Analysis (Term 1)</h3>
    <canvas id="marksChart" height="180" style="width: 100%;"></canvas>
  </div>

  <!-- Signatures and Seal -->
  <div id="signatures" style="display: flex; justify-content: space-between; margin-top: 40px; font-size: 12px; z-index: 10;">
    <div>
      Class Teacher<br>
      <div></div>
    </div>
    <div style="text-align: center;">
      <img src="principal.png" alt="School Seal" style="opacity: 0.15; width: 90px; height: auto; margin-top: 0;" />
    </div>
    <div style="text-align: right;">
      <img src="principal.png" alt="Principal Signature" style="width: 70px; height: auto; margin-bottom: 4px;" /><br>
      Principal<br>
      <div></div>
    </div>
  </div>

  <div id="printDate" style="text-align: center; margin-top: 8px; font-size: 10px; color: #444;">Date: —</div>

  <div id="disclaimerPrint" style="color: #666; font-size: 9px; margin-top: 6px; font-style: italic; border-top: 1px solid #e5e7eb; padding-top: 4px; text-align: center;">
    This is a digitally generated report card which is a bonafide record of student's academic performance.
  </div>
</div>

<!-- Clear Data Button -->
<div class="no-print text-center mt-6 max-w-4xl mx-auto">
  <button id="clearDataBtn" class="px-3 py-1 bg-red-600 text-white rounded">Clear All Data (Requires Password)</button>
</div>

<script>
  // Constants & Subject Definitions
  const nurseryToUKGSubjects = [
    { name: "English", maxUTWritten: 15, maxUTOral: 5, maxHYWritten: 60, maxHYOral: 20, hasOral: true },
    { name: "Hindi", maxUTWritten: 15, maxUTOral: 5, maxHYWritten: 60, maxHYOral: 20, hasOral: true },
    { name: "Maths", maxUTWritten: 15, maxUTOral: 5, maxHYWritten: 60, maxHYOral: 20, hasOral: true },
    { name: "Drawing", maxUTWritten: 20, maxUTOral: 0, maxHYWritten: 80, maxHYOral: 0, hasOral: false }
  ];

  const classesSubjects = {
    '1': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '2': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '3': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '4': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '5': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "EVS"],
    '6': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "Science", "SST"],
    '7': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "Science", "SST"],
    '8': ["Hindi", "English", "Maths", "Computer", "GK", "Drawing", "Science", "SST"],
    '9': ["Hindi", "English", "Maths", "Drawing", "Science", "SST"]
  };

  const gradedSubjects = ['GK'];

  let state = {
    selectedClass: '',
    selectedStudentKey: '',
    studentsByClass: {},
    chart: null
  };

  const qs = id => document.getElementById(id);

  function init() {
    const stored = localStorage.getItem('ng_students');
    state.studentsByClass = stored ? JSON.parse(stored) : {};
    attachEventListeners();
    initChart();
    updatePrintDate();
  }

  function attachEventListeners() {
    qs('classSelect').addEventListener('change', (e) => {
      state.selectedClass = e.target.value;
      qs('classSection').textContent = state.selectedClass || '—';
      clearStudentView();
      renderMarksTable([]);
      updateColumnsVisibility();
    });
    
    qs('addStudentBtn').addEventListener('click', () => {
      if (!state.selectedClass) {
        alert('Select a class first.');
        return;
      }
      const admission = qs('admissionInput').value.trim();
      if (!admission) {
        alert('Enter admission number.');
        return;
      }
      const name = qs('studentNameInput').value.trim();
      if (!name) {
        alert('Enter student name.');
        return;
      }
      const key = `${state.selectedClass}|${admission}`;
      const newStudent = makeEmptyStudent(name, admission, state.selectedClass);
      state.studentsByClass[state.selectedClass] = state.studentsByClass[state.selectedClass] || {};
      if(state.studentsByClass[state.selectedClass][key]){
        const existing = state.studentsByClass[state.selectedClass][key];
        newStudent.marks = existing.marks;
        newStudent.attendance = existing.attendance;
        newStudent.teachersRemark = existing.teachersRemark;
        newStudent.coscholastic = existing.coscholastic || [];
      }
      state.studentsByClass[state.selectedClass][key] = newStudent;
      persistStudents();
      state.selectedStudentKey = key;
      loadStudent(key);
      alert('Student added/updated. Now enter marks and save.');
    });

    qs('loadBtn').addEventListener('click', () => {
      if (!state.selectedClass) {
        alert('Select a class first.');
        return;
      }
      const admission = qs('admissionInput').value.trim();
      if (!admission) {
        alert('Enter admission number.');
        return;
      }
      const key = `${state.selectedClass}|${admission}`;
      if (!state.studentsByClass[state.selectedClass] 
          || !state.studentsByClass[state.selectedClass][key]
      ) {
        alert('Student not found. Add student first.');
        return;
      }
      state.selectedStudentKey = key;
      loadStudent(key);
    });

    qs('saveBtn').addEventListener('click', () => {
      if (!state.selectedStudentKey) {
        alert('Load or add a student first.');
        return;
      }
      saveCurrentStudent();
      alert('Saved locally.');
    });

    qs('printBtn').addEventListener('click', () => {
      if (!state.selectedStudentKey) {
        alert('Load or add a student first.');
        return;
      }
      calculateTotalsAndUpdate();
      window.print();
    });

    qs('dashboardClassSelect').addEventListener('change', showDashboardTopper);

    qs('bulkDownloadBtn').addEventListener('click', bulkDownloadReports);

    qs('clearDataBtn').addEventListener('click', clearAllData);
  }

  function updateColumnsVisibility() {
    const cls = state.selectedClass;
    const isNurOrLower = (cls === 'Nursery' || cls === 'LKG' || cls === 'UKG');
    const showOral = isNurOrLower;
    document.querySelectorAll('.writtenCol').forEach(e => e.style.display = showOral ? '' : 'none');
    if (showOral) {
      document.querySelectorAll('.utWrittenCol').forEach(e => e.textContent = 'UT');
      document.querySelectorAll('.utOralCol').forEach(e => e.textContent = 'Oral');
      document.querySelectorAll('.hyWrittenCol').forEach(e => e.textContent = 'Half Yearly');
      document.querySelectorAll('.hyOralCol').forEach(e => e.textContent = 'Oral');
    } else {
      document.querySelectorAll('.utWrittenCol').forEach(e => e.textContent = 'UT');
      document.querySelectorAll('.utOralCol, .hyWrittenCol, .hyOralCol').forEach(e => e.textContent = '');
    }
  }

  function makeEmptyStudent(name, admission, cls) {
    let marks = [];
    if (cls === 'Nursery' || cls === 'LKG' || cls === 'UKG') {
      nurseryToUKGSubjects.forEach(s => {
        marks.push({
          name: s.name,
          utWritten: '',
          utOral: '',
          hyWritten: '',
          hyOral: '',
          absent: false,
          total: 0,
          maxUTWritten: s.maxUTWritten,
          maxUTOral: s.maxUTOral,
          maxHYWritten: s.maxHYWritten,
          maxHYOral: s.maxHYOral,
          graded: false
        });
      });
    } else {
      const subjList = classesSubjects[cls] || [];
      subjList.forEach(s => {
        marks.push({
          name: s,
          utWritten: '',
          utOral: '',
          hyWritten: '',
          hyOral: '',
          absent: false,
          total: 0,
          maxUTWritten: 20,
          maxUTOral: 0,
          maxHYWritten: 80,
          maxHYOral: 0,
          graded: gradedSubjects.includes(s)
        });
      });
    }
    return {
      name,
      admission,
      cls,
      marks,
      coscholastic: [],
      attendance: { present: 0, total: 130 },
      teachersRemark: '',
      remark: ''
    };
  }

  function persistStudents() {
    localStorage.setItem('ng_students', JSON.stringify(state.studentsByClass));
  }

  function clearStudentView() {
    state.selectedStudentKey = '';
    qs('studentName').textContent = '—';
    qs('admissionNo').textContent = '—';
    qs('studentNameInput').value = '';
    qs('admissionInput').value = '';
    qs('classSection').textContent = state.selectedClass || '—';
    qs('attendancePresent').value = '';
    qs('attendanceTotal').value = 130;
    qs('teachersRemark').value = '';
    qs('coscholasticBody').innerHTML = `
      <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" style="width: 100%; padding: 4px; font-size: 11px;" /></td></tr>
      <tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" style="width: 100%; padding: 4px; font-size: 11px;" /></td></tr>`;
    renderMarksTable([]);
    qs('remarksArea').textContent = 'Remark: —';
    calculateTotalsAndUpdate();
  }

  function loadStudent(key) {
    const [cls, admission] = key.split('|');
    const student = state.studentsByClass[cls][key];
    if (!student) return alert('Student data not found.');
    state.selectedStudentKey = key;
    state.selectedClass = cls;
    qs('classSelect').value = cls;
    qs('studentName').textContent = student.name;
    qs('admissionNo').textContent = student.admission || '—';
    qs('studentNameInput').value = student.name;
    qs('admissionInput').value = student.admission || '';
    qs('classSection').textContent = cls;
    qs('attendancePresent').value = student.attendance.present ?? '';
    qs('attendanceTotal').value = 130;  // fixed
    qs('teachersRemark').value = student.teachersRemark || '';
    qs('coscholasticBody').innerHTML = `
      <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" value="${student.coscholastic?.workHabits || ''}" placeholder="e.g. A, B, C" style="width: 100%; padding: 4px; font-size: 11px;" /></td></tr>
      <tr><td>Behavior</td><td><input type="text" id="behaviorInput" value="${student.coscholastic?.behavior || ''}" placeholder="e.g. A, B, C" style="width: 100%; padding: 4px; font-size: 11px;" /></td></tr>`;
    renderMarksTable(student.marks);
    updateColumnsVisibility();
    calculateTotalsAndUpdate();
  }

  function saveCurrentStudent() {
    if (!state.selectedStudentKey) return;
    const student = getCurrentStudent();
    if (!student) return;
    student.attendance.present = Number(qs('attendancePresent').value) || 0;
    student.teachersRemark = qs('teachersRemark').value;

    const workHabits = qs('workHabitsInput') ? qs('workHabitsInput').value.trim() : '';
    const behavior = qs('behaviorInput') ? qs('behaviorInput').value.trim() : '';
    student.coscholastic = { workHabits, behavior };

    persistStudents();
  }

  function getCurrentStudent() {
    if (!state.selectedStudentKey) return null;
    const [cls] = state.selectedStudentKey.split('|');
    return state.studentsByClass[cls][state.selectedStudentKey];
  }

  function renderMarksTable(marks = []) {
    const tbody = qs('marksTableBody');
    tbody.innerHTML = '';

    if (marks.length === 0) return;

    marks.forEach((m, idx) => {
      const isNurOrLower = (state.selectedClass === 'Nursery' || state.selectedClass === 'LKG' || state.selectedClass === 'UKG');
      const graded = m.graded || false;
      const utWrittenVal = m.utWritten === '' ? '' : m.utWritten;
      const utOralVal = m.utOral === '' ? '' : m.utOral;
      const hyWrittenVal = m.hyWritten === '' ? '' : m.hyWritten;
      const hyOralVal = m.hyOral === '' ? '' : m.hyOral;
      const maxUTWritten = m.maxUTWritten || 20;
      const maxUTOral = m.maxUTOral || 0;
      const maxHYWritten = m.maxHYWritten || 80;
      const maxHYOral = m.maxHYOral || 0;
      const absentChecked = m.absent ? 'checked' : '';

      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td class="text-left">${m.name}</td>
          <td class="${isNurOrLower ? '' : 'hidden'}" style="text-align:center;">
            <input data-idx="${idx}" data-field="utWritten" type="number" min="0" max="${maxUTWritten}" value="${utWrittenVal}" class="w-14 p-1 border rounded text-center" ${graded ? 'readonly' : ''} />
          </td>
          <td class="${isNurOrLower && maxUTOral > 0 ? '' : 'hidden'}" style="text-align:center;">
            <input data-idx="${idx}" data-field="utOral" type="number" min="0" max="${maxUTOral}" value="${utOralVal}" class="w-14 p-1 border rounded text-center" ${graded ? 'readonly' : ''} />
          </td>
          <td class="${isNurOrLower ? '' : 'hidden'}" style="text-align:center;">
            <input data-idx="${idx}" data-field="hyWritten" type="number" min="0" max="${maxHYWritten}" value="${hyWrittenVal}" class="w-14 p-1 border rounded text-center" ${graded ? 'readonly' : ''} />
          </td>
          <td class="${isNurOrLower && maxHYOral > 0 ? '' : 'hidden'}" style="text-align:center;">
            <input data-idx="${idx}" data-field="hyOral" type="number" min="0" max="${maxHYOral}" value="${hyOralVal}" class="w-14 p-1 border rounded text-center" ${graded ? 'readonly' : ''} />
          </td>
          <td style="text-align:center;"><input type="checkbox" data-idx="${idx}" ${absentChecked} class="absentCheckbox" /></td>
          <td style="text-align:center; font-weight: 700;">${m.total || 0}</td>
        </tr>
      `);
    });

    attachMarksInputsListener();
  }

  function attachMarksInputsListener() {
    qs('marksTableBody').querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('input', () => {
        calculateTotalsAndUpdate();
      });
    });
    qs('marksTableBody').querySelectorAll('.absentCheckbox').forEach(chk => {
      chk.addEventListener('change', () => {
        handleAbsentCheckboxChange(chk);
      });
    });
  }

  function handleAbsentCheckboxChange(absentCheckbox) {
    const idx = Number(absentCheckbox.dataset.idx);
    const tr = absentCheckbox.closest('tr');
    const student = getCurrentStudent();
    if (!student) return;
    const mark = student.marks[idx];
    mark.absent = absentCheckbox.checked;

    ['utWritten', 'utOral', 'hyWritten', 'hyOral'].forEach(field => {
      const input = tr.querySelector(`input[data-field="${field}"]`);
      if (input) {
        input.disabled = absentCheckbox.checked;
        if (absentCheckbox.checked) {
          input.value = '';
          mark[field] = '';
        }
      }
    });

    calculateTotalsAndUpdate();
  }

  function calculateTotalsAndUpdate() {
    const student = getCurrentStudent();
    if (!student) return;

    const rows = qs('marksTableBody').querySelectorAll('tr');
    let totals = {
      utWritten: 0,
      utOral: 0,
      hyWritten: 0,
      hyOral: 0,
      termTotal: 0
    };

    rows.forEach((tr, idx) => {
      const studentMark = student.marks[idx];
      if (studentMark.absent) {
        studentMark.total = 0;
        tr.children[6].textContent = 'Absent';
        return;
      }
      let utWritten = Number(tr.querySelector('input[data-field="utWritten"]').value) || 0;
      let utOral = Number(tr.querySelector('input[data-field="utOral"]').value) || 0;
      let hyWritten = Number(tr.querySelector('input[data-field="hyWritten"]').value) || 0;
      let hyOral = Number(tr.querySelector('input[data-field="hyOral"]').value) || 0;

      if (state.selectedClass === 'Nursery' || state.selectedClass === 'LKG' || state.selectedClass === 'UKG') {
        utWritten = Math.min(utWritten, studentMark.maxUTWritten);
        utOral = Math.min(utOral, studentMark.maxUTOral);
        hyWritten = Math.min(hyWritten, studentMark.maxHYWritten);
        hyOral = Math.min(hyOral, studentMark.maxHYOral);
      } else {
        utWritten = Math.min(utWritten, 20);
        utOral = 0;
        hyWritten = Math.min(hyWritten, 80);
        hyOral = 0;
      }

      if(studentMark.graded){
        const gradeMap = {A: 90,B: 75,C: 60,D: 45};
        const gradeLetter = tr.querySelector('input[data-field="utWritten"]').value.trim().toUpperCase();
        const gradeValue = gradeMap[gradeLetter] || 0;
        studentMark.utWritten = gradeLetter || '';
        studentMark.total = gradeValue;
        tr.children[6].textContent = gradeLetter || 'N/A';
        totals.termTotal += gradeValue;
        return;
      }

      let total = utWritten + utOral + hyWritten + hyOral;
      studentMark.utWritten = utWritten;
      studentMark.utOral = utOral;
      studentMark.hyWritten = hyWritten;
      studentMark.hyOral = hyOral;
      studentMark.total = total;

      tr.children[6].textContent = total;

      totals.utWritten += utWritten;
      totals.utOral += utOral;
      totals.hyWritten += hyWritten;
      totals.hyOral += hyOral;
      totals.termTotal += total;
    });

    qs('totalUTWritten').textContent = state.selectedClass && (state.selectedClass === 'Nursery' || state.selectedClass === 'LKG' || state.selectedClass === 'UKG') ? totals.utWritten : '';
    qs('totalUTOral').textContent = state.selectedClass && (state.selectedClass === 'Nursery' || state.selectedClass === 'LKG' || state.selectedClass === 'UKG') ? totals.utOral : '';
    qs('totalHYWritten').textContent = state.selectedClass && (state.selectedClass === 'Nursery' || state.selectedClass === 'LKG' || state.selectedClass === 'UKG') ? totals.hyWritten : '';
    qs('totalHYOral').textContent = state.selectedClass && (state.selectedClass === 'Nursery' || state.selectedClass === 'LKG' || state.selectedClass === 'UKG') ? totals.hyOral : '';
    qs('totalTerm').textContent = totals.termTotal;

    let subjCount = 0;
    let totalMax = 0;
    student.marks.forEach(m => {
      if (!m.graded && !m.absent) {
        subjCount++;
        totalMax += 100;
      }
    });

    const perc = subjCount === 0 ? 0 : ((totals.termTotal/(totalMax))*100);
    const percentage = perc.toFixed(2);
    qs('percentage').textContent = percentage + '%';

    let remarkText = 'Needs Improvement';
    if (perc >= 90) remarkText = 'Outstanding';
    else if (perc >= 80) remarkText = 'Excellent';
    else if (perc >= 70) remarkText = 'Very Good';
    else if (perc >= 60) remarkText = 'Good';
    else if (perc >= 50) remarkText = 'Average';

    qs('remarksArea').textContent = 'Remark: ' + remarkText;
    if (!qs('teachersRemark').value.trim() || qs('teachersRemark').value.toLowerCase().includes('good effort')) {
      qs('teachersRemark').value =
        remarkText === 'Outstanding' ? "Exceptional performance, keep it up!" :
        remarkText === 'Excellent' ? "Excellent work and dedication." :
        remarkText === 'Very Good' ? "Strong performance, well done." :
        remarkText === 'Good' ? "Good understanding, room to improve." :
        remarkText === 'Average' ? "Average performance, please focus more." :
        "Needs more effort to improve.";
    }
    student.remark = remarkText;

    updateChart(student);
  }

  function initChart() {
    const ctx = qs('marksChart').getContext('2d');
    state.chart = new Chart(ctx, {
      type: 'bar',
      data: { labels: [], datasets: [] },
      options: { responsive: true, plugins: { legend: { display: true } } }
    });
  }

  function updateChart(student) {
    const labels = student.marks.map(m => m.name);
    const data = student.marks.map(m => m.total);
    const classData = labels.map(label => getClassAverage(student.cls, label));
    const highestData = labels.map(label => getClassHighest(student.cls, label));
    state.chart.data.labels = labels;
    state.chart.data.datasets = [
      { label: 'Obtained', data, backgroundColor: 'rgba(59,130,246,0.7)' },
      { label: 'Class Average', data: classData, backgroundColor: 'rgba(16,185,129,0.7)' },
      { label: 'Highest', data: highestData, backgroundColor: 'rgba(244,63,94,0.7)' }
    ];
    state.chart.update();
  }

  function getClassAverage(cls, subjectName) {
    if (!state.studentsByClass[cls]) return 0;
    const vals = Object.values(state.studentsByClass[cls])
      .map(s => {
        const sub = s.marks.find(m => m.name === subjectName);
        return sub ? sub.total : 0;
      })
      .filter(v => v !== 0);
    if (vals.length === 0) return 0;
    return Math.round(vals.reduce((a,b) => a + b, 0)/vals.length);
  }

  function getClassHighest(cls, subjectName) {
    if (!state.studentsByClass[cls]) return 0;
    const vals = Object.values(state.studentsByClass[cls])
      .map(s => {
        const sub = s.marks.find(m => m.name === subjectName);
        return sub ? sub.total : 0;
      });
    if (vals.length === 0) return 0;
    return Math.max(...vals);
  }

  function showDashboardTopper() {
    const cls = qs('dashboardClassSelect').value;
    if (!cls) {
      qs('classTopperDashboard').textContent = 'Class Topper: —';
      qs('schoolTopperDashboard').textContent = 'School Topper: —';
      return;
    }
    let classTopper = { name: '—', total: 0 };
    let schoolTopper = { name: '—', total: 0 };
    Object.keys(state.studentsByClass[cls] || {}).forEach(k => {
      const s = state.studentsByClass[cls][k];
      const t = s.marks.reduce((a, b) => a + b.total, 0);
      if (t > classTopper.total) classTopper = { name: s.name, total: t };
    });
    Object.values(state.studentsByClass).forEach(clsObj => {
      Object.values(clsObj).forEach(s => {
        const t = s.marks.reduce((a, b) => a + b.total, 0);
        if (t > schoolTopper.total) schoolTopper = { name: s.name, total: t };
      });
    });
    qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} — ${classTopper.total}`;
    qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} — ${schoolTopper.total}`;
  }

  function bulkDownloadReports() {
    const cls = qs('dashboardClassSelect').value || state.selectedClass;
    if (!cls) {
      alert('Select a class for bulk download.');
      return;
    }
    if (!state.studentsByClass[cls] || !Object.keys(state.studentsByClass[cls]).length) {
      alert('No students found in this class.');
      return;
    }
    const arr = [];
    Object.keys(state.studentsByClass[cls]).forEach(key => {
      const s = state.studentsByClass[cls][key];
      let report = `Report Card - ${cls} - ${s.name}\nAdmission No: ${s.admission}\n\nSubjects:\n`;
      
      s.marks.forEach(m => {
        if(m.graded){
          report += `${m.name}: Grade: ${m.utWritten || 'N/A'}\n`;
        } else if(m.absent){
          report += `${m.name}: Absent\n`;
        } else {
          report += `${m.name}: UT Written: ${m.utWritten || 0}, UT Oral: ${m.utOral || 0}, Half Yearly Written: ${m.hyWritten || 0}, Half Yearly Oral: ${m.hyOral || 0}, Total: ${m.total || 0}\n`;
        }
      });
      report += `\nAttendance: ${s.attendance.present || 0} / 130\nCo-Scholastic - Work Habits: ${s.coscholastic?.workHabits || 'N/A'}, Behavior: ${s.coscholastic?.behavior || 'N/A'}\nTeacher Remark: ${s.teachersRemark || '—'}\nRemark: ${s.remark || '—'}\n\n--------------------------------------------------\n\n`;
      arr.push(report);
    });
    const blob = new Blob(arr, { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ReportCards_${cls}_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function clearAllData() {
    const pass = prompt('Enter password to clear ALL data:');
    if (pass !== '1234') {
      alert('Incorrect password!');
      return;
    }
    if (!confirm('Are you sure? This will remove all saved data!')) return;

    localStorage.clear();
    state.studentsByClass = {};
    state.selectedStudentKey = '';
    clearStudentView();
    alert('All data cleared successfully.');
  }

  function updatePrintDate() {
    const today = new Date().toLocaleDateString();
    qs('printDate').textContent = 'Date: ' + today;
  }

  init();
</script>
</body>
</html>
