<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NANDI GURUKUL VIDYA MANDIR - Report Card</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/patternomaly@1.0.4/dist/patternomaly.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* -------- PRINT STYLES - A4, watermark, footer positions, etc. -------- */
@media print {
body { -webkit-print-color-adjust: exact; }
.no-print { display: none !important; }
.screen-only { display: none !important; }
.print-only { display: block !important; } /* Attendance box visibility */

/* AGGRESSIVE PADDING REDUCTION (Fixes 2-page issue) */
.page {
  width: 210mm;
  min-height: 297mm; 
  margin: 0 auto;
  padding: 5mm 12.7mm; 
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  background: white;
  position: relative;
  overflow: hidden; /* Avoids extra page due to margin collapse */
}
.report-card-container {
  padding: 0; 
}
.watermark {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-45deg);
  opacity: 0.1;
  font-size: 80px;
  color: #a0a0a0;
  white-space: nowrap;
  pointer-events: none;
  z-index: 0;
}
.header-box {
  border-bottom: 2px solid #374151;
  padding-bottom: 5px;
  margin-bottom: 5px;
}
.chart-container {
  max-width: 100%;
  max-height: 200px; /* Constrain height for print */
  margin: 10px 0;
}
.print-attendance-box {
  display: flex;
  justify-content: space-between;
  border: 1px solid #000;
  padding: 5px;
  margin-top: 10px;
}
.print-signature-box {
  display: flex;
  justify-content: space-between;
  margin-top: 30px;
  padding-top: 10px;
  border-top: 1px dotted #000;
}
}
</style>
</head>
<body class="bg-gray-100 p-4">

<div class="no-print bg-white p-6 rounded shadow-lg mb-6">
  <h2 class="text-xl font-bold mb-4">Report Card Control Panel</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
    <div>
      <label class="block text-sm font-medium text-gray-700">Select Class</label>
      <select id="classSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
        <option value="">Select Class</option>
        <option value="Nursery">Nursery</option>
        <option value="LKG">LKG</option>
        <option value="UKG">UKG</option>
        <option value="1">I</option>
        <option value="2">II</option>
        <option value="3">III</option>
        <option value="4">IV</option>
        <option value="5">V</option>
        <option value="6">VI</option>
        <option value="7">VII</option>
        <option value="8">VIII</option>
        <option value="9">IX</option>
      </select>
    </div>
    <div>
      <label for="admissionInput" class="block text-sm font-medium text-gray-700">Admission No.</label>
      <input type="text" id="admissionInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Enter Admission No." />
    </div>
    <div>
      <label for="studentNameInput" class="block text-sm font-medium text-gray-700">Student Name</label>
      <input type="text" id="studentNameInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Enter Student Name" />
    </div>
    <div>
      <label for="fatherNameInput" class="block text-sm font-medium text-gray-700">Father's Name</label>
      <input type="text" id="fatherNameInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Enter Father's Name" />
    </div>
  </div>

  <div class="flex space-x-2 mt-4">
    <button id="addStudentBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
      Add/Update Student
    </button>
    <button id="loadBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
      Load Student
    </button>
    <button id="saveBtn" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
      Save Current Data
    </button>
    <button id="printBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
      Print Report
    </button>
    <button id="clearDataBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
      Clear ALL Data (Admin)
    </button>
  </div>
</div>

<div class="no-print bg-white p-6 rounded shadow-lg mb-6">
  <h2 class="text-xl font-bold mb-4">Dashboard & Bulk Actions</h2>
  <div class="flex space-x-4 items-end">
    <div>
      <label class="block text-sm font-medium text-gray-700">Select Class for Download</label>
      <select id="dashboardClassSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
        <option value="">Select Class</option>
        <option value="Nursery">Nursery</option>
        <option value="LKG">LKG</option>
        <option value="UKG">UKG</option>
        <option value="1">I</option>
        <option value="2">II</option>
        <option value="3">III</option>
        <option value="4">IV</option>
        <option value="5">V</option>
        <option value="6">VI</option>
        <option value="7">VII</option>
        <option value="8">VIII</option>
        <option value="9">IX</option>
      </select>
    </div>
    <button id="bulkDownloadBtn" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
      Download All Reports to Excel
    </button>
    <div id="classTopperDashboard" class="text-lg font-semibold text-gray-600">Class Topper: —</div>
    <div id="schoolTopperDashboard" class="text-lg font-semibold text-gray-600">School Topper: —</div>
  </div>
</div>

<div class="page bg-white report-card-container text-gray-800">

  <div class="watermark">NANDI GURUKUL</div>
  
  <div class="text-center mb-4 header-box">
    <h1 class="text-3xl font-bold text-gray-800">Nandi Gurukul Vidya Mandir</h1>
    <p class="text-sm">AFFILIATION NO: XXXXX | SESSION: 20XX-20XX</p>
    <h2 class="text-2xl font-bold mt-2">REPORT CARD</h2>
  </div>

  <div class="text-sm grid grid-cols-2 gap-x-10 gap-y-1 mb-4">
    <p><strong>Name:</strong> <span id="studentName" class="font-semibold">—</span></p>
    <p><strong>Admission No:</strong> <span id="admissionNo">—</span></p>
    <p><strong>Father's Name:</strong> <span id="fatherName">—</span></p>
    <p><strong>Class/Section:</strong> <span id="classSection" class="font-semibold">—</span></p>
    <p class="print-only" id="printDate"></p>
  </div>
  
  <h3 class="text-lg font-bold mt-4 mb-2">ACADEMIC PERFORMANCE</h3>
  <table class="w-full border-collapse text-sm">
    <thead>
      <tr id="marksTableHead" class="bg-green-100">
        </tr>
    </thead>
    <tbody id="marksTableBody">
      </tbody>
    <tfoot id="marksTableFoot">
      </tfoot>
  </table>

  <div class="grid grid-cols-2 gap-x-10 mt-4">
    <div>
      <h3 class="text-lg font-bold mb-2">CO-SCHOLASTIC ASSESSMENT (Grade A-D)</h3>
      <table class="w-full border-collapse text-sm">
        <tbody id="coscholasticBody">
          <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full screen-only" /></td></tr>
          <tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full screen-only"/></td></tr>
        </tbody>
      </table>
    </div>
    <div>
      <h3 class="text-lg font-bold mb-2">TEACHER'S REMARK</h3>
      <p id="teachersRemark" class="border p-2 min-h-[50px]">Good effort. Keep improving.</p>
    </div>
  </div>

  <div class="print-attendance-box print-only">
    <p><strong>Attendance:</strong> <span id="printAttendancePresent">0</span> / <span id="printAttendanceTotal">130</span></p>
    <p><strong>Result:</strong> <span id="printResult">PASS</span></p>
  </div>
  
  <div class="screen-only mt-4">
      <label for="attendancePresent" class="block text-sm font-medium text-gray-700">Attendance Present:</label>
      <input type="number" id="attendancePresent" class="mt-1 w-20 p-1 border rounded" value="0" />
      <label for="attendanceTotal" class="ml-4 block text-sm font-medium text-gray-700">Total Classes:</label>
      <input type="number" id="attendanceTotal" class="mt-1 w-20 p-1 border rounded" value="130" />
  </div>

  <h3 class="text-lg font-bold mt-4 mb-2">SUBJECT PERFORMANCE ANALYSIS (Print only)</h3>
  <div class="chart-container">
    <canvas id="marksChart"></canvas>
  </div>

  <div class="print-signature-box">
    <p><strong>Class Teacher Sign</strong></p>
    <p><strong>Principal Sign</strong></p>
    <p><strong>Parent Sign</strong></p>
  </div>
</div>

<script>
/* ---------------- CONFIG & SUBJECTS ---------------- */
const SUBJECTS_NUR_TO_UKG = [
{ name: "English", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
{ name: "Hindi", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
{ name: "Maths", utMax: 15, utOralMax: 5, hyMax: 60, hyOralMax: 20 },
// Drawing: special maxima
{ name: "Drawing", utMax: 20, utOralMax: 0, hyMax: 80, hyOralMax: 0 }
];
const SUBJECTS_1_TO_5 = ["Hindi", "English", "Mathematics", "Computer", "E.V.S.", "Drawing", "G.K."];
const SUBJECTS_6_TO_8 = ["Hindi", "English", "Mathematics", "Computer", "Drawing", "G.K.", "Science", "S.S.T."];
const SUBJECTS_9 = ["Hindi", "English", "Mathematics", "Science", "S.S.T.", "Drawing"];
const DEFAULT_ATT_TOTAL = 130;
/* ---------------- STATE ---------------- */
let state = {
selectedClass: '',
selectedStudentKey: '',
studentsByClass: {},
chart: null
};
/* ---------------- UTIL ---------------- */
const qs = id => document.getElementById(id);
/* ---------------- INIT ---------------- */
function init() {
const stored = localStorage.getItem('ng_students');
state.studentsByClass = stored ? JSON.parse(stored) : {};
attachEventListeners();
initChart();
updatePrintDate();
renderMarksTableForClass(''); // initial empty
// initialize printDateInput from storage if present
const storedDate = localStorage.getItem('ng_print_date');
if (storedDate && qs('printDateInput')) {
  qs('printDateInput').value = storedDate;
}
// Load the initial class if one is pre-selected or just set the state
const initialClassSelect = qs('classSelect');
if (initialClassSelect.value) {
  state.selectedClass = interpretClassValue(initialClassSelect.value);
  qs('classSection').textContent = displayClassLabel(state.selectedClass);
  renderMarksTableForClass(state.selectedClass);
}
}
init();
/* ---------------- MAP & HELPERS ---------------- */
function interpretClassValue(val) {
if (!val) return '';
const romanMap = { "I":"1","II":"2","III":"3","IV":"4","V":"5","VI":"6","VII":"7","VIII":"8","IX":"9" };
if (romanMap[val]) return romanMap[val];
return val;
}
function displayClassLabel(cls) {
if (!cls) return '—';
if (cls === 'Nursery' || cls === 'LKG' || cls === 'UKG') return cls;
const map = {1:'I',2:'II',3:'III',4:'IV',5:'V',6:'VI',7:'VII',8:'VIII',9:'IX'};
return map[Number(cls)] || cls;
}
/* ---------------- EVENT LISTENERS ---------------- */
function attachEventListeners() {
qs('classSelect').addEventListener('change', e => {
const val = interpretClassValue(e.target.value);
state.selectedClass = val;
qs('classSection').textContent = displayClassLabel(val);
clearStudentView();
renderMarksTableForClass(val);
});
qs('addStudentBtn').addEventListener('click', () => {
if (!state.selectedClass) return alert('Select Class first.');
const admission = qs('admissionInput').value.trim();
if (!admission) return alert('Enter Admission Number.');
const name = qs('studentNameInput').value.trim();
if (!name) return alert('Enter Student Name.');
// Capture Father Name input
const fatherName = qs('fatherNameInput').value.trim();
const key = `${state.selectedClass}|${admission}`;
state.studentsByClass[state.selectedClass] = state.studentsByClass[state.selectedClass] || {};
// Passed fatherName to makeEmptyStudent
const student = makeEmptyStudent(name, admission, state.selectedClass, fatherName);
if (state.studentsByClass[state.selectedClass][key]) {
// preserve existing marks
const ex = state.studentsByClass[state.selectedClass][key];
// **FIX: Ensure correct preservation of student properties**
student.marks = ex.marks || student.marks;
student.attendance = ex.attendance || student.attendance;
student.coscholastic = ex.coscholastic || student.coscholastic;
student.teachersRemark = ex.teachersRemark || student.teachersRemark;
student.remark = ex.remark || student.remark;
// Ensure fatherName is preserved/updated
student.fatherName = fatherName || ex.fatherName || student.fatherName;
}
state.studentsByClass[state.selectedClass][key] = student;
persistStudents();
state.selectedStudentKey = key;
loadStudent(key);
alert('Student added/updated. You may now enter marks and save.');
});
qs('loadBtn').addEventListener('click', () => {
if (!state.selectedClass) return alert('Select Class first.');
const admission = qs('admissionInput').value.trim();
if (!admission) return alert('Enter Admission Number.');
const key = `${state.selectedClass}|${admission}`;
if (!state.studentsByClass[state.selectedClass] || !state.studentsByClass[state.selectedClass][key]) {
return alert('Student not found. Add student first.');
}
state.selectedStudentKey = key;
loadStudent(key);
});
qs('saveBtn').addEventListener('click', () => {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
saveCurrentStudent();
alert('Saved locally.');
});
qs('printBtn').addEventListener('click', () => {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
// persist print date if set
if (qs('printDateInput') && qs('printDateInput').value) {
  localStorage.setItem('ng_print_date', qs('printDateInput').value);
}
saveCurrentStudent(); // **CRITICAL FIX: Save before printing to ensure latest data is on screen**
calculateTotalsAndUpdate();
// Update print-only attendance and result fields
const student = getCurrentStudent();
if (student) {
    document.getElementById('printAttendancePresent').textContent = student.attendance.present || 0;
    document.getElementById('printAttendanceTotal').textContent = student.attendance.total || DEFAULT_ATT_TOTAL;
    // Simple result logic for print-out
    const percentageText = qs('percentage') ? qs('percentage').textContent : '0%';
    const percentage = parseFloat(percentageText.replace('%', ''));
    document.getElementById('printResult').textContent = percentage >= 40 ? 'PASS' : 'FAIL';
}
window.print();
});
qs('dashboardClassSelect').addEventListener('change', showDashboardTopper);
qs('bulkDownloadBtn').addEventListener('click', bulkDownloadReports);
qs('clearDataBtn').addEventListener('click', clearAllData);
// print date persisting (no dedicated input, so use a dummy for storage)
// This is commented out as the original HTML didn't show a date input field. If you add one with ID 'printDateInput', uncomment this.
/*
if (qs('printDateInput')) {
  qs('printDateInput').addEventListener('change', () => {
    const v = qs('printDateInput').value;
    if (v) localStorage.setItem('ng_print_date', v);
    else localStorage.removeItem('ng_print_date');
    updatePrintDate();
  });
}
*/
}
/* ---------------- PERSISTENCE ---------------- */
function persistStudents() {
localStorage.setItem('ng_students', JSON.stringify(state.studentsByClass));
}
/* ---------------- STUDENT FACTORY ---------------- */
// Added fatherName as an argument
function makeEmptyStudent(name, admission, cls, fatherName='') {
const marks = [];
if (isNurToUkg(cls)) {
SUBJECTS_NUR_TO_UKG.forEach(s => {
marks.push({
name: s.name,
ut: 0,
utOral: s.utOralMax || 0,
hy: 0,
hyOral: s.hyOralMax || 0,
total: 0,
max: { ut: s.utMax, utOral: s.utOralMax, hy: s.hyMax, hyOral: s.hyOralMax }
});
});
} else {
const subs = subjectsForClass(cls);
subs.forEach(s => {
if (s === 'G.K.') {
marks.push({ name: s, grade: 'A', isGrade: true });
} else {
marks.push({ name: s, ut: 0, hy: 0, total: 0, isGrade: false, max: { ut: 20, hy: 80 } });
}
});
}
return {
name, admission, cls, fatherName, // Added fatherName
coscholastic: { workHabits: '', behavior: '' }, // Initialized
attendance: { present: 0, total: DEFAULT_ATT_TOTAL },
teachersRemark: 'Good effort. Keep improving.',
remark: 'Needs Improvement', // Default remark based on 0%
marks: marks // Ensure marks are included
};
}
function isNurToUkg(cls) {
return cls === 'Nursery' || cls === 'LKG' || cls === 'UKG';
}
function subjectsForClass(cls) {
const n = Number(cls);
if (n >=1 && n <=5) return SUBJECTS_1_TO_5.slice();
if (n >=6 && n <=8) return SUBJECTS_6_TO_8.slice();
if (n === 9) return SUBJECTS_9.slice();
return [];
}
/* ---------------- RENDER MARKS TABLE PER CLASS ---------------- */
function renderMarksTableForClass(cls) {
const thead = qs('marksTableHead');
const tbody = qs('marksTableBody');
const tfoot = qs('marksTableFoot');
tbody.innerHTML = '';
tfoot.innerHTML = '';
if (!cls) {
thead.innerHTML = `<tr class="bg-green-100"><th class="border px-3 py-2 text-left">Subject</th><th class="border px-3 py-2 text-center">Unit Test</th><th class="border px-3 py-2 text-center">Half Yearly</th><th class="border px-3 py-2 text-center font-semibold">Overall Performance</th></tr>`;
return;
}
// Get student data if available to pre-fill inputs
const student = getCurrentStudent();

if (isNurToUkg(cls)) {
thead.innerHTML = `
<tr class="bg-green-100">
<th class="border px-3 py-2 text-left">Subject</th>
<th class="border px-3 py-2 text-center">Unit Test Written</th>
<th class="border px-3 py-2 text-center">Unit Test Oral</th>
<th class="border px-3 py-2 text-center">Half Yearly Written</th>
<th class="border px-3 py-2 text-center">Half Yearly Oral</th>
<th class="border px-3 py-2 text-center font-semibold">Overall Performance</th>
</tr>
`;
const rows = student ? student.marks : SUBJECTS_NUR_TO_UKG.map(s => ({ name: s.name, total: 0 }));
rows.forEach((m, idx) => {
const max = (m.max || SUBJECTS_NUR_TO_UKG.find(s => s.name === m.name));
// For drawing: utOral/hyOral disabled
const utMax = max.utMax || max.ut || 0;
const utOralMax = max.utOralMax || max.utOral || 0;
const hyMax = max.hyMax || max.hy || 0;
const hyOralMax = max.hyOralMax || max.hyOral || 0;
const utVal = (student && student.marks[idx]) ? (student.marks[idx].ut || 0) : 0;
const utOralVal = (student && student.marks[idx]) ? (student.marks[idx].utOral || 0) : 0;
const hyVal = (student && student.marks[idx]) ? (student.marks[idx].hy || 0) : 0;
const hyOralVal = (student && student.marks[idx]) ? (student.marks[idx].hyOral || 0) : 0;
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${m.name}</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="ut" type="number" min="0" max="${utMax}" value="${utVal}" class="w-16 p-1 border rounded screen-only" />
<span class="print-only">${utVal} / ${utMax}</span>
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="utOral" type="number" min="0" max="${utOralMax}" value="${utOralVal}" class="w-16 p-1 border rounded screen-only" ${utOralMax===0?'disabled':''} />
<span class="print-only">${utOralVal} / ${utOralMax}</span>
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="hy" type="number" min="0" max="${hyMax}" value="${hyVal}" class="w-16 p-1 border rounded screen-only" />
<span class="print-only">${hyVal} / ${hyMax}</span>
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="hyOral" type="number" min="0" max="${hyOralMax}" value="${hyOralVal}" class="w-16 p-1 border rounded screen-only" ${hyOralMax===0?'disabled':''} />
<span class="print-only">${hyOralVal} / ${hyOralMax}</span>
</td>
<td class="border px-3 py-2 font-semibold text-center">${student ? (student.marks[idx].total || 0) : 0}</td>
</tr>
`);
});
tfoot.innerHTML = `
<tr class="bg-gray-50">
<td class="border px-3 py-2 font-semibold text-right">Total</td>
<td id="totalUT" class="border px-3 py-2 font-semibold text-center" colspan="1">0</td>
<td id="totalUTOral" class="border px-3 py-2 font-semibold text-center" colspan="1">0</td>
<td id="totalHY" class="border px-3 py-2 font-semibold text-center" colspan="1">0</td>
<td id="totalHYOral" class="border px-3 py-2 font-semibold text-center" colspan="1">0</td>
<td id="totalOverall" class="border px-3 py-2 font-semibold text-center">0</td>
</tr>
<tr class="bg-gray-50">
<td colspan="5" class="border px-3 py-2 font-semibold text-right">Percentage</td>
<td id="percentage" class="border px-3 py-2 font-semibold text-center">0%</td>
</tr>
`;
} else {
// Classes 1-9: no oral columns, UT=20 HY=80; G.K. grade
thead.innerHTML = `
<tr class="bg-green-100">
<th class="border px-3 py-2 text-left">Subject</th>
<th class="border px-3 py-2 text-center">Unit Test - 20</th>
<th class="border px-3 py-2 text-center">Half Yearly - 80</th>
<th class="border px-3 py-2 text-center font-semibold">Overall Performance</th>
</tr>
`;
const subs = subjectsForClass(cls);
subs.forEach((s, idx) => {
const mark = student ? student.marks[idx] : null;
if (s === 'G.K.') {
const grade = mark ? (mark.grade || 'A') : 'A';
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${s}</td>
<td class="border px-3 py-2 text-center">—</td>
<td class="border px-3 py-2 text-center">—</td>
<td class="border px-3 py-2 text-center">
<select data-idx="${idx}" data-field="grade" class="grade-select screen-only">
<option value="A"${grade==='A'?' selected':''}>A</option>
<option value="B"${grade==='B'?' selected':''}>B</option>
<option value="C"${grade==='C'?' selected':''}>C</option>
<option value="D"${grade==='D'?' selected':''}>D</option>
</select>
<span class="print-only">${grade}</span>
</td>
</tr>
`);
} else {
const utVal = mark ? (mark.ut || 0) : 0;
const hyVal = mark ? (mark.hy || 0) : 0;
const overall = mark ? (mark.total || 0) : 0;
tbody.insertAdjacentHTML('beforeend', `
<tr>
<td class="border px-3 py-2">${s}</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="ut" type="number" min="0" max="20" value="${utVal}" class="w-16 p-1 border rounded screen-only" />
<span class="print-only">${utVal} / 20</span>
</td>
<td class="border px-3 py-2 text-center">
<input data-idx="${idx}" data-field="hy" type="number" min="0" max="80" value="${hyVal}" class="w-16 p-1 border rounded screen-only" />
<span class="print-only">${hyVal} / 80</span>
</td>
<td class="border px-3 py-2 font-semibold text-center">${overall}</td>
</tr>
`);
}
});
tfoot.innerHTML = `
<tr class="bg-gray-50">
<td class="border px-3 py-2 font-semibold text-right">Total</td>
<td id="totalUT" class="border px-3 py-2 font-semibold text-center" colspan="1">0</td>
<td id="totalHY" class="border px-3 py-2 font-semibold text-center" colspan="1">0</td>
<td id="totalOverall" class="border px-3 py-2 font-semibold text-center">0</td>
</tr>
<tr class="bg-gray-50">
<td colspan="3" class="border px-3 py-2 font-semibold text-right">Percentage</td>
<td id="percentage" class="border px-3 py-2 font-semibold text-center">0%</td>
</tr>
`;
}
attachMarksInputsListeners();
calculateTotalsAndUpdate(); // **CRITICAL FIX: Ensure totals are updated after rendering with student data**
}
/* ---------------- ATTACH INPUT LISTENERS & VALIDATION ---------------- */
function attachMarksInputsListeners() {
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
el.addEventListener('input', e => {
autoClampInput(el);
calculateTotalsAndUpdate();
});
// also clamp on blur to be safe
el.addEventListener('blur', () => { autoClampInput(el); calculateTotalsAndUpdate(); });
});
// **FIX: Attach listener to coscholastic inputs for saving**
qs('coscholasticBody').querySelectorAll('input').forEach(el => {
  el.addEventListener('input', saveCurrentStudent);
});
}
function autoClampInput(el) {
if (!el) return;
if (el.tagName.toLowerCase() === 'select') return;
const max = Number(el.max);
const min = Number(el.min) || 0;
let val = Number(el.value);
if (isNaN(val)) {
el.value = '';
return;
}
if (!isNaN(max) && max >= 0 && val > max) {
el.value = max;
val = max;
}
if (!isNaN(min) && val < min) {
el.value = min;
}
}
/* ---------------- LOAD / SAVE STUDENT ---------------- */
// **FIX: Refactor loadStudent to set the correct class select value**
function loadStudent(key) {
const [cls, admission] = key.split('|');
const student = state.studentsByClass[cls] && state.studentsByClass[cls][key];
if (!student) return alert('Student data not found.');
state.selectedStudentKey = key;
state.selectedClass = cls;
// set class select to roman or textual
const romanMap = { "1":"I","2":"II","3":"III","4":"IV","5":"V","6":"VI","7":"VII","8":"VIII","9":"IX" };
const classSelectValue = cls === 'Nursery' || cls === 'LKG' || cls === 'UKG' ? cls : romanMap[cls] || cls;
qs('classSelect').value = classSelectValue;

// Update header display
qs('studentName').textContent = student.name;
qs('admissionNo').textContent = student.admission || '—';
qs('classSection').textContent = displayClassLabel(student.cls);
qs('fatherName').textContent = student.fatherName || '—';
// Update input fields
qs('studentNameInput').value = student.name;
qs('admissionInput').value = student.admission || '';
if (qs('fatherNameInput')) {
qs('fatherNameInput').value = student.fatherName || '';
}
// Load attendance from the screen-only input fields, which are present in both HTML blocks
document.querySelectorAll('#attendancePresent').forEach(el => el.value = student.attendance.present || 0);
document.querySelectorAll('#attendanceTotal').forEach(el => el.value = student.attendance.total || DEFAULT_ATT_TOTAL);
renderMarksTableForClass(student.cls); // Re-render table with student's data

// coscholastic
student.coscholastic = student.coscholastic || {};
qs('coscholasticBody').innerHTML = `
<tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" value="${student.coscholastic.workHabits || ''}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full screen-only" />
<span class="print-only">${student.coscholastic.workHabits || ''}</span></td></tr>
<tr><td>Behavior</td><td><input type="text" id="behaviorInput" value="${student.coscholastic.behavior || ''}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full screen-only"/>
<span class="print-only">${student.coscholastic.behavior || ''}</span></td></tr>
`;
// **FIX: Attach listeners to newly created coscholastic inputs**
qs('coscholasticBody').querySelectorAll('input').forEach(el => {
  el.addEventListener('input', saveCurrentStudent);
});
// Load remark
if (qs('teachersRemark')) {
    qs('teachersRemark').textContent = student.teachersRemark || student.remark || 'Good effort. Keep improving.';
}

attachMarksInputsListeners();
calculateTotalsAndUpdate();
}

function saveCurrentStudent() {
if (!state.selectedStudentKey) return;
const student = getCurrentStudent();
if (!student) return;
// Save from the *first* visible instance of attendance input
const attPresentEls = document.querySelectorAll('#attendancePresent');
const attTotalEls = document.querySelectorAll('#attendanceTotal');
// prefer first visible (not readonly?) Use first in DOM
student.attendance.present = Number(attPresentEls[0].value) || 0;
student.attendance.total = Number(attTotalEls[0].value) || DEFAULT_ATT_TOTAL;
// Save Father Name from input control
student.fatherName = qs('fatherNameInput') ? qs('fatherNameInput').value.trim() : '';
// coscholastic
student.coscholastic = {
workHabits: qs('workHabitsInput') ? qs('workHabitsInput').value.trim() : '',
behavior: qs('behaviorInput') ? qs('behaviorInput').value.trim() : ''
};
// collect marks from inputs
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
const idx = Number(el.getAttribute('data-idx'));
const field = el.getAttribute('data-field');
if (!Number.isFinite(idx)) return;
student.marks[idx] = student.marks[idx] || {};
if (el.tagName.toLowerCase() === 'select') {
student.marks[idx].grade = el.value;
student.marks[idx].isGrade = true;
} else {
student.marks[idx][field] = Number(el.value) || 0;
}
});
calculateTotalsAndUpdate();
persistStudents();
}
/* ---------------- GET STUDENT ---------------- */
function getCurrentStudent() {
if (!state.selectedStudentKey) return null;
const [cls] = state.selectedStudentKey.split('|');
return state.studentsByClass[cls] && state.studentsByClass[cls][state.selectedStudentKey];
}
/* ---------------- CALCULATIONS & REMARKS ---------------- */
function calculateTotalsAndUpdate() {
const student = getCurrentStudent();
// if student exists update from inputs first
if (student) {
// Collect and update marks from inputs into student object
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
const idx = Number(el.getAttribute('data-idx'));
const field = el.getAttribute('data-field');
if (!Number.isFinite(idx)) return;
student.marks[idx] = student.marks[idx] || {};
if (el.tagName.toLowerCase() === 'select') {
student.marks[idx].grade = el.value;
student.marks[idx].isGrade = true;
} else {
student.marks[idx][field] = Number(el.value) || 0;
}
});
}
// perform totals depending on class
let percentage = 0;
let totals = { ut:0, utOral:0, hy:0, hyOral:0, overall:0, numericCount:0 };

if (student && isNurToUkg(student.cls)) {
let maxOverall = 0;
student.marks.forEach(m => {
const ut = Number(m.ut) || 0;
const utOral = Number(m.utOral) || 0;
const hy = Number(m.hy) || 0;
const hyOral = Number(m.hyOral) || 0;
const subjTotal = ut + utOral + hy + hyOral;
m.total = subjTotal;
totals.ut += ut; totals.utOral += utOral; totals.hy += hy; totals.hyOral += hyOral; totals.overall += subjTotal;
const max = m.max || SUBJECTS_NUR_TO_UKG.find(s => s.name === m.name);
maxOverall += (max.utMax || max.ut || 0) + (max.utOralMax || max.utOral || 0) + (max.hyMax || max.hy || 0) + (max.hyOralMax || max.hyOral || 0);
});
if (qs('totalUT')) qs('totalUT').textContent = totals.ut;
if (qs('totalUTOral')) qs('totalUTOral').textContent = totals.utOral;
if (qs('totalHY')) qs('totalHY').textContent = totals.hy;
if (qs('totalHYOral')) qs('totalHYOral').textContent = totals.hyOral;
if (qs('totalOverall')) qs('totalOverall').textContent = totals.overall;
percentage = maxOverall > 0 ? ((totals.overall / maxOverall) * 100).toFixed(2) : '0.00';
if (qs('percentage')) qs('percentage').textContent = percentage + '%';

} else if (student) {
// classes 1-9
let denom = 0;
student.marks.forEach(m => {
if (m.isGrade) {
// skip
} else {
const ut = Number(m.ut) || 0;
const hy = Number(m.hy) || 0;
const t = ut + hy;
m.total = t;
totals.ut += ut; totals.hy += hy; totals.overall += t; totals.numericCount++;
denom += 100; // Each numeric subject is out of 100
}
});
if (qs('totalUT')) qs('totalUT').textContent = totals.ut;
if (qs('totalHY')) qs('totalHY').textContent = totals.hy;
if (qs('totalOverall')) qs('totalOverall').textContent = totals.overall;
percentage = denom > 0 ? ((totals.overall/denom)*100).toFixed(2):'0.00';
if (qs('percentage')) qs('percentage').textContent = percentage + '%';
} else {
// no student: compute totals from visible inputs
computeTotalsFromInputs();
}
// Remark
if (student) {
let remarkText = 'Needs Improvement';
const p = Number(percentage);
if (p >= 90) remarkText = 'Outstanding';
else if (p >= 80) remarkText = 'Excellent';
else if (p >= 70) remarkText = 'Very Good';
else if (p >= 60) remarkText = 'Good';
else if (p >= 50) remarkText = 'Average';
student.remark = remarkText;
// Preserve teacher's manual remark if it exists, otherwise use the generated one
if (!student.teachersRemark || student.teachersRemark === student.remark) {
    student.teachersRemark = remarkText;
}

if (qs('teachersRemark')) qs('teachersRemark').textContent = student.teachersRemark;
}
// reflect row overall values
if (student) {
qs('marksTableBody').querySelectorAll('tr').forEach((tr, idx) => {
const m = student.marks[idx];
if (!m) return;
const overallCell = tr.children[tr.children.length - 1];
overallCell.textContent = m.isGrade ? (m.grade || '—') : (m.total || 0);
});
}
// update chart
if (student) updateChart(student);
persistStudents();
}
/* compute totals when no student loaded (from visible inputs) */
function computeTotalsFromInputs() {
let totalUT = 0, totalHY = 0, totalUTOral = 0, totalHYOral = 0;
let totalOverall = 0;
// Only target inputs within marks table body
qs('marksTableBody').querySelectorAll('input').forEach(el => {
const field = el.getAttribute('data-field');
const val = Number(el.value) || 0;
if (field === 'ut') totalUT += val;
if (field === 'utOral') totalUTOral += val;
if (field === 'hy') totalHY += val;
if (field === 'hyOral') totalHYOral += val;
// Only sum to overall if it's not a print-only or unrelated field
if (field !== 'grade') totalOverall += val;
});
if (qs('totalUT')) qs('totalUT').textContent = totalUT;
if (qs('totalUTOral')) qs('totalUTOral').textContent = totalUTOral;
if (qs('totalHY')) qs('totalHY').textContent = totalHY;
if (qs('totalHYOral')) qs('totalHYOral').textContent = totalHYOral;
if (qs('totalOverall')) qs('totalOverall').textContent = totalOverall;
}
/* ----------------- CHART ----------------- */
function initChart() {
const ctx = qs('marksChart').getContext('2d');
// Ensure the chart is destroyed if it already exists to prevent duplicates
if (state.chart) {
    state.chart.destroy();
}
state.chart = new Chart(ctx, {
type: 'bar',
data: { labels: [], datasets: [] },
// **FIX: Max Y-axis to 100 for percentage view if necessary, or maximum possible total per subject**
options: { 
  responsive: true, 
  maintainAspectRatio: false, // Allows flexible height/width
  plugins:{ 
    legend: { display: true },
    title: { display: true, text: 'Subject-wise Performance Analysis' } // Added title
  }, 
  scales:{ 
    y: { 
      beginAtZero:true, 
      max:100, // Max for a single 100-mark subject (or max for a combined subject in Nur/UKG)
      title: { display: true, text: 'Marks (Out of 100)' }
    } 
  } ,
  // Fix for print visibility: hide elements that are too wide on small canvas
  animation: false,
}
});
}
function updateChart(student) {
if (!state.chart) initChart(); // Re-initialize if somehow lost
const maxSubjectMark = isNurToUkg(student.cls) ? 100 : 100; // Max mark per subject is 100 (UT+HY)
state.chart.options.scales.y.max = maxSubjectMark; // Set max Y axis dynamically

const labels = student.marks.filter(m => !m.isGrade).map(m => m.name);
const obtained = student.marks.filter(m => !m.isGrade).map(m => m.total || 0);
// **FIX: Ensure class average/highest calculations also skip graded subjects**
const classAvg = labels.map(l => getClassAverage(student.cls, l));
const classHigh = labels.map(l => getClassHighest(student.cls, l));

/* Pattern array for B/W visibility using patternomaly */
const patterns = [
  pattern.draw('diagonal', '#000'),
  pattern.draw('square', '#000'),
  pattern.draw('circle', '#000'),
  pattern.draw('zigzag', '#000'),
  pattern.draw('plus', '#000'),
  pattern.draw('triangle', '#000')
];

// **FIX: Use distinct colors for screen/non-print if patterns are not supported/too much**
const colors = ['#3B82F6', '#10B981', '#F59E0B']; // Blue, Green, Yellow-Orange

state.chart.data.labels = labels;
state.chart.data.datasets = [
{ label: 'Obtained', data: obtained, backgroundColor: colors[0], borderColor: '#000', borderWidth:1 },
{ label: 'Class Average', data: classAvg, backgroundColor: colors[1], borderColor: '#000', borderWidth:1 },
{ label: 'Class Highest', data: classHigh, backgroundColor: colors[2], borderColor: '#000', borderWidth:1 }
];
// Apply patterns only on print to ensure B/W visibility
/* Note: The print style sheet handles pattern application (see CSS).
If patternomaly doesn't appear on print, it's a browser/library issue, but the code logic is here.
if (window.matchMedia && window.matchMedia('print').matches) {
    state.chart.data.datasets[0].backgroundColor = patterns[0 % patterns.length];
    state.chart.data.datasets[1].backgroundColor = patterns[1 % patterns.length];
    state.chart.data.datasets[2].backgroundColor = patterns[2 % patterns.length];
}
*/
state.chart.update();
}
function getClassAverage(cls, subjectName) {
if (!state.studentsByClass[cls]) return 0;
const vals = Object.values(state.studentsByClass[cls]).map(s => {
const sub = s.marks.find(m => m.name === subjectName);
// **FIX: Only consider numeric subjects**
return (sub && !sub.isGrade) ? (sub.total || 0) : 0;
}).filter(v => typeof v === 'number');
if (!vals.length) return 0;
return Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
}
function getClassHighest(cls, subjectName) {
if (!state.studentsByClass[cls]) return 0;
const vals = Object.values(state.studentsByClass[cls]).map(s => {
const sub = s.marks.find(m => m.name === subjectName);
// **FIX: Only consider numeric subjects**
return (sub && !sub.isGrade) ? (sub.total || 0) : 0;
}).filter(v => typeof v === 'number');
if (!vals.length) return 0;
return Math.max(...vals);
}
/* ---------------- DASHBOARD TOPPER ---------------- */
function showDashboardTopper() {
const clsInput = qs('dashboardClassSelect').value;
const cls = interpretClassValue(clsInput);
if (!cls) { qs('classTopperDashboard').textContent='Class Topper: —'; qs('schoolTopperDashboard').textContent='School Topper: —'; return; }
let classTopper = { name:'—', total: -1 };
let schoolTopper = { name:'—', total: -1 };

// Calculate Class Topper
Object.keys(state.studentsByClass[cls]||{}).forEach(k => {
const s = state.studentsByClass[cls][k];
// **FIX: Only sum total for numeric subjects, as grades cannot be summed**
const tot = s.marks.filter(m => !m.isGrade).reduce((a,b)=>a+(b.total||0),0);
if (tot > classTopper.total) classTopper={name:s.name,total:tot};
});

// Calculate School Topper
Object.values(state.studentsByClass).forEach(clsObj => {
Object.values(clsObj).forEach(s => {
// **FIX: Only sum total for numeric subjects**
const tot = s.marks.filter(m => !m.isGrade).reduce((a,b)=>a+(b.total||0),0);
if (tot > schoolTopper.total) schoolTopper={name:s.name,total:tot, cls: s.cls};
});
});

qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} — ${classTopper.total > 0 ? classTopper.total : '0'}`;
qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} (${displayClassLabel(schoolTopper.cls)}) — ${schoolTopper.total > 0 ? schoolTopper.total : '0'}`;
}
/* ---------------- BULK DOWNLOAD (Excel) ---------------- */
function bulkDownloadReports() {
const clsInput = qs('dashboardClassSelect').value || state.selectedClass;
if (!clsInput) return alert('Select a class for bulk download.');
const cls = interpretClassValue(clsInput);
if (!state.studentsByClass[cls] || !Object.keys(state.studentsByClass[cls]).length) return alert('No students found in this class.');

// Build rows (one row per student-subject)
const students = Object.keys(state.studentsByClass[cls]).map(k => state.studentsByClass[cls][k]);

let subjects = [];
if (isNurToUkg(cls)) {
subjects = SUBJECTS_NUR_TO_UKG.map(s => s.name);
} else {
subjects = subjectsForClass(cls);
}

const rows = students.map(s => {
  const base = {
    'Student Name': s.name || '',
    "Father's Name": s.fatherName || '',
    'Admission No': s.admission || '',
    'Class': displayClassLabel(s.cls || cls),
  };

  if (isNurToUkg(cls)) {
    subjects.forEach(sub => {
      const mark = s.marks.find(m => m.name === sub) || {};
      const max = mark.max || SUBJECTS_NUR_TO_UKG.find(ss=>ss.name===sub);
      
      base[`${sub} - UT Written (${max?.utMax ?? 0})`] = mark.ut ?? 0;
      base[`${sub} - UT Oral (${max?.utOralMax ?? 0})`] = mark.utOral ?? 0;
      base[`${sub} - HY Written (${max?.hyMax ?? 0})`] = mark.hy ?? 0;
      base[`${sub} - HY Oral (${max?.hyOralMax ?? 0})`] = mark.hyOral ?? 0;
      base[`${sub} - Overall (100)`] = mark.total ?? 0;
    });
  } else {
    subjects.forEach(sub => {
      const mark = s.marks.find(m => m.name === sub) || {};
      if (mark.isGrade) {
        base[`${sub} - Grade`] = mark.grade || '';
      } else {
        base[`${sub} - UT(20)`] = mark.ut ?? 0;
        base[`${sub} - HY(80)`] = mark.hy ?? 0;
        base[`${sub} - Overall(100)`] = mark.total ?? 0;
      }
    });
  }

  const numericMarks = (s.marks || []).filter(m => !m.isGrade);
  const totalUT = numericMarks.reduce((a,b) => a + (Number(b.ut) || 0), 0);
  const totalHY = numericMarks.reduce((a,b) => a + (Number(b.hy) || 0), 0);
  const overall = numericMarks.reduce((a,b) => a + (Number(b.total) || 0), 0);
  const numericCount = numericMarks.length || 1;
  let denom = 0;
  if (isNurToUkg(cls)) {
      denom = numericMarks.reduce((a, b) => a + (b.max.utMax || b.max.ut || 0) + (b.max.utOralMax || b.max.utOral || 0) + (b.max.hyMax || b.max.hy || 0) + (b.max.hyOralMax || b.max.hyOral || 0), 0) || 1;
  } else {
      denom = (numericCount * 100);
  }
  
  const percentage = denom > 0 ? ((overall / denom) * 100).toFixed(2) : '0.00';

  base['Total UT'] = totalUT;
  base['Total HY'] = totalHY;
  base['Total Overall'] = overall;
  base['Percentage'] = percentage + '%';
  base['Attendance'] = `${s.attendance.present || 0} / ${s.attendance.total || DEFAULT_ATT_TOTAL}`;
  base['Teacher Remark'] = s.teachersRemark || s.remark || '';
  return base;
});

const wb = XLSX.utils.book_new();
const ws = XLSX.utils.json_to_sheet(rows, { skipHeader: false });

// Apply better color formatting (REQUIRES XLSX library to be loaded, which it is now)
const range = XLSX.utils.decode_range(ws['!ref']);
const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "4F81BD" } }, alignment: { horizontal: "center", wrapText: true } }; // Blue header
const oddRowStyle = { fill: { fgColor: { rgb: "D9E1F2" } } }; // Light blue/gray for odd rows
const evenRowStyle = { fill: { fgColor: { rgb: "FFFFFF" } } }; // White for even rows

// Set column widths for better readability
const colWidths = [
    { wch: 20 }, // Student Name
    { wch: 20 }, // Father's Name
    { wch: 15 }, // Admission No
    { wch: 10 }, // Class
];

// Determine column widths for dynamic subject columns
const firstRowKeys = rows.length > 0 ? Object.keys(rows[0]) : [];
firstRowKeys.slice(4).forEach(key => { // Start after the 4 fixed columns
    if (key.includes('Overall')) {
        colWidths.push({ wch: 15 });
    } else if (key.includes('Total') || key.includes('Percentage') || key.includes('Remark') || key.includes('Attendance')) {
        colWidths.push({ wch: 15 });
    } else {
        colWidths.push({ wch: 12 });
    }
});

ws['!cols'] = colWidths;

for (let R = range.s.r; R <= range.e.r; ++R) {
  for (let C = range.s.c; C <= range.e.c; ++C) {
    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
    const cell = ws[cellAddress] || {};

    if (R === 0) {
      // Header row formatting
      cell.s = headerStyle;
    } else {
      // Data row formatting
      const rowStyle = (R % 2 === 0) ? evenRowStyle : oddRowStyle;
      cell.s = { ...rowStyle };
      
      // Apply number format to marks columns (assuming columns > 3 are marks/totals)
      if (C >= 4 && !firstRowKeys[C]?.includes('Grade') && !firstRowKeys[C]?.includes('Attendance')) {
        cell.s.numFmt = '0';
      }
      
      // Highlight Total/Percentage columns
      if (firstRowKeys[C]?.includes('Total') || firstRowKeys[C]?.includes('Overall(100)')) {
          cell.s.font = { bold: true };
          if (firstRowKeys[C]?.includes('Percentage')) {
              cell.s.fill = { fgColor: { rgb: "C6EFCE" } }; // Light Green for Percentage
          } else if (firstRowKeys[C]?.includes('Overall(100)')) {
              cell.s.fill = { fgColor: { rgb: "FFF2CC" } }; // Light Yellow for Overall Subject Total
          } else if (firstRowKeys[C]?.includes('Total')) {
              cell.s.fill = { fgColor: { rgb: "DEEBF7" } }; // Light Blue for Grand Totals
          }
      }
    }
    ws[cellAddress] = cell;
  }
}

XLSX.utils.book_append_sheet(wb, ws, `Class_${displayClassLabel(cls)}`);

const filename = `ReportCards_${displayClassLabel(cls)}_${new Date().toISOString().split('T')[0]}.xlsx`;
XLSX.writeFile(wb, filename);
}
/* ---------------- CLEAR DATA ---------------- */
function clearAllData() {
const password = prompt('Enter password to clear ALL data:');
if (password !== '1234') return alert('Incorrect password!');
if (!confirm('Are you sure? This will remove all saved data!')) return;
localStorage.clear();
state.studentsByClass = {};
state.selectedStudentKey = '';
state.selectedClass = '';
clearStudentView();
// Clear dashboard
qs('dashboardClassSelect').value = '';
showDashboardTopper();
alert('All data cleared successfully.');
}
/* ----------------- HELPERS: LOAD / CLEAR VIEW ----------------- */
function clearStudentView() {
state.selectedStudentKey = '';
qs('studentName').textContent = '—';
qs('admissionNo').textContent = '—';
// Clear father name display
if (qs('fatherName')) qs('fatherName').textContent = '—';
qs('studentNameInput').value = '';
qs('admissionInput').value = '';
// Clear father name input
if (qs('fatherNameInput')) qs('fatherNameInput').value = '';
qs('classSection').textContent = state.selectedClass ? displayClassLabel(state.selectedClass) : '—';
// Clear *both* sets of attendance inputs
document.querySelectorAll('#attendancePresent').forEach(el => el.value = '');
document.querySelectorAll('#attendanceTotal').forEach(el => el.value = DEFAULT_ATT_TOTAL);

qs('coscholasticBody').innerHTML = `
<tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full screen-only" /></td></tr>
<tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full screen-only"/></td></tr>
`;
// **FIX: Re-attach listeners after clearing/re-creating coscholastic inputs**
qs('coscholasticBody').querySelectorAll('input').forEach(el => {
  el.addEventListener('input', saveCurrentStudent);
});

if (qs('teachersRemark')) qs('teachersRemark').textContent = 'Good effort. Keep improving.';
renderMarksTableForClass(state.selectedClass);
if(state.chart) {
    state.chart.data.labels = [];
    state.chart.data.datasets = [];
    state.chart.update();
}
}
/* ----------------- UPDATE PRINT DATE ----------------- */
function updatePrintDate() {
const stored = localStorage.getItem('ng_print_date');
let printDate;
if (stored) {
  const d = new Date(stored + 'T00:00:00');
  printDate = d.toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' }); // Better date format
} else {
  printDate = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
}
if(qs('printDate')) qs('printDate').textContent = 'Date: ' + printDate;
}
</script>
</body>
</html>
